---
title: "Probar la lógica del controlador en ASP.NET Core"
author: ardalis
description: "Obtenga información acerca de cómo probar la lógica del controlador de ASP.NET Core con Moq y xUnit."
keywords: "ASP.NET Core, controlador, prueba, realizar pruebas, pruebas unitarias, pruebas unitarias, pruebas de integración, pruebas de integración, xUnit"
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.assetid: dd4135ec-2b15-410c-b3fb-3d12eed4a1ac
ms.technology: aspnet
ms.prod: asp.net-core
uid: mvc/controllers/testing
ms.openlocfilehash: d5b2bd0200082000aeaf8015cfff9c8c1ec1bdd9
ms.sourcegitcommit: 5355c96a1768e5a1d5698a98c190e7addcc4ded5
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/05/2017
---
# <a name="testing-controller-logic-in-aspnet-core"></a><span data-ttu-id="52252-104">Probar la lógica del controlador en ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="52252-104">Testing controller logic in ASP.NET Core</span></span>

<span data-ttu-id="52252-105">Por [Steve Smith](http://ardalis.com)</span><span class="sxs-lookup"><span data-stu-id="52252-105">By [Steve Smith](http://ardalis.com)</span></span>

<span data-ttu-id="52252-106">Controladores en las aplicaciones de ASP.NET MVC deben ser pequeño y se centra en los problemas de la interfaz de usuario.</span><span class="sxs-lookup"><span data-stu-id="52252-106">Controllers in ASP.NET MVC apps should be small and focused on user-interface concerns.</span></span> <span data-ttu-id="52252-107">Controladores de grandes que tratan con problemas de interfaz de usuario no son más difíciles de probar y mantener.</span><span class="sxs-lookup"><span data-stu-id="52252-107">Large controllers that deal with non-UI concerns are more difficult to test and maintain.</span></span>

[<span data-ttu-id="52252-108">Ver o descargar el ejemplo desde GitHub</span><span class="sxs-lookup"><span data-stu-id="52252-108">View or download sample from GitHub</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample)

## <a name="testing-controllers"></a><span data-ttu-id="52252-109">Controladores de pruebas</span><span class="sxs-lookup"><span data-stu-id="52252-109">Testing controllers</span></span>

<span data-ttu-id="52252-110">Los controladores son una parte fundamental de cualquier aplicación de MVC de ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="52252-110">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="52252-111">Por lo tanto, debe tener confianza que se comportan según lo previsto para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="52252-111">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="52252-112">Las pruebas automatizadas pueden proporcionarle esta confianza y pueden detectar errores antes de que lleguen a producción.</span><span class="sxs-lookup"><span data-stu-id="52252-112">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="52252-113">Es importante evitar colocar innecesarias responsabilidades dentro de los controladores y asegurarse de su enfoque de pruebas solo en las responsabilidades de controlador.</span><span class="sxs-lookup"><span data-stu-id="52252-113">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="52252-114">Lógica de controlador debería ser mínimo y no se centra en cuestiones empresariales (por ejemplo, acceso a datos) de infraestructura o lógica.</span><span class="sxs-lookup"><span data-stu-id="52252-114">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="52252-115">Probar la lógica del controlador, no el marco de trabajo.</span><span class="sxs-lookup"><span data-stu-id="52252-115">Test controller logic, not the framework.</span></span> <span data-ttu-id="52252-116">Prueba cómo el controlador *se comporta* en función de las entradas válidas o no es válidas.</span><span class="sxs-lookup"><span data-stu-id="52252-116">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="52252-117">Pruebe las respuestas de controlador en función del resultado de la operación de negocio que lleva a cabo.</span><span class="sxs-lookup"><span data-stu-id="52252-117">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="52252-118">Responsabilidades del controlador típico:</span><span class="sxs-lookup"><span data-stu-id="52252-118">Typical controller responsibilities:</span></span>

* <span data-ttu-id="52252-119">Comprobar `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="52252-119">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="52252-120">Devolver una respuesta de error si `ModelState` no es válido.</span><span class="sxs-lookup"><span data-stu-id="52252-120">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="52252-121">Recuperar una entidad de negocio de la persistencia.</span><span class="sxs-lookup"><span data-stu-id="52252-121">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="52252-122">Realizar una acción en la entidad comercial.</span><span class="sxs-lookup"><span data-stu-id="52252-122">Perform an action on the business entity.</span></span>
* <span data-ttu-id="52252-123">Guarde la entidad comercial con la persistencia.</span><span class="sxs-lookup"><span data-stu-id="52252-123">Save the business entity to persistence.</span></span>
* <span data-ttu-id="52252-124">Devolver un apropiado `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="52252-124">Return an appropriate `IActionResult`.</span></span>

## <a name="unit-testing"></a><span data-ttu-id="52252-125">Pruebas unitarias</span><span class="sxs-lookup"><span data-stu-id="52252-125">Unit testing</span></span>

<span data-ttu-id="52252-126">[Pruebas unitarias](https://docs.microsoft.com/dotnet/articles/core/testing/unit-testing-with-dotnet-test) implica probar una parte de una aplicación de forma aislada de su infraestructura y las dependencias.</span><span class="sxs-lookup"><span data-stu-id="52252-126">[Unit testing](https://docs.microsoft.com/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involves testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="52252-127">Cuando se prueban lógica, solo el contenido de una sola acción del controlador de pruebas unitarias, no el comportamiento de sus dependencias o el marco de trabajo.</span><span class="sxs-lookup"><span data-stu-id="52252-127">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="52252-128">Como unidad probar las acciones de controlador, asegúrese de que solo se centran en su comportamiento.</span><span class="sxs-lookup"><span data-stu-id="52252-128">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="52252-129">Una prueba unitaria de controlador evita cosas como [filtros](filters.md), [enrutamiento](../../fundamentals/routing.md), o [enlace de modelo](../models/model-binding.md).</span><span class="sxs-lookup"><span data-stu-id="52252-129">A controller unit test avoids things like [filters](filters.md), [routing](../../fundamentals/routing.md), or [model binding](../models/model-binding.md).</span></span> <span data-ttu-id="52252-130">Centrándose en probar simplemente algo, pruebas unitarias suelen ser fáciles de escribir y rápida ejecutar.</span><span class="sxs-lookup"><span data-stu-id="52252-130">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="52252-131">Con frecuencia se puede ejecutar un conjunto de pruebas unitarias bien escrito sin mucho sobrecarga.</span><span class="sxs-lookup"><span data-stu-id="52252-131">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="52252-132">Sin embargo, las pruebas unitarias no detectan problemas en la interacción entre componentes, que es el propósito de [las pruebas de integración](xref:mvc/controllers/testing#integration-testing).</span><span class="sxs-lookup"><span data-stu-id="52252-132">However, unit tests do not detect issues in the interaction between components, which is the purpose of [integration testing](xref:mvc/controllers/testing#integration-testing).</span></span>

<span data-ttu-id="52252-133">Si va a escribir filtros personalizados, rutas, etcetera, debería prueba unitaria de ellas, pero no como parte de las pruebas en una acción de controlador determinado.</span><span class="sxs-lookup"><span data-stu-id="52252-133">If you're writing custom filters, routes, etc, you should unit test them, but not as part of your tests on a particular controller action.</span></span> <span data-ttu-id="52252-134">Deben probar de forma aislada.</span><span class="sxs-lookup"><span data-stu-id="52252-134">They should be tested in isolation.</span></span>

> [!TIP]
> <span data-ttu-id="52252-135">[Crear y ejecutar pruebas unitarias con Visual Studio](https://www.visualstudio.com/get-started/code/create-and-run-unit-tests-vs).</span><span class="sxs-lookup"><span data-stu-id="52252-135">[Create and run unit tests with Visual Studio](https://www.visualstudio.com/get-started/code/create-and-run-unit-tests-vs).</span></span>

<span data-ttu-id="52252-136">Para mostrar las pruebas unitarias, revise el siguiente controlador.</span><span class="sxs-lookup"><span data-stu-id="52252-136">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="52252-137">Muestra una lista de las sesiones de lluvia de ideas y permite que las sesiones que se creará con una entrada de blog de lluvia de ideas nuevas:</span><span class="sxs-lookup"><span data-stu-id="52252-137">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

<span data-ttu-id="52252-138">[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]</span><span class="sxs-lookup"><span data-stu-id="52252-138">[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]</span></span>

<span data-ttu-id="52252-139">El controlador es posterior a la [principio dependencias explícitas](http://deviq.com/explicit-dependencies-principle/), espera inyección de dependencia para proporcionar a una instancia de `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="52252-139">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="52252-140">Esto resulta bastante sencillo probar con el marco de objeto ficticio, al igual que [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="52252-140">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="52252-141">El `HTTP GET Index` método no tiene ningún bucle o bifurcación y solo llamadas a un método.</span><span class="sxs-lookup"><span data-stu-id="52252-141">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="52252-142">Para probar esto `Index` método, tenemos que verificar que un `ViewResult` se devuelve, con un `ViewModel` desde el repositorio `List` método.</span><span class="sxs-lookup"><span data-stu-id="52252-142">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

<span data-ttu-id="52252-143">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]</span><span class="sxs-lookup"><span data-stu-id="52252-143">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]</span></span>

<span data-ttu-id="52252-144">El `HomeController` `HTTP POST Index` debe comprobar el método (que se muestra arriba):</span><span class="sxs-lookup"><span data-stu-id="52252-144">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="52252-145">El método de acción devuelve una solicitud incorrecta `ViewResult` con los datos adecuados cuando `ModelState.IsValid` es`false`</span><span class="sxs-lookup"><span data-stu-id="52252-145">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`</span></span>

* <span data-ttu-id="52252-146">El `Add` se llama al método en el repositorio y un `RedirectToActionResult` se devuelve con los argumentos correctos cuando `ModelState.IsValid` es true.</span><span class="sxs-lookup"><span data-stu-id="52252-146">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="52252-147">Se puede probar el estado del modelo no válido mediante la adición de errores con `AddModelError` tal y como se muestra en la primera prueba siguiente.</span><span class="sxs-lookup"><span data-stu-id="52252-147">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

<span data-ttu-id="52252-148">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]</span><span class="sxs-lookup"><span data-stu-id="52252-148">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]</span></span>

<span data-ttu-id="52252-149">La primera prueba confirma cuando `ModelState` no es válido, el mismo `ViewResult` se devuelve como para una `GET` solicitud.</span><span class="sxs-lookup"><span data-stu-id="52252-149">The first test confirms when `ModelState` is not valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="52252-150">Tenga en cuenta que la prueba no intenta pasar en un modelo no válido.</span><span class="sxs-lookup"><span data-stu-id="52252-150">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="52252-151">Que funcionaría de todos modos ya que el enlace de modelos no se está ejecutando (aunque un [prueba de integración](xref:mvc/controllers/testing#integration-testing) utilizaría el enlace de modelos ejercicio).</span><span class="sxs-lookup"><span data-stu-id="52252-151">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:mvc/controllers/testing#integration-testing) would use exercise model binding).</span></span> <span data-ttu-id="52252-152">En este caso, el enlace de modelos no se está probando.</span><span class="sxs-lookup"><span data-stu-id="52252-152">In this case, model binding is not being tested.</span></span> <span data-ttu-id="52252-153">Estas pruebas unitarias están probando solo lo que hace el código en el método de acción.</span><span class="sxs-lookup"><span data-stu-id="52252-153">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="52252-154">La segunda prueba comprueba que, cuando `ModelState` es válido, un nuevo `BrainstormSession` se agrega (a través del repositorio), y el método devuelve un `RedirectToActionResult` con las propiedades esperadas.</span><span class="sxs-lookup"><span data-stu-id="52252-154">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="52252-155">Simuladas llamadas que no se llaman son normalmente omitidos, sino que realiza la llamada `Verifiable` al final de la configuración de llamada permite que se puede comprobar en la prueba.</span><span class="sxs-lookup"><span data-stu-id="52252-155">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="52252-156">Esto se hace con la llamada a `mockRepo.Verify`, que se producirá un error la prueba si no se llamó al método esperado.</span><span class="sxs-lookup"><span data-stu-id="52252-156">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method was not called.</span></span>

> [!NOTE]
> <span data-ttu-id="52252-157">La biblioteca Moq utilizada en este ejemplo resulta muy sencillo mezclar simulacros comprobables o "strict", con las simulaciones no comprobable (también denominadas "débil" mocks o código auxiliar).</span><span class="sxs-lookup"><span data-stu-id="52252-157">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="52252-158">Obtenga más información sobre [personalizar el comportamiento de simulacro con Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="52252-158">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="52252-159">Otro controlador de la aplicación muestra información relacionada con una sesión de lluvia de ideas determinado.</span><span class="sxs-lookup"><span data-stu-id="52252-159">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="52252-160">Incluye alguna lógica para tratar con valores de identificador no válido:</span><span class="sxs-lookup"><span data-stu-id="52252-160">It includes some logic to deal with invalid id values:</span></span>

<span data-ttu-id="52252-161">[!code-csharp[Main](./testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]</span><span class="sxs-lookup"><span data-stu-id="52252-161">[!code-csharp[Main](./testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]</span></span>

<span data-ttu-id="52252-162">La acción de controlador tiene tres casos de prueba, uno para cada `return` instrucción:</span><span class="sxs-lookup"><span data-stu-id="52252-162">The controller action has three cases to test, one for each `return` statement:</span></span>

<span data-ttu-id="52252-163">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]</span><span class="sxs-lookup"><span data-stu-id="52252-163">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]</span></span>

<span data-ttu-id="52252-164">La aplicación expone la funcionalidad Web API (una lista de ideas asociados a una sesión de lluvia de ideas y un método para agregar nuevas ideas a una sesión):</span><span class="sxs-lookup"><span data-stu-id="52252-164">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

<a name=ideas-controller></a>

<span data-ttu-id="52252-165">[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]</span><span class="sxs-lookup"><span data-stu-id="52252-165">[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]</span></span>

<span data-ttu-id="52252-166">El `ForSession` método devuelve una lista de `IdeaDTO` tipos.</span><span class="sxs-lookup"><span data-stu-id="52252-166">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="52252-167">Evite la devolución de las entidades de dominio empresariales directamente a través de llamadas a la API, porque con frecuencia incluyen más datos que requiere el cliente de API y acoplar innecesariamente modelo de dominio interno de la aplicación con la API expone externamente.</span><span class="sxs-lookup"><span data-stu-id="52252-167">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="52252-168">Asignación entre las entidades de dominio y los tipos que se devolverá a través de la conexión puede realizarse manualmente (usando un LINQ `Select` tal y como se muestra aquí) o mediante una biblioteca como [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span><span class="sxs-lookup"><span data-stu-id="52252-168">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span></span>

<span data-ttu-id="52252-169">Las pruebas unitarias para el `Create` y `ForSession` métodos de API:</span><span class="sxs-lookup"><span data-stu-id="52252-169">The unit tests for the `Create` and `ForSession` API methods:</span></span>

<span data-ttu-id="52252-170">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]</span><span class="sxs-lookup"><span data-stu-id="52252-170">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]</span></span>

<span data-ttu-id="52252-171">Como se indicó anteriormente, para probar el comportamiento del método cuando `ModelState` no es válida, agrega un error de modelo para el controlador como parte de la prueba.</span><span class="sxs-lookup"><span data-stu-id="52252-171">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="52252-172">No intente probar el enlace de validación o el modelo del modelo en las pruebas unitarias: prueba solo comportamiento de su método acción cuando se enfrente a un determinado `ModelState` valor.</span><span class="sxs-lookup"><span data-stu-id="52252-172">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="52252-173">La segunda prueba depende del repositorio devuelve null, por lo que está configurado el repositorio ficticio para devolver un valor nulo.</span><span class="sxs-lookup"><span data-stu-id="52252-173">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="52252-174">No es necesario para crear una base de datos de prueba (en la memoria o de otro modo) y crear una consulta que devuelve este resultado: se puede realizar en una sola instrucción tal como se muestra.</span><span class="sxs-lookup"><span data-stu-id="52252-174">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="52252-175">La última prueba comprueba que el repositorio `Update` se llama al método.</span><span class="sxs-lookup"><span data-stu-id="52252-175">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="52252-176">Tal y como se hacía anteriormente, se llama el simulacro con `Verifiable` y, a continuación, el ficticios del repositorio `Verify` método se llama para confirmar que se ejecutó el método comprobable.</span><span class="sxs-lookup"><span data-stu-id="52252-176">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="52252-177">No es una responsabilidad de pruebas unitarias para asegurarse de que el `Update` método guarda los datos; Esto puede realizarse con una prueba de integración.</span><span class="sxs-lookup"><span data-stu-id="52252-177">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="integration-testing"></a><span data-ttu-id="52252-178">Pruebas de integración</span><span class="sxs-lookup"><span data-stu-id="52252-178">Integration testing</span></span>

<span data-ttu-id="52252-179">[Pruebas de integración](../../testing/integration-testing.md) se realiza para garantizar correctamente juntos módulos independientes en el trabajo de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="52252-179">[Integration testing](../../testing/integration-testing.md) is done to ensure separate modules within your app work correctly together.</span></span> <span data-ttu-id="52252-180">Por lo general, todo lo que puede probar con una prueba unitaria, también puede probar con una prueba de integración, pero lo contrario no es cierto.</span><span class="sxs-lookup"><span data-stu-id="52252-180">Generally, anything you can test with a unit test, you can also test with an integration test, but the reverse isn't true.</span></span> <span data-ttu-id="52252-181">Sin embargo, las pruebas de integración tienden a ser mucho más lentas que las pruebas unitarias.</span><span class="sxs-lookup"><span data-stu-id="52252-181">However, integration tests tend to be much slower than unit tests.</span></span> <span data-ttu-id="52252-182">Por lo tanto, es mejor probar que se puede hacer con pruebas unitarias y usa pruebas de integración en escenarios que implican varios colaboradores.</span><span class="sxs-lookup"><span data-stu-id="52252-182">Thus, it's best to test whatever you can with unit tests, and use integration tests for scenarios that involve multiple collaborators.</span></span>

<span data-ttu-id="52252-183">Aunque todavía pueden ser útiles, objetos ficticios rara vez se utilizan en las pruebas de integración.</span><span class="sxs-lookup"><span data-stu-id="52252-183">Although they may still be useful, mock objects are rarely used in integration tests.</span></span> <span data-ttu-id="52252-184">En las pruebas unitarias, objetos ficticios son un método eficaz de controlar cómo deben comportarse el colaboradores fuera de la unidad que se está probando para los fines de la prueba.</span><span class="sxs-lookup"><span data-stu-id="52252-184">In unit testing, mock objects are an effective way to control how collaborators outside of the unit being tested should behave for the purposes of the test.</span></span> <span data-ttu-id="52252-185">En una prueba de integración, colaboradores reales se usan para confirmar que el subsistema todo funciona correctamente entre sí.</span><span class="sxs-lookup"><span data-stu-id="52252-185">In an integration test, real collaborators are used to confirm the whole subsystem works together correctly.</span></span>

### <a name="application-state"></a><span data-ttu-id="52252-186">Estado de la aplicación</span><span class="sxs-lookup"><span data-stu-id="52252-186">Application state</span></span>

<span data-ttu-id="52252-187">Una consideración importante al realizar pruebas de integración se muestra cómo establecer el estado de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="52252-187">One important consideration when performing integration testing is how to set your app's state.</span></span> <span data-ttu-id="52252-188">Las pruebas que deba ejecutar independientes entre sí y, por lo que cada prueba debe comenzar con la aplicación en un estado conocido.</span><span class="sxs-lookup"><span data-stu-id="52252-188">Tests need to run independent of one another, and so each test should start with the app in a known state.</span></span> <span data-ttu-id="52252-189">Si la aplicación no usa una base de datos o que tienen cualquier persistencia, esto puede no ser un problema.</span><span class="sxs-lookup"><span data-stu-id="52252-189">If your app doesn't use a database or have any persistence, this may not be an issue.</span></span> <span data-ttu-id="52252-190">Sin embargo, la mayoría de las aplicaciones reales conserva su estado a algún tipo de almacén de datos, por lo que todas las modificaciones realizadas por una prueba pudieron afectar a otra prueba a menos que se restablezca el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="52252-190">However, most real-world apps persist their state to some kind of data store, so any modifications made by one test could impact another test unless the data store is reset.</span></span> <span data-ttu-id="52252-191">Mediante la integrada `TestServer`, resulta muy sencillo a las aplicaciones ASP.NET Core de host en nuestras pruebas de integración, pero que no necesariamente concede acceso a los datos que se va a utilizar.</span><span class="sxs-lookup"><span data-stu-id="52252-191">Using the built-in `TestServer`, it's very straightforward to host ASP.NET Core apps within our integration tests, but that doesn't necessarily grant access to the data it will use.</span></span> <span data-ttu-id="52252-192">Si usa una base de datos real, un enfoque es que la aplicación conectarse a una base de datos de prueba, que pueden obtener acceso y asegúrese de las pruebas se restablece a un estado conocido antes de cada prueba se está ejecutando.</span><span class="sxs-lookup"><span data-stu-id="52252-192">If you're using an actual database, one approach is to have the app connect to a test database, which your tests can access and ensure is reset to a known state before each test executes.</span></span>

<span data-ttu-id="52252-193">En esta aplicación de ejemplo, utilizo soporte de InMemoryDatabase del núcleo de Entity Framework, por lo que solo se puede conectar a él desde mi proyecto de prueba.</span><span class="sxs-lookup"><span data-stu-id="52252-193">In this sample application, I'm using Entity Framework Core's InMemoryDatabase support, so I can't just connect to it from my test project.</span></span> <span data-ttu-id="52252-194">En su lugar, exponer un `InitializeDatabase` método desde la aplicación `Startup` (clase), que llamar cuando se inicia la aplicación si se encuentra en la `Development` entorno.</span><span class="sxs-lookup"><span data-stu-id="52252-194">Instead, I expose an `InitializeDatabase` method from the app's `Startup` class, which I call when the app starts up if it's in the `Development` environment.</span></span> <span data-ttu-id="52252-195">Mis pruebas de integración automáticamente beneficiarán de esto siempre que establezca el entorno en `Development`.</span><span class="sxs-lookup"><span data-stu-id="52252-195">My integration tests automatically benefit from this as long as they set the environment to `Development`.</span></span> <span data-ttu-id="52252-196">No tiene que preocuparse sobre el restablecimiento de la base de datos, ya que el InMemoryDatabase se restablece cada vez que la aplicación se reinicia.</span><span class="sxs-lookup"><span data-stu-id="52252-196">I don't have to worry about resetting the database, since the InMemoryDatabase is reset each time the app restarts.</span></span>

<span data-ttu-id="52252-197">La `Startup` clase:</span><span class="sxs-lookup"><span data-stu-id="52252-197">The `Startup` class:</span></span>

<span data-ttu-id="52252-198">[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Startup.cs?highlight=19,20,34,35,43,52)]</span><span class="sxs-lookup"><span data-stu-id="52252-198">[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Startup.cs?highlight=19,20,34,35,43,52)]</span></span>

<span data-ttu-id="52252-199">Verá el `GetTestSession` método que se usan con frecuencia en las pruebas de integración siguientes.</span><span class="sxs-lookup"><span data-stu-id="52252-199">You'll see the `GetTestSession` method used frequently in the integration tests below.</span></span>

### <a name="accessing-views"></a><span data-ttu-id="52252-200">Obtener acceso a vistas</span><span class="sxs-lookup"><span data-stu-id="52252-200">Accessing views</span></span>

<span data-ttu-id="52252-201">Cada clase de prueba de integración se configura el `TestServer` que ejecutará la aplicación de ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="52252-201">Each integration test class configures the `TestServer` that will run the ASP.NET Core app.</span></span> <span data-ttu-id="52252-202">De forma predeterminada, `TestServer` hospeda la aplicación web en la carpeta donde se está ejecutando - en este caso, la carpeta de proyecto de prueba.</span><span class="sxs-lookup"><span data-stu-id="52252-202">By default, `TestServer` hosts the web app in the folder where it's running - in this case, the test project folder.</span></span> <span data-ttu-id="52252-203">Por lo tanto, cuando intenta probar acciones del controlador que devuelven `ViewResult`, puede ver este error:</span><span class="sxs-lookup"><span data-stu-id="52252-203">Thus, when you attempt to test controller actions that return `ViewResult`, you may see this error:</span></span>

<!-- literal_block {"ids": [], "names": [], "highlight_args": {}, "backrefs": [], "dupnames": [], "linenos": false, "classes": [], "xml:space": "preserve", "language": "none"} -->

```none
The view 'Index' was not found. The following locations were searched:
(list of locations)
```

<span data-ttu-id="52252-204">Para corregir este problema, debe configurar la raíz del contenido del servidor, para que pueda localizar las vistas para el proyecto que se está probando.</span><span class="sxs-lookup"><span data-stu-id="52252-204">To correct this issue, you need to configure the server's content root, so it can locate the views for the project being tested.</span></span> <span data-ttu-id="52252-205">Esto se realiza mediante una llamada a `UseContentRoot` en la `TestFixture` (clase), se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="52252-205">This is done by a call to `UseContentRoot` in the `TestFixture` class, shown below:</span></span>

<span data-ttu-id="52252-206">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/TestFixture.cs?highlight=30,33)]</span><span class="sxs-lookup"><span data-stu-id="52252-206">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/TestFixture.cs?highlight=30,33)]</span></span>

<span data-ttu-id="52252-207">El `TestFixture` clase es responsable de configurar y crear el `TestServer`, configurando un `HttpClient` para comunicarse con el `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="52252-207">The `TestFixture` class is responsible for configuring and creating the `TestServer`, setting up an `HttpClient` to communicate with the `TestServer`.</span></span> <span data-ttu-id="52252-208">Cada una de la integración de la prueba usa el `Client` propiedad para conectarse al servidor de prueba y realizar una solicitud.</span><span class="sxs-lookup"><span data-stu-id="52252-208">Each of the integration tests uses the `Client` property to connect to the test server and make a request.</span></span>

<span data-ttu-id="52252-209">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/HomeControllerTests.cs?highlight=20,26,29,30,31,35,38,39,40,41,44,47,48)]</span><span class="sxs-lookup"><span data-stu-id="52252-209">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/HomeControllerTests.cs?highlight=20,26,29,30,31,35,38,39,40,41,44,47,48)]</span></span>

<span data-ttu-id="52252-210">En la primera prueba anterior, el `responseString` contiene los datos reales representan HTML de la vista, que se puede inspeccionar para confirmar contiene los resultados esperados.</span><span class="sxs-lookup"><span data-stu-id="52252-210">In the first test above, the `responseString` holds the actual rendered HTML from the View, which can be inspected to confirm it contains expected results.</span></span>

<span data-ttu-id="52252-211">La segunda prueba crea un formulario POST con un nombre de sesión único y envía a la aplicación, a continuación, se comprueba que se devuelve la redirección esperada.</span><span class="sxs-lookup"><span data-stu-id="52252-211">The second test constructs a form POST with a unique session name and POSTs it to the app, then verifies that the expected redirect is returned.</span></span>

### <a name="api-methods"></a><span data-ttu-id="52252-212">Métodos de la API</span><span class="sxs-lookup"><span data-stu-id="52252-212">API methods</span></span>

<span data-ttu-id="52252-213">Si la aplicación expone las API, lo confirmar de una buena idea ha pruebas automatizadas se ejecutan según lo previsto web.</span><span class="sxs-lookup"><span data-stu-id="52252-213">If your app exposes web APIs, it's a good idea to have automated tests confirm they execute as expected.</span></span> <span data-ttu-id="52252-214">Integrado `TestServer` facilita el proceso probar las API web.</span><span class="sxs-lookup"><span data-stu-id="52252-214">The built-in `TestServer` makes it easy to test web APIs.</span></span> <span data-ttu-id="52252-215">Si los métodos de la API utilizan un enlace de modelo, debe comprobar siempre `ModelState.IsValid`, y las pruebas de integración son el lugar adecuado para confirmar que la validación del modelo funciona correctamente.</span><span class="sxs-lookup"><span data-stu-id="52252-215">If your API methods are using model binding, you should always check `ModelState.IsValid`, and integration tests are the right place to confirm that your model validation is working properly.</span></span>

<span data-ttu-id="52252-216">El siguiente conjunto de destino de pruebas la `Create` método en el [IdeasController](xref:mvc/controllers/testing#ideas-controller) clase mostrado anteriormente:</span><span class="sxs-lookup"><span data-stu-id="52252-216">The following set of tests target the `Create` method in the [IdeasController](xref:mvc/controllers/testing#ideas-controller) class shown above:</span></span>

<span data-ttu-id="52252-217">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/ApiIdeasControllerTests.cs)]</span><span class="sxs-lookup"><span data-stu-id="52252-217">[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/ApiIdeasControllerTests.cs)]</span></span>

<span data-ttu-id="52252-218">A diferencia de las pruebas de integración de acciones que devuelve HTML vistas, los métodos de API web que devuelven resultados normalmente puede deserializados como objetos fuertemente tipados, como se muestra en la última prueba anterior.</span><span class="sxs-lookup"><span data-stu-id="52252-218">Unlike integration tests of actions that returns HTML views, web API methods that return results can usually be deserialized as strongly typed objects, as the last test above shows.</span></span> <span data-ttu-id="52252-219">En este caso, la prueba deserializa el resultado a un `BrainstormSession` una instancia y confirma que la idea se agregó correctamente a la colección de ideas.</span><span class="sxs-lookup"><span data-stu-id="52252-219">In this case, the test deserializes the result to a `BrainstormSession` instance, and confirms that the idea was correctly added to its collection of ideas.</span></span>

<span data-ttu-id="52252-220">En este artículo encontrará ejemplos adicionales de pruebas de integración [proyecto de ejemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span><span class="sxs-lookup"><span data-stu-id="52252-220">You'll find additional examples of integration tests in this article's [sample project](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span></span>
