---
title: Inserción de dependencias en ASP.NET Core
author: ardalis
description: Obtenga información sobre la manera en que ASP.NET Core implementa la inserción de dependencias y cómo se usa.
manager: wpickett
ms.author: riande
ms.custom: H1Hack27Feb2017
ms.date: 10/14/2016
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: fundamentals/dependency-injection
ms.openlocfilehash: 14c3d464773fe78a563a27776bfcd124c22df134
ms.sourcegitcommit: 43bd79667bbdc8a07bd39fb4cd6f7ad3e70212fb
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 06/04/2018
ms.locfileid: "34566963"
---
# <a name="dependency-injection-in-aspnet-core"></a><span data-ttu-id="081b0-103">Inserción de dependencias en ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="081b0-103">Dependency injection in ASP.NET Core</span></span>

<a name="fundamentals-dependency-injection"></a>

<span data-ttu-id="081b0-104">Por [Steve Smith](https://ardalis.com/) y [Scott Addie](https://scottaddie.com)</span><span class="sxs-lookup"><span data-stu-id="081b0-104">By [Steve Smith](https://ardalis.com/) and [Scott Addie](https://scottaddie.com)</span></span>

<span data-ttu-id="081b0-105">ASP.NET Core está diseñado desde el principio para admitir y aprovechar la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-105">ASP.NET Core is designed from the ground up to support and leverage dependency injection.</span></span> <span data-ttu-id="081b0-106">Las aplicaciones ASP.NET Core pueden aprovechar los servicios del marco de trabajo integrado si los insertan en métodos de la clase Startup, y los servicios de las aplicaciones también pueden configurarse para la inserción.</span><span class="sxs-lookup"><span data-stu-id="081b0-106">ASP.NET Core applications can leverage built-in framework services by having them injected into methods in the Startup class, and application services can be configured for injection as well.</span></span> <span data-ttu-id="081b0-107">El contenedor de servicios predeterminados proporcionado por ASP.NET Core incluye un conjunto de característica mínimas y no está diseñado para reemplazar otros contenedores.</span><span class="sxs-lookup"><span data-stu-id="081b0-107">The default services container provided by ASP.NET Core provides a minimal feature set and isn't intended to replace other containers.</span></span>

<span data-ttu-id="081b0-108">[Vea o descargue el código de ejemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([cómo descargarlo](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="081b0-108">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="what-is-dependency-injection"></a><span data-ttu-id="081b0-109">¿Qué es la inserción de dependencias?</span><span class="sxs-lookup"><span data-stu-id="081b0-109">What is dependency injection?</span></span>

<span data-ttu-id="081b0-110">La inserción de dependencias (DI) es una técnica para lograr un acoplamiento flexible entre los objetos y sus colaboradores (o dependencias).</span><span class="sxs-lookup"><span data-stu-id="081b0-110">Dependency injection (DI) is a technique for achieving loose coupling between objects and their collaborators, or dependencies.</span></span> <span data-ttu-id="081b0-111">En lugar de crear directamente instancias de colaboradores o de usar referencias estáticas, los objetos que una clase necesita para llevar a cabo sus acciones se proporcionan de algún modo a dicha clase.</span><span class="sxs-lookup"><span data-stu-id="081b0-111">Rather than directly instantiating collaborators, or using static references, the objects a class needs in order to perform its actions are provided to the class in some fashion.</span></span> <span data-ttu-id="081b0-112">A menudo, las clases declaran sus dependencias a través de su constructor, lo que les permite seguir el [principio de dependencias explícitas](http://deviq.com/explicit-dependencies-principle/).</span><span class="sxs-lookup"><span data-stu-id="081b0-112">Most often, classes will declare their dependencies via their constructor, allowing them to follow the [Explicit Dependencies Principle](http://deviq.com/explicit-dependencies-principle/).</span></span> <span data-ttu-id="081b0-113">Este método se conoce como "inserción de constructor".</span><span class="sxs-lookup"><span data-stu-id="081b0-113">This approach is known as "constructor injection".</span></span>

<span data-ttu-id="081b0-114">Cuando las clases se diseñan con DI en mente, se acoplan de manera más flexible porque no tienen dependencias directas codificadas de forma rígida en sus colaboradores.</span><span class="sxs-lookup"><span data-stu-id="081b0-114">When classes are designed with DI in mind, they're more loosely coupled because they don't have direct, hard-coded dependencies on their collaborators.</span></span> <span data-ttu-id="081b0-115">Esto sigue el [principio de inversión de dependencias](http://deviq.com/dependency-inversion-principle/), que afirma que *"los módulos de nivel alto no deben depender de los módulos de nivel bajo; ambos deben depender de abstracciones"*.</span><span class="sxs-lookup"><span data-stu-id="081b0-115">This follows the [Dependency Inversion Principle](http://deviq.com/dependency-inversion-principle/), which states that *"high level modules shouldn't depend on low level modules; both should depend on abstractions."*</span></span> <span data-ttu-id="081b0-116">En lugar de hacer referencia a implementaciones específicas, las clases solicitan abstracciones (normalmente `interfaces`) que se les proporcionan cuando se construye la clase.</span><span class="sxs-lookup"><span data-stu-id="081b0-116">Instead of referencing specific implementations, classes request abstractions (typically `interfaces`) which are provided to them when the class is constructed.</span></span> <span data-ttu-id="081b0-117">La extracción de dependencias en interfaces y el abastecimiento de implementaciones de estas interfaces como parámetros son también ejemplos del [modelo de diseño de estrategias](http://deviq.com/strategy-design-pattern/).</span><span class="sxs-lookup"><span data-stu-id="081b0-117">Extracting dependencies into interfaces and providing implementations of these interfaces as parameters is also an example of the [Strategy design pattern](http://deviq.com/strategy-design-pattern/).</span></span>

<span data-ttu-id="081b0-118">Cuando se diseña un sistema para el uso de DI, con muchas clases que solicitan sus dependencias a través de su constructor (o propiedades), resulta útil tener una clase dedicada a la creación de estas clases con sus dependencias asociadas.</span><span class="sxs-lookup"><span data-stu-id="081b0-118">When a system is designed to use DI, with many classes requesting their dependencies via their constructor (or properties), it's helpful to have a class dedicated to creating these classes with their associated dependencies.</span></span> <span data-ttu-id="081b0-119">Estas clases se conocen como *contenedores* o, más concretamente, contenedores de [inversión de control (IoC)](http://deviq.com/inversion-of-control/) o contenedores de inserción de dependencias (DI).</span><span class="sxs-lookup"><span data-stu-id="081b0-119">These classes are referred to as *containers*, or more specifically, [Inversion of Control (IoC)](http://deviq.com/inversion-of-control/) containers or Dependency Injection (DI) containers.</span></span> <span data-ttu-id="081b0-120">Un contenedor es básicamente un generador que se encarga de proporcionar las instancias de tipos que se le solicitan.</span><span class="sxs-lookup"><span data-stu-id="081b0-120">A container is essentially a factory that's responsible for providing instances of types that are requested from it.</span></span> <span data-ttu-id="081b0-121">Si un tipo determinado ha declarado que tiene dependencias y el contenedor se ha configurado para proporcionar tipos de dependencia, creará las dependencias como parte del proceso de creación de la instancia solicitada.</span><span class="sxs-lookup"><span data-stu-id="081b0-121">If a given type has declared that it has dependencies, and the container has been configured to provide the dependency types, it will create the dependencies as part of creating the requested instance.</span></span> <span data-ttu-id="081b0-122">De esta manera, se pueden proporcionar gráficos de dependencias complejos a las clases sin necesidad de construir objetos codificados de forma rígida.</span><span class="sxs-lookup"><span data-stu-id="081b0-122">In this way, complex dependency graphs can be provided to classes without the need for any hard-coded object construction.</span></span> <span data-ttu-id="081b0-123">Además de crear objetos con sus dependencias, los contenedores suelen administrar la duración de los objetos dentro de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="081b0-123">In addition to creating objects with their dependencies, containers typically manage object lifetimes within the application.</span></span>

<span data-ttu-id="081b0-124">ASP.NET Core incluye un simple contenedor integrado (representado por la interfaz `IServiceProvider`) que admite la inserción de constructor de forma predeterminada, y ASP.NET hace que determinados servicios estén disponibles a través de DI.</span><span class="sxs-lookup"><span data-stu-id="081b0-124">ASP.NET Core includes a simple built-in container (represented by the `IServiceProvider` interface) that supports constructor injection by default, and ASP.NET makes certain services available through DI.</span></span> <span data-ttu-id="081b0-125">El contenedor de ASP.NET hace referencia a los tipos que administra como *servicios*.</span><span class="sxs-lookup"><span data-stu-id="081b0-125">ASP.NET's container refers to the types it manages as *services*.</span></span> <span data-ttu-id="081b0-126">De ahora en adelante en este artículo, el término *servicios* hará referencia a los tipos administrados por el contenedor de IoC de ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="081b0-126">Throughout the rest of this article, *services* will refer to types that are managed by ASP.NET Core's IoC container.</span></span> <span data-ttu-id="081b0-127">Los servicios del contenedor integrado se configuran en el método `ConfigureServices` de la clase `Startup` de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="081b0-127">You configure the built-in container's services in the `ConfigureServices` method in your application's `Startup` class.</span></span>

> [!NOTE]
> <span data-ttu-id="081b0-128">Martin Fowler ha escrito un amplio artículo sobre [los contenedores de inversión de control y el patrón de inserción de dependencias](https://www.martinfowler.com/articles/injection.html).</span><span class="sxs-lookup"><span data-stu-id="081b0-128">Martin Fowler has written an extensive article on [Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html).</span></span> <span data-ttu-id="081b0-129">En los Modelos y prácticas de Microsoft también encontrará una descripción excelente de la [inserción de dependencias](https://msdn.microsoft.com/library/hh323705.aspx).</span><span class="sxs-lookup"><span data-stu-id="081b0-129">Microsoft Patterns and Practices also has a great description of [Dependency Injection](https://msdn.microsoft.com/library/hh323705.aspx).</span></span>

> [!NOTE]
> <span data-ttu-id="081b0-130">Este artículo trata sobre la inserción de dependencias tal como se aplica a todas las aplicaciones ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="081b0-130">This article covers Dependency Injection as it applies to all ASP.NET applications.</span></span> <span data-ttu-id="081b0-131">La inserción de dependencias dentro de controladores de MVC se trata en [Inserción de dependencias y controladores](../mvc/controllers/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="081b0-131">Dependency Injection within MVC controllers is covered in [Dependency Injection and Controllers](../mvc/controllers/dependency-injection.md).</span></span>

### <a name="constructor-injection-behavior"></a><span data-ttu-id="081b0-132">Comportamiento de inserción de constructor</span><span class="sxs-lookup"><span data-stu-id="081b0-132">Constructor injection behavior</span></span>

<span data-ttu-id="081b0-133">La inserción de constructor requiere que el constructor en cuestión sea *público*.</span><span class="sxs-lookup"><span data-stu-id="081b0-133">Constructor injection requires that the constructor in question be *public*.</span></span> <span data-ttu-id="081b0-134">En caso contrario, la aplicación producirá una `InvalidOperationException`:</span><span class="sxs-lookup"><span data-stu-id="081b0-134">Otherwise, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="081b0-135">A suitable constructor for type 'YourType' couldn't be located.</span><span class="sxs-lookup"><span data-stu-id="081b0-135">A suitable constructor for type 'YourType' couldn't be located.</span></span> <span data-ttu-id="081b0-136">Ensure the type is concrete and services are registered for all parameters of a public constructor. (No se pudo encontrar un constructor adecuado para el tipo "SuTipo". Asegúrese de que el tipo sea concreto y de que los servicios estén registrados para todos los parámetros de un constructor público.)</span><span class="sxs-lookup"><span data-stu-id="081b0-136">Ensure the type is concrete and services are registered for all parameters of a public constructor.</span></span>

<span data-ttu-id="081b0-137">La inserción de constructor requiere que solo exista un constructor aplicable.</span><span class="sxs-lookup"><span data-stu-id="081b0-137">Constructor injection requires that only one applicable constructor exist.</span></span> <span data-ttu-id="081b0-138">Se admiten las sobrecargas de constructor, pero solo puede existir una sobrecarga cuyos argumentos pueda cumplir la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-138">Constructor overloads are supported, but only one overload can exist whose arguments can all be fulfilled by dependency injection.</span></span> <span data-ttu-id="081b0-139">Si existe más de una, la aplicación producirá una `InvalidOperationException`:</span><span class="sxs-lookup"><span data-stu-id="081b0-139">If more than one exists, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="081b0-140">Multiple constructors accepting all given argument types have been found in type 'YourType'.</span><span class="sxs-lookup"><span data-stu-id="081b0-140">Multiple constructors accepting all given argument types have been found in type 'YourType'.</span></span> <span data-ttu-id="081b0-141">Multiple constructors accepting all given argument types have been found in type 'YourType'. There should only be one applicable constructor. (Se han encontrado en el tipo "SuTipo" varios constructores que aceptan todos los tipos de argumento especificados. Solo debe haber un constructor aplicable.)</span><span class="sxs-lookup"><span data-stu-id="081b0-141">There should only be one applicable constructor.</span></span>

<span data-ttu-id="081b0-142">Los constructores pueden aceptar argumentos que no se proporcionan mediante la inserción de dependencias, pero deben admitir valores predeterminados.</span><span class="sxs-lookup"><span data-stu-id="081b0-142">Constructors can accept arguments that are not provided by dependency injection, but these must support default values.</span></span> <span data-ttu-id="081b0-143">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="081b0-143">For example:</span></span>

```csharp
// throws InvalidOperationException: Unable to resolve service for type 'System.String'...
public CharactersController(ICharacterRepository characterRepository, string title)
{
    _characterRepository = characterRepository;
    _title = title;
}

// runs without error
public CharactersController(ICharacterRepository characterRepository, string title = "Characters")
{
    _characterRepository = characterRepository;
    _title = title;
}
```

## <a name="using-framework-provided-services"></a><span data-ttu-id="081b0-144">Uso de servicios proporcionados por el marco de trabajo</span><span class="sxs-lookup"><span data-stu-id="081b0-144">Using framework-provided services</span></span>

<span data-ttu-id="081b0-145">El método `ConfigureServices` de la clase `Startup` se encarga de definir los servicios que usará la aplicación, incluidas las características de plataforma como Entity Framework Core y ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="081b0-145">The `ConfigureServices` method in the `Startup` class is responsible for defining the services the application will use, including platform features like Entity Framework Core and ASP.NET Core MVC.</span></span> <span data-ttu-id="081b0-146">Inicialmente, el valor `IServiceCollection` proporcionado a `ConfigureServices` tiene los siguientes servicios definidos (en función de [cómo se configurara el host](xref:fundamentals/host/index)):</span><span class="sxs-lookup"><span data-stu-id="081b0-146">Initially, the `IServiceCollection` provided to `ConfigureServices` has the following services defined (depending on [how the host was configured](xref:fundamentals/host/index)):</span></span>

| <span data-ttu-id="081b0-147">Tipo de servicio</span><span class="sxs-lookup"><span data-stu-id="081b0-147">Service Type</span></span> | <span data-ttu-id="081b0-148">Período de duración</span><span class="sxs-lookup"><span data-stu-id="081b0-148">Lifetime</span></span> |
| ----- | ------- |
| [<span data-ttu-id="081b0-149">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span><span class="sxs-lookup"><span data-stu-id="081b0-149">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.ihostingenvironment) | <span data-ttu-id="081b0-150">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-150">Singleton</span></span> |
| [<span data-ttu-id="081b0-151">Microsoft.Extensions.Logging.ILoggerFactory</span><span class="sxs-lookup"><span data-stu-id="081b0-151">Microsoft.Extensions.Logging.ILoggerFactory</span></span>](/dotnet/api/microsoft.extensions.logging.iloggerfactory) | <span data-ttu-id="081b0-152">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-152">Singleton</span></span> |
| [<span data-ttu-id="081b0-153">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="081b0-153">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span></span>](/dotnet/api/microsoft.extensions.logging.ilogger) | <span data-ttu-id="081b0-154">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-154">Singleton</span></span> |
| [<span data-ttu-id="081b0-155">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span><span class="sxs-lookup"><span data-stu-id="081b0-155">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.builder.iapplicationbuilderfactory) | <span data-ttu-id="081b0-156">Transitorio</span><span class="sxs-lookup"><span data-stu-id="081b0-156">Transient</span></span> |
| [<span data-ttu-id="081b0-157">Microsoft.AspNetCore.Http.IHttpContextFactory</span><span class="sxs-lookup"><span data-stu-id="081b0-157">Microsoft.AspNetCore.Http.IHttpContextFactory</span></span>](/dotnet/api/microsoft.aspnetcore.http.ihttpcontextfactory) | <span data-ttu-id="081b0-158">Transitorio</span><span class="sxs-lookup"><span data-stu-id="081b0-158">Transient</span></span> |
| [<span data-ttu-id="081b0-159">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="081b0-159">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span></span>](/dotnet/api/microsoft.extensions.options.ioptions-1) | <span data-ttu-id="081b0-160">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-160">Singleton</span></span> |
| [<span data-ttu-id="081b0-161">System.Diagnostics.DiagnosticSource</span><span class="sxs-lookup"><span data-stu-id="081b0-161">System.Diagnostics.DiagnosticSource</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticsource) | <span data-ttu-id="081b0-162">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-162">Singleton</span></span> |
| [<span data-ttu-id="081b0-163">System.Diagnostics.DiagnosticListener</span><span class="sxs-lookup"><span data-stu-id="081b0-163">System.Diagnostics.DiagnosticListener</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticlistener) | <span data-ttu-id="081b0-164">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-164">Singleton</span></span> |
| [<span data-ttu-id="081b0-165">Microsoft.AspNetCore.Hosting.IStartupFilter</span><span class="sxs-lookup"><span data-stu-id="081b0-165">Microsoft.AspNetCore.Hosting.IStartupFilter</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter) | <span data-ttu-id="081b0-166">Transitorio</span><span class="sxs-lookup"><span data-stu-id="081b0-166">Transient</span></span> |
| [<span data-ttu-id="081b0-167">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span><span class="sxs-lookup"><span data-stu-id="081b0-167">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span></span>](/dotnet/api/microsoft.extensions.objectpool.objectpoolprovider) | <span data-ttu-id="081b0-168">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-168">Singleton</span></span> |
| [<span data-ttu-id="081b0-169">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="081b0-169">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span></span>](/dotnet/api/microsoft.extensions.options.iconfigureoptions-1) | <span data-ttu-id="081b0-170">Transitorio</span><span class="sxs-lookup"><span data-stu-id="081b0-170">Transient</span></span> |
| [<span data-ttu-id="081b0-171">Microsoft.AspNetCore.Hosting.Server.IServer</span><span class="sxs-lookup"><span data-stu-id="081b0-171">Microsoft.AspNetCore.Hosting.Server.IServer</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.server.iserver) | <span data-ttu-id="081b0-172">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-172">Singleton</span></span> |
| [<span data-ttu-id="081b0-173">Microsoft.AspNetCore.Hosting.IStartup</span><span class="sxs-lookup"><span data-stu-id="081b0-173">Microsoft.AspNetCore.Hosting.IStartup</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.istartup) | <span data-ttu-id="081b0-174">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-174">Singleton</span></span> |
| [<span data-ttu-id="081b0-175">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span><span class="sxs-lookup"><span data-stu-id="081b0-175">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.iapplicationlifetime) | <span data-ttu-id="081b0-176">Singleton</span><span class="sxs-lookup"><span data-stu-id="081b0-176">Singleton</span></span> |

<span data-ttu-id="081b0-177">A continuación se muestra un ejemplo de cómo agregar servicios adicionales al contenedor mediante una serie de métodos de extensión como `AddDbContext`, `AddIdentity` y `AddMvc`.</span><span class="sxs-lookup"><span data-stu-id="081b0-177">Below is an example of how to add additional services to the container using a number of extension methods like `AddDbContext`, `AddIdentity`, and `AddMvc`.</span></span>

[!code-csharp[](../common/samples/WebApplication1/Startup.cs?highlight=5-6,8-10,12&range=39-56)]

<span data-ttu-id="081b0-178">Las características y el software intermedio proporcionados por ASP.NET, como MVC, siguen la convención de usar un solo método de extensión Add*NombreDelServicio* para registrar todos los servicios requeridos por esa característica.</span><span class="sxs-lookup"><span data-stu-id="081b0-178">The features and middleware provided by ASP.NET, such as MVC, follow a convention of using a single Add*ServiceName* extension method to register all of the services required by that feature.</span></span>

> [!TIP]
> <span data-ttu-id="081b0-179">Puede solicitar determinados servicios proporcionados por el marco de trabajo dentro de métodos `Startup` mediante sus listas de parámetros. Vea [Inicio de la aplicación](startup.md) para obtener más detalles.</span><span class="sxs-lookup"><span data-stu-id="081b0-179">You can request certain framework-provided services within `Startup` methods through their parameter lists - see [Application Startup](startup.md) for more details.</span></span>

## <a name="registering-services"></a><span data-ttu-id="081b0-180">Registrar servicios</span><span class="sxs-lookup"><span data-stu-id="081b0-180">Registering services</span></span>

<span data-ttu-id="081b0-181">Puede registrar sus propios servicios de aplicación de la manera siguiente.</span><span class="sxs-lookup"><span data-stu-id="081b0-181">You can register your own application services as follows.</span></span> <span data-ttu-id="081b0-182">El primer tipo genérico representa el tipo (normalmente una interfaz) que se solicitará desde el contenedor.</span><span class="sxs-lookup"><span data-stu-id="081b0-182">The first generic type represents the type (typically an interface) that will be requested from the container.</span></span> <span data-ttu-id="081b0-183">El segundo tipo genérico representa el tipo concreto del cual creará una instancia el contenedor y que se usará para responder a dichas solicitudes.</span><span class="sxs-lookup"><span data-stu-id="081b0-183">The second generic type represents the concrete type that will be instantiated by the container and used to fulfill such requests.</span></span>

[!code-csharp[](../common/samples/WebApplication1/Startup.cs?range=53-54)]

> [!NOTE]
> <span data-ttu-id="081b0-184">Cada método de extensión `services.Add<ServiceName>` agrega servicios (y potencialmente los configura).</span><span class="sxs-lookup"><span data-stu-id="081b0-184">Each `services.Add<ServiceName>` extension method adds (and potentially configures) services.</span></span> <span data-ttu-id="081b0-185">Por ejemplo, `services.AddMvc()` agrega los servicios que requiere MVC.</span><span class="sxs-lookup"><span data-stu-id="081b0-185">For example, `services.AddMvc()` adds the services MVC requires.</span></span> <span data-ttu-id="081b0-186">Se recomienda que siga esta convención y coloque los métodos de extensión en el espacio de nombres `Microsoft.Extensions.DependencyInjection` para encapsular grupos de registros del servicio.</span><span class="sxs-lookup"><span data-stu-id="081b0-186">It's recommended that you follow this convention, placing extension methods in the `Microsoft.Extensions.DependencyInjection` namespace, to encapsulate groups of service registrations.</span></span>

<span data-ttu-id="081b0-187">El método `AddTransient` se usa para asignar tipos abstractos a servicios concretos de los que se crean instancias por separado para cada objeto que lo requiera.</span><span class="sxs-lookup"><span data-stu-id="081b0-187">The `AddTransient` method is used to map abstract types to concrete services that are instantiated separately for every object that requires it.</span></span> <span data-ttu-id="081b0-188">Esto se conoce como la *duración* del servicio. A continuación se describen opciones de duración adicionales.</span><span class="sxs-lookup"><span data-stu-id="081b0-188">This is known as the service's *lifetime*, and additional lifetime options are described below.</span></span> <span data-ttu-id="081b0-189">Es importante elegir una duración adecuada para cada uno de los servicios que se registren.</span><span class="sxs-lookup"><span data-stu-id="081b0-189">It's important to choose an appropriate lifetime for each of the services you register.</span></span> <span data-ttu-id="081b0-190">¿Debe proporcionarse una nueva instancia del servicio a cada clase que lo solicite?</span><span class="sxs-lookup"><span data-stu-id="081b0-190">Should a new instance of the service be provided to each class that requests it?</span></span> <span data-ttu-id="081b0-191">¿Debe usarse una instancia en una solicitud web determinada?</span><span class="sxs-lookup"><span data-stu-id="081b0-191">Should one instance be used throughout a given web request?</span></span> <span data-ttu-id="081b0-192">¿O debe usarse una sola instancia para la duración de la aplicación?</span><span class="sxs-lookup"><span data-stu-id="081b0-192">Or should a single instance be used for the lifetime of the application?</span></span>

<span data-ttu-id="081b0-193">En el ejemplo incluido en este artículo, hay un controlador simple que muestra los nombres de caracteres, denominado `CharactersController`.</span><span class="sxs-lookup"><span data-stu-id="081b0-193">In the sample for this article, there's a simple controller that displays character names, called `CharactersController`.</span></span> <span data-ttu-id="081b0-194">Su método `Index` muestra la lista actual de caracteres que se han almacenado en la aplicación e inicializa la colección con unos cuantos caracteres, si no existe ninguno.</span><span class="sxs-lookup"><span data-stu-id="081b0-194">Its `Index` method displays the current list of characters that have been stored in the application, and initializes the collection with a handful of characters if none exist.</span></span> <span data-ttu-id="081b0-195">Tenga en cuenta que, aunque esta aplicación usa Entity Framework Core y la clase `ApplicationDbContext` para su persistencia, ninguno es evidente en el controlador.</span><span class="sxs-lookup"><span data-stu-id="081b0-195">Note that although this application uses Entity Framework Core and the `ApplicationDbContext` class for its persistence, none of that's apparent in the controller.</span></span> <span data-ttu-id="081b0-196">En su lugar, el mecanismo de acceso a datos específico se ha abstraído detrás de una interfaz, `ICharacterRepository`, que sigue el [modelo de repositorio](http://deviq.com/repository-pattern/).</span><span class="sxs-lookup"><span data-stu-id="081b0-196">Instead, the specific data access mechanism has been abstracted behind an interface, `ICharacterRepository`, which follows the [repository pattern](http://deviq.com/repository-pattern/).</span></span> <span data-ttu-id="081b0-197">Se solicita una instancia de `ICharacterRepository` mediante el constructor y se asigna a un campo privado, que después se usa para tener acceso a caracteres, según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="081b0-197">An instance of `ICharacterRepository` is requested via the constructor and assigned to a private field, which is then used to access characters as necessary.</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Controllers/CharactersController.cs?highlight=3,5,6,7,8,14,21-27&range=8-36)]

<span data-ttu-id="081b0-198">`ICharacterRepository` define los dos métodos que el controlador necesita para funcionar con instancias de `Character`.</span><span class="sxs-lookup"><span data-stu-id="081b0-198">The `ICharacterRepository` defines the two methods the controller needs to work with `Character` instances.</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/ICharacterRepository.cs?highlight=8,9)]

<span data-ttu-id="081b0-199">Esta interfaz la implementa a su vez un tipo concreto, `CharacterRepository`, que se usa en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="081b0-199">This interface is in turn implemented by a concrete type, `CharacterRepository`, that's used at runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="081b0-200">La manera en que se usa la inserción de dependencias con la clase `CharacterRepository` es un modelo general que puede seguir para todos los servicios de aplicación, no solo en "repositorios" o clases de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="081b0-200">The way DI is used with the `CharacterRepository` class is a general model you can follow for all of your application services, not just in "repositories" or data access classes.</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Models/CharacterRepository.cs?highlight=9,11,12,13,14)]

<span data-ttu-id="081b0-201">Tenga en cuenta que `CharacterRepository` solicita `ApplicationDbContext` en su constructor.</span><span class="sxs-lookup"><span data-stu-id="081b0-201">Note that `CharacterRepository` requests an `ApplicationDbContext` in its constructor.</span></span> <span data-ttu-id="081b0-202">No es raro que la inserción de dependencias se use encadenada de este modo, donde cada dependencia solicitada solicita a su vez sus propias dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-202">It's not unusual for dependency injection to be used in a chained fashion like this, with each requested dependency in turn requesting its own dependencies.</span></span> <span data-ttu-id="081b0-203">El contenedor se encarga de resolver todas las dependencias del gráfico y devolver el servicio totalmente resuelto.</span><span class="sxs-lookup"><span data-stu-id="081b0-203">The container is responsible for resolving all of the dependencies in the graph and returning the fully resolved service.</span></span>

> [!NOTE]
> <span data-ttu-id="081b0-204">El proceso de creación del objeto solicitado, de todos los objetos que necesita y de todos los objetos que estos necesitan suele denominarse *gráfico de objetos*.</span><span class="sxs-lookup"><span data-stu-id="081b0-204">Creating the requested object, and all of the objects it requires, and all of the objects those require, is sometimes referred to as an *object graph*.</span></span> <span data-ttu-id="081b0-205">Del mismo modo, el conjunto colectivo de dependencias que deben resolverse suele denominarse *árbol de dependencias* o *gráfico de dependencias*.</span><span class="sxs-lookup"><span data-stu-id="081b0-205">Likewise, the collective set of dependencies that must be resolved is typically referred to as a *dependency tree* or *dependency graph*.</span></span>

<span data-ttu-id="081b0-206">En este caso, es necesario registrar `ICharacterRepository` y `ApplicationDbContext` con el contenedor de servicios de `ConfigureServices` en `Startup`.</span><span class="sxs-lookup"><span data-stu-id="081b0-206">In this case, both `ICharacterRepository` and in turn `ApplicationDbContext` must be registered with the services container in `ConfigureServices` in `Startup`.</span></span> <span data-ttu-id="081b0-207">`ApplicationDbContext` se configura con la llamada al método de extensión `AddDbContext<T>`.</span><span class="sxs-lookup"><span data-stu-id="081b0-207">`ApplicationDbContext` is configured with the call to the extension method `AddDbContext<T>`.</span></span> <span data-ttu-id="081b0-208">En el código siguiente se muestra el registro del tipo `CharacterRepository`.</span><span class="sxs-lookup"><span data-stu-id="081b0-208">The following code shows the registration of the `CharacterRepository` type.</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Startup.cs?highlight=3-5,11&range=16-32)]

<span data-ttu-id="081b0-209">Es necesario agregar contextos de Entity Framework al contenedor de servicios mediante la duración `Scoped`.</span><span class="sxs-lookup"><span data-stu-id="081b0-209">Entity Framework contexts should be added to the services container using the `Scoped` lifetime.</span></span> <span data-ttu-id="081b0-210">Esto se lleva a cabo automáticamente si usa los métodos auxiliares, tal como se ha indicado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="081b0-210">This is taken care of automatically if you use the helper methods as shown above.</span></span> <span data-ttu-id="081b0-211">Los repositorios que vayan a usar Entity Framework deben usar la misma duración.</span><span class="sxs-lookup"><span data-stu-id="081b0-211">Repositories that will make use of Entity Framework should use the same lifetime.</span></span>

> [!WARNING]
> <span data-ttu-id="081b0-212">Debe ser especialmente cauteloso al resolver un servicio `Scoped` desde un singleton.</span><span class="sxs-lookup"><span data-stu-id="081b0-212">The main danger to be wary of is resolving a `Scoped` service from a singleton.</span></span> <span data-ttu-id="081b0-213">Es probable que en este caso el servicio tenga un estado incorrecto al procesar las solicitudes posteriores.</span><span class="sxs-lookup"><span data-stu-id="081b0-213">It's likely in such a case that the service will have incorrect state when processing subsequent requests.</span></span>

<span data-ttu-id="081b0-214">Los servicios que tengan dependencias deben registrarlas en el contenedor.</span><span class="sxs-lookup"><span data-stu-id="081b0-214">Services that have dependencies should register them in the container.</span></span> <span data-ttu-id="081b0-215">Si el constructor de un servicio requiere un primitivo, como `string`, se puede insertar mediante la [configuración](xref:fundamentals/configuration/index) y el [patrón de opciones](xref:fundamentals/configuration/options).</span><span class="sxs-lookup"><span data-stu-id="081b0-215">If a service's constructor requires a primitive, such as a `string`, this can be injected by using [configuration](xref:fundamentals/configuration/index) and the [options pattern](xref:fundamentals/configuration/options).</span></span>

## <a name="service-lifetimes-and-registration-options"></a><span data-ttu-id="081b0-216">Duración de los servicios y opciones de registro</span><span class="sxs-lookup"><span data-stu-id="081b0-216">Service lifetimes and registration options</span></span>

<span data-ttu-id="081b0-217">Los servicios de ASP.NET pueden configurarse con las duraciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="081b0-217">ASP.NET services can be configured with the following lifetimes:</span></span>

<span data-ttu-id="081b0-218">**Transitoria**</span><span class="sxs-lookup"><span data-stu-id="081b0-218">**Transient**</span></span>

<span data-ttu-id="081b0-219">Los servicios de duración transitoria se crean cada vez que solicitan.</span><span class="sxs-lookup"><span data-stu-id="081b0-219">Transient lifetime services are created each time they're requested.</span></span> <span data-ttu-id="081b0-220">Esta duración funciona mejor para servicios sin estado ligeros.</span><span class="sxs-lookup"><span data-stu-id="081b0-220">This lifetime works best for lightweight, stateless services.</span></span>

<span data-ttu-id="081b0-221">**Con ámbito**</span><span class="sxs-lookup"><span data-stu-id="081b0-221">**Scoped**</span></span>

<span data-ttu-id="081b0-222">Los servicios de duración con ámbito se crean una vez por solicitud.</span><span class="sxs-lookup"><span data-stu-id="081b0-222">Scoped lifetime services are created once per request.</span></span>

> [!WARNING]
> <span data-ttu-id="081b0-223">Si usa un servicio con ámbito en un middleware, inserte el servicio en el método `Invoke` o `InvokeAsync`.</span><span class="sxs-lookup"><span data-stu-id="081b0-223">If you're using a scoped service in a middleware, inject the service into the `Invoke` or `InvokeAsync` method.</span></span> <span data-ttu-id="081b0-224">No lo inserte a través de la inserción de constructores, porque ello hace que el servicio se comporte como un singleton.</span><span class="sxs-lookup"><span data-stu-id="081b0-224">Don't inject via constructor injection because it forces the service to behave like a singleton.</span></span>

<span data-ttu-id="081b0-225">**Singleton**</span><span class="sxs-lookup"><span data-stu-id="081b0-225">**Singleton**</span></span>

<span data-ttu-id="081b0-226">Los servicios de duración de singleton se crean la primera vez que se solicitan (o cuando se ejecuta `ConfigureServices` si se especifica ahí una instancia) y todas las solicitudes posteriores usan la misma instancia.</span><span class="sxs-lookup"><span data-stu-id="081b0-226">Singleton lifetime services are created the first time they're requested (or when `ConfigureServices` is run if you specify an instance there) and then every subsequent request will use the same instance.</span></span> <span data-ttu-id="081b0-227">Si la aplicación requiere un comportamiento de singleton, se recomienda permitir que el contenedor de servicios administre la duración del servicio, en lugar de implementar el patrón de diseño de singleton y administrar por sí mismo la duración del objeto en la clase.</span><span class="sxs-lookup"><span data-stu-id="081b0-227">If your application requires singleton behavior, allowing the services container to manage the service's lifetime is recommended instead of implementing the singleton design pattern and managing your object's lifetime in the class yourself.</span></span>

<span data-ttu-id="081b0-228">Los servicios se pueden registrar con el contenedor de varias maneras.</span><span class="sxs-lookup"><span data-stu-id="081b0-228">Services can be registered with the container in several ways.</span></span> <span data-ttu-id="081b0-229">Ya hemos visto cómo registrar una implementación de servicio con un tipo determinado mediante la especificación del tipo concreto que se va a usar.</span><span class="sxs-lookup"><span data-stu-id="081b0-229">We have already seen how to register a service implementation with a given type by specifying the concrete type to use.</span></span> <span data-ttu-id="081b0-230">Además, se puede especificar un generador, que se usará para crear la instancia a petición.</span><span class="sxs-lookup"><span data-stu-id="081b0-230">In addition, a factory can be specified, which will then be used to create the instance on demand.</span></span> <span data-ttu-id="081b0-231">El tercer método consiste en especificar directamente la instancia del tipo que se va a usar, en cuyo caso el contenedor nunca intentará crear una instancia (ni la eliminará).</span><span class="sxs-lookup"><span data-stu-id="081b0-231">The third approach is to directly specify the instance of the type to use, in which case the container will never attempt to create an instance (nor will it dispose of the instance).</span></span>

<span data-ttu-id="081b0-232">Para mostrar la diferencia entre estas duraciones y opciones de registro, imagine una interfaz simple que representa una o varias tareas como una *operación* con un identificador único, `OperationId`.</span><span class="sxs-lookup"><span data-stu-id="081b0-232">To demonstrate the difference between these lifetime and registration options, consider a simple interface that represents one or more tasks as an *operation* with a unique identifier, `OperationId`.</span></span> <span data-ttu-id="081b0-233">Según cómo se configure la duración de este servicio, el contenedor proporcionará las mismas instancias o instancias diferentes del servicio a la clase que lo solicita.</span><span class="sxs-lookup"><span data-stu-id="081b0-233">Depending on how we configure the lifetime for this service, the container will provide either the same or different instances of the service to the requesting class.</span></span> <span data-ttu-id="081b0-234">Para dejar claro qué duración se solicita, crearemos un tipo por opción de duración:</span><span class="sxs-lookup"><span data-stu-id="081b0-234">To make it clear which lifetime is being requested, we will create one type per lifetime option:</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/IOperation.cs?highlight=5-8)]

<span data-ttu-id="081b0-235">Estas interfaces se implementan mediante una sola clase, `Operation`, que acepta un `Guid` en su constructor, o usa un `Guid` nuevo si no se proporciona ninguno.</span><span class="sxs-lookup"><span data-stu-id="081b0-235">We implement these interfaces using a single class, `Operation`, that accepts a `Guid` in its constructor, or uses a new `Guid` if none is provided.</span></span>

<span data-ttu-id="081b0-236">Después, en `ConfigureServices`, se agrega cada tipo al contenedor según su duración con nombre:</span><span class="sxs-lookup"><span data-stu-id="081b0-236">Next, in `ConfigureServices`, each type is added to the container according to its named lifetime:</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Startup.cs?range=26-32)]

<span data-ttu-id="081b0-237">Tenga en cuenta que el servicio `IOperationSingletonInstance` usa una instancia específica con un identificador conocido de `Guid.Empty` para que quede claro cuándo se usa este tipo (su GUID contendrá únicamente ceros).</span><span class="sxs-lookup"><span data-stu-id="081b0-237">Note that the `IOperationSingletonInstance` service is using a specific instance with a known ID of `Guid.Empty` so it will be clear when this type is in use (its Guid will be all zeroes).</span></span> <span data-ttu-id="081b0-238">También hemos registrado un `OperationService` que depende de cada uno de los otros tipos `Operation`, para que quede claro dentro de una solicitud si este servicio obtiene la misma instancia que el controlador o una nueva para cada tipo de operación.</span><span class="sxs-lookup"><span data-stu-id="081b0-238">We have also registered an `OperationService` that depends on each of the other `Operation` types, so that it will be clear within a request whether this service is getting the same instance as the controller, or a new one, for each operation type.</span></span> <span data-ttu-id="081b0-239">Lo único que hace este servicio es exponer sus dependencias como propiedades, para que se puedan mostrar en la vista.</span><span class="sxs-lookup"><span data-stu-id="081b0-239">All this service does is expose its dependencies as properties, so they can be displayed in the view.</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Services/OperationService.cs)]

<span data-ttu-id="081b0-240">Para mostrar a la aplicación las duraciones de los objetos dentro de las solicitudes individuales independientes y entre estas, el ejemplo incluye un `OperationsController` que solicita cada tipo de `IOperation`, así como un `OperationService`.</span><span class="sxs-lookup"><span data-stu-id="081b0-240">To demonstrate the object lifetimes within and between separate individual requests to the application, the sample includes an `OperationsController` that requests each kind of `IOperation` type as well as an `OperationService`.</span></span> <span data-ttu-id="081b0-241">Después, la acción `Index` muestra todos los valores del controlador y del servicio `OperationId`.</span><span class="sxs-lookup"><span data-stu-id="081b0-241">The `Index` action then displays all of the controller's and service's `OperationId` values.</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Controllers/OperationsController.cs)]

<span data-ttu-id="081b0-242">Ahora se realizan dos solicitudes diferentes a esta acción del controlador:</span><span class="sxs-lookup"><span data-stu-id="081b0-242">Now two separate requests are made to this controller action:</span></span>

![Vista de operaciones de la aplicación web del ejemplo de inserción de dependencias en ejecución en Microsoft Edge, donde se muestran los valores de identificación de operación (es decir, los GUID) para las operaciones del controlador y de OperationService de tipo transitorio, con ámbito, singleton e instancia en la primera solicitud.](dependency-injection/_static/lifetimes_request1.png)

![Vista de operaciones en la que se muestran los valores de identificación de operación para una segunda solicitud.](dependency-injection/_static/lifetimes_request2.png)

<span data-ttu-id="081b0-245">Observe cuál de los valores `OperationId` varía dentro de una solicitud y entre solicitudes.</span><span class="sxs-lookup"><span data-stu-id="081b0-245">Observe which of the `OperationId` values vary within a request, and between requests.</span></span>

* <span data-ttu-id="081b0-246">Los objetos *transitorios* son siempre diferentes, ya que se proporciona una nueva instancia a cada controlador y servicio.</span><span class="sxs-lookup"><span data-stu-id="081b0-246">*Transient* objects are always different; a new instance is provided to every controller and every service.</span></span>

* <span data-ttu-id="081b0-247">Los objetos *con ámbito* son iguales dentro de una solicitud, pero varían entre solicitudes.</span><span class="sxs-lookup"><span data-stu-id="081b0-247">*Scoped* objects are the same within a request, but different across different requests</span></span>

* <span data-ttu-id="081b0-248">Los objetos *singleton* son iguales para todos los objetos y solicitudes (independientemente de si se proporciona una instancia en `ConfigureServices`)</span><span class="sxs-lookup"><span data-stu-id="081b0-248">*Singleton* objects are the same for every object and every request (regardless of whether an instance is provided in `ConfigureServices`)</span></span>

## <a name="resolve-a-scoped-service-within-the-application-scope"></a><span data-ttu-id="081b0-249">Resolver un servicio con ámbito dentro del ámbito de la aplicación</span><span class="sxs-lookup"><span data-stu-id="081b0-249">Resolve a scoped service within the application scope</span></span>

<span data-ttu-id="081b0-250">Cree un [IServiceScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescope) con [IServiceScopeFactory.CreateScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory.createscope) para resolver un servicio con ámbito dentro del ámbito de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="081b0-250">Create an [IServiceScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescope) with [IServiceScopeFactory.CreateScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory.createscope) to resolve a scoped service within the app's scope.</span></span> <span data-ttu-id="081b0-251">Este método resulta útil para tener acceso a un servicio con ámbito durante el inicio para realizar tareas de inicialización.</span><span class="sxs-lookup"><span data-stu-id="081b0-251">This approach is useful to access a scoped service at startup to run initialization tasks.</span></span> <span data-ttu-id="081b0-252">En el siguiente ejemplo se indica cómo obtener un contexto para `MyScopedService` en `Program.Main`:</span><span class="sxs-lookup"><span data-stu-id="081b0-252">The following example shows how to obtain a context for the `MyScopedService` in `Program.Main`:</span></span>

```csharp
public static void Main(string[] args)
{
    var host = BuildWebHost(args);

    using (var serviceScope = host.Services.CreateScope())
    {
        var services = serviceScope.ServiceProvider;

        try
        {
            var serviceContext = services.GetRequiredService<MyScopedService>();
            // Use the context here
        }
        catch (Exception ex)
        {
            var logger = services.GetRequiredService<ILogger<Program>>();
            logger.LogError(ex, "An error occurred.");
        }
    }

    host.Run();
}
```

## <a name="scope-validation"></a><span data-ttu-id="081b0-253">Validación del ámbito</span><span class="sxs-lookup"><span data-stu-id="081b0-253">Scope validation</span></span>

<span data-ttu-id="081b0-254">Cuando la aplicación se ejecuta en el entorno de desarrollo de ASP.NET Core 2.0 o posterior, el proveedor de servicios predeterminado realiza comprobaciones para confirmar lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="081b0-254">When the app is running in the Development environment on ASP.NET Core 2.0 or later, the default service provider performs checks to verify that:</span></span>

* <span data-ttu-id="081b0-255">Los servicios con ámbito no se resuelven directa o indirectamente desde el proveedor de servicios raíz.</span><span class="sxs-lookup"><span data-stu-id="081b0-255">Scoped services aren't directly or indirectly resolved from the root service provider.</span></span>
* <span data-ttu-id="081b0-256">Los servicios con ámbito no se insertan directa o indirectamente en singletons.</span><span class="sxs-lookup"><span data-stu-id="081b0-256">Scoped services aren't directly or indirectly injected into singletons.</span></span>

<span data-ttu-id="081b0-257">El proveedor de servicios raíz se crea cuando se llama a [BuildServiceProvider](/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectioncontainerbuilderextensions.buildserviceprovider).</span><span class="sxs-lookup"><span data-stu-id="081b0-257">The root service provider is created when [BuildServiceProvider](/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectioncontainerbuilderextensions.buildserviceprovider) is called.</span></span> <span data-ttu-id="081b0-258">La vigencia del proveedor de servicios raíz es la misma que la de la aplicación o el servidor cuando el proveedor se inicia con la aplicación, y se elimina cuando la aplicación se cierra.</span><span class="sxs-lookup"><span data-stu-id="081b0-258">The root service provider's lifetime corresponds to the app/server's lifetime when the provider starts with the app and is disposed when the app shuts down.</span></span>

<span data-ttu-id="081b0-259">De la eliminación de los servicios con ámbito se encarga el contenedor que los creó.</span><span class="sxs-lookup"><span data-stu-id="081b0-259">Scoped services are disposed by the container that created them.</span></span> <span data-ttu-id="081b0-260">Si un servicio con ámbito se crea en el contenedor raíz, su vigencia sube a la del singleton, ya que solo lo puede eliminar el contenedor raíz cuando la aplicación o el servidor se cierran.</span><span class="sxs-lookup"><span data-stu-id="081b0-260">If a scoped service is created in the root container, the service's lifetime is effectively promoted to singleton because it's only disposed by the root container when app/server is shut down.</span></span> <span data-ttu-id="081b0-261">Al validar los ámbitos de servicio, este tipo de situaciones se detectan cuando se llama a `BuildServiceProvider`.</span><span class="sxs-lookup"><span data-stu-id="081b0-261">Validating service scopes catches these situations when `BuildServiceProvider` is called.</span></span>

<span data-ttu-id="081b0-262">Para obtener más información, vea [Validación del ámbito en el tema de host web](xref:fundamentals/host/web-host#scope-validation).</span><span class="sxs-lookup"><span data-stu-id="081b0-262">For more information, see [Scope validation in the Web Host topic](xref:fundamentals/host/web-host#scope-validation).</span></span>

## <a name="request-services"></a><span data-ttu-id="081b0-263">Servicios de solicitud</span><span class="sxs-lookup"><span data-stu-id="081b0-263">Request Services</span></span>

<span data-ttu-id="081b0-264">Los servicios disponibles en una solicitud de ASP.NET desde `HttpContext` se exponen mediante la colección `RequestServices`.</span><span class="sxs-lookup"><span data-stu-id="081b0-264">The services available within an ASP.NET request from `HttpContext` are exposed through the `RequestServices` collection.</span></span>

![Cuadro de diálogo contextual de Intellisense de los servicios de solicitud HttpContext en el que se muestra que los servicios de solicitud obtienen o establecen el IServiceProvider que proporciona acceso al contenedor de servicios de la solicitud.](dependency-injection/_static/request-services.png)

<span data-ttu-id="081b0-266">Los servicios de solicitud representan los servicios que se configuran y se solicitan como parte de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="081b0-266">Request Services represent the services you configure and request as part of your application.</span></span> <span data-ttu-id="081b0-267">Cuando los objetos especifican dependencias, estas se cumplen mediante los tipos que se encuentran en `RequestServices`, no en `ApplicationServices`.</span><span class="sxs-lookup"><span data-stu-id="081b0-267">When your objects specify dependencies, these are satisfied by the types found in `RequestServices`, not `ApplicationServices`.</span></span>

<span data-ttu-id="081b0-268">Por lo general, no debe usar estas propiedades directamente. Se recomienda que solicite los tipos que las clases necesitan mediante el constructor de la clase y que deje que el marco de trabajo inserte estas dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-268">Generally, you shouldn't use these properties directly, preferring instead to request the types your classes you require via your class's constructor, and letting the framework inject these dependencies.</span></span> <span data-ttu-id="081b0-269">Esto da como resultado clases más fáciles de probar (vea [Pruebas y depuración](xref:test/index)) y acopladas de manera más flexible.</span><span class="sxs-lookup"><span data-stu-id="081b0-269">This yields classes that are easier to test (see [Test and debug](xref:test/index)) and are more loosely coupled.</span></span>

> [!NOTE]
> <span data-ttu-id="081b0-270">Se recomienda que solicite las dependencias como parámetros del constructor para obtener acceso a la colección `RequestServices`.</span><span class="sxs-lookup"><span data-stu-id="081b0-270">Prefer requesting dependencies as constructor parameters to accessing the `RequestServices` collection.</span></span>

## <a name="designing-services-for-dependency-injection"></a><span data-ttu-id="081b0-271">Diseño de servicios para la inserción de dependencias</span><span class="sxs-lookup"><span data-stu-id="081b0-271">Designing services for dependency injection</span></span>

<span data-ttu-id="081b0-272">Debe diseñar los servicios de modo que usen la inserción de dependencias para obtener sus colaboradores.</span><span class="sxs-lookup"><span data-stu-id="081b0-272">You should design your services to use dependency injection to get their collaborators.</span></span> <span data-ttu-id="081b0-273">Esto significa que debe evitar el uso de llamadas a métodos estáticos con estado (lo que ocasiona un problema en el código denominado [adhesión estática](http://deviq.com/static-cling/)) y la creación de instancias directa de clases dependientes dentro de los servicios.</span><span class="sxs-lookup"><span data-stu-id="081b0-273">This means avoiding the use of stateful static method calls (which result in a code smell known as [static cling](http://deviq.com/static-cling/)) and the direct instantiation of dependent classes within your services.</span></span> <span data-ttu-id="081b0-274">Puede resultarle útil recordar la frase "[lo nuevo se pega](https://ardalis.com/new-is-glue)" al decidir si va a crear una instancia de un tipo o solicitarlo mediante la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-274">It may help to remember the phrase, [New is Glue](https://ardalis.com/new-is-glue), when choosing whether to instantiate a type or to request it via dependency injection.</span></span> <span data-ttu-id="081b0-275">Si sigue los [principios SOLID del diseño orientado a objetos](http://deviq.com/solid/), las clases tenderán de forma natural a ser pequeñas, estarán correctamente factorizadas y podrán probarse fácilmente.</span><span class="sxs-lookup"><span data-stu-id="081b0-275">By following the [SOLID Principles of Object Oriented Design](http://deviq.com/solid/), your classes will naturally tend to be small, well-factored, and easily tested.</span></span>

<span data-ttu-id="081b0-276">¿Qué ocurre si descubre que en sus clases suelen insertarse demasiadas dependencias?</span><span class="sxs-lookup"><span data-stu-id="081b0-276">What if you find that your classes tend to have way too many dependencies being injected?</span></span> <span data-ttu-id="081b0-277">Esto suele indicar que la clase intenta realizar demasiadas acciones y que probablemente infringe el [principio de responsabilidad única](http://deviq.com/single-responsibility-principle/) (SRP).</span><span class="sxs-lookup"><span data-stu-id="081b0-277">This is generally a sign that your class is trying to do too much, and is probably violating SRP - the [Single Responsibility Principle](http://deviq.com/single-responsibility-principle/).</span></span> <span data-ttu-id="081b0-278">Mueva algunas de las responsabilidades de la clase a una nueva para intentar refactorizarla.</span><span class="sxs-lookup"><span data-stu-id="081b0-278">See if you can refactor the class by moving some of its responsibilities into a new class.</span></span> <span data-ttu-id="081b0-279">Tenga en cuenta que las clases `Controller` deben centrarse en aspectos de la interfaz de usuario, por lo que los detalles de implementación de las reglas de negocio y del acceso a datos se deben mantener en las clases pertinentes para [cada uno de estos aspectos](http://deviq.com/separation-of-concerns/).</span><span class="sxs-lookup"><span data-stu-id="081b0-279">Keep in mind that your `Controller` classes should be focused on UI concerns, so business rules and data access implementation details should be kept in classes appropriate to these [separate concerns](http://deviq.com/separation-of-concerns/).</span></span>

<span data-ttu-id="081b0-280">En lo que respecta al acceso a datos en concreto, puede insertar `DbContext` en los controladores (siempre y cuando haya agregado EF al contenedor de servicios en `ConfigureServices`).</span><span class="sxs-lookup"><span data-stu-id="081b0-280">With regards to data access specifically, you can inject the `DbContext` into your controllers (assuming you've added EF to the services container in `ConfigureServices`).</span></span> <span data-ttu-id="081b0-281">Algunos desarrolladores prefieren usar una interfaz de repositorio para la base de datos en lugar de insertar `DbContext` directamente.</span><span class="sxs-lookup"><span data-stu-id="081b0-281">Some developers prefer to use a repository interface to the database rather than injecting the `DbContext` directly.</span></span> <span data-ttu-id="081b0-282">Si usa una interfaz para encapsular la lógica de acceso a datos en un solo lugar, puede minimizar el número de lugares que tendrá que cambiar cuando cambie la base de datos.</span><span class="sxs-lookup"><span data-stu-id="081b0-282">Using an interface to encapsulate the data access logic in one place can minimize how many places you will have to change when your database changes.</span></span>

### <a name="disposing-of-services"></a><span data-ttu-id="081b0-283">Eliminación de servicios</span><span class="sxs-lookup"><span data-stu-id="081b0-283">Disposing of services</span></span>

<span data-ttu-id="081b0-284">El contenedor llamará a `Dispose` para los tipos `IDisposable` que cree.</span><span class="sxs-lookup"><span data-stu-id="081b0-284">The container will call `Dispose` for `IDisposable` types it creates.</span></span> <span data-ttu-id="081b0-285">A pesar de todo, si agrega usted mismo una instancia al contenedor, no se eliminará.</span><span class="sxs-lookup"><span data-stu-id="081b0-285">However, if you add an instance to the container yourself, it will not be disposed.</span></span>

<span data-ttu-id="081b0-286">Ejemplo:</span><span class="sxs-lookup"><span data-stu-id="081b0-286">Example:</span></span>

```csharp
// Services implement IDisposable:
public class Service1 : IDisposable {}
public class Service2 : IDisposable {}
public class Service3 : IDisposable {}

public interface ISomeService {}
public class SomeServiceImplementation : ISomeService, IDisposable {}


public void ConfigureServices(IServiceCollection services)
{
    // container will create the instance(s) of these types and will dispose them
    services.AddScoped<Service1>();
    services.AddSingleton<Service2>();
    services.AddSingleton<ISomeService>(sp => new SomeServiceImplementation());

    // container didn't create instance so it will NOT dispose it
    services.AddSingleton<Service3>(new Service3());
    services.AddSingleton(new Service3());
}
```

> [!NOTE]
> <span data-ttu-id="081b0-287">En la versión 1.0, el contenedor llamaba a Dispose en *todos* los objetos `IDisposable`, incluidos aquellos que no había creado.</span><span class="sxs-lookup"><span data-stu-id="081b0-287">In version 1.0, the container called dispose on *all* `IDisposable` objects, including those it didn't create.</span></span>

## <a name="replacing-the-default-services-container"></a><span data-ttu-id="081b0-288">Reemplazo del contenedor de servicios predeterminado</span><span class="sxs-lookup"><span data-stu-id="081b0-288">Replacing the default services container</span></span>

<span data-ttu-id="081b0-289">El contenedor de servicios integrado está pensado para atender las necesidades básicas del marco de trabajo y de la mayoría de las aplicaciones de consumidor compiladas en él.</span><span class="sxs-lookup"><span data-stu-id="081b0-289">The built-in services container is meant to serve the basic needs of the framework and most consumer applications built on it.</span></span> <span data-ttu-id="081b0-290">Aun así, los desarrolladores pueden reemplazar el contenedor integrado por su contenedor preferido.</span><span class="sxs-lookup"><span data-stu-id="081b0-290">However, developers can replace the built-in container with their preferred container.</span></span> <span data-ttu-id="081b0-291">El método `ConfigureServices` suele devolver `void`, pero si se cambia su firma para que devuelva `IServiceProvider`, se puede configurar y devolver un contenedor diferente.</span><span class="sxs-lookup"><span data-stu-id="081b0-291">The `ConfigureServices` method typically returns `void`, but if its signature is changed to return `IServiceProvider`, a different container can be configured and returned.</span></span> <span data-ttu-id="081b0-292">Hay muchos contenedores de IoC disponibles para .NET.</span><span class="sxs-lookup"><span data-stu-id="081b0-292">There are many IOC containers available for .NET.</span></span> <span data-ttu-id="081b0-293">En este ejemplo, se usa el paquete [Autofac](https://autofac.org/).</span><span class="sxs-lookup"><span data-stu-id="081b0-293">In this example, the [Autofac](https://autofac.org/) package is used.</span></span>

<span data-ttu-id="081b0-294">En primer lugar, instale los paquetes de contenedor adecuados:</span><span class="sxs-lookup"><span data-stu-id="081b0-294">First, install the appropriate container package(s):</span></span>

* `Autofac`
* `Autofac.Extensions.DependencyInjection`

<span data-ttu-id="081b0-295">Después, configure el contenedor en `ConfigureServices` y devuelva un `IServiceProvider`:</span><span class="sxs-lookup"><span data-stu-id="081b0-295">Next, configure the container in `ConfigureServices` and return an `IServiceProvider`:</span></span>

```csharp
public IServiceProvider ConfigureServices(IServiceCollection services)
{
    services.AddMvc();
    // Add other framework services

    // Add Autofac
    var containerBuilder = new ContainerBuilder();
    containerBuilder.RegisterModule<DefaultModule>();
    containerBuilder.Populate(services);
    var container = containerBuilder.Build();
    return new AutofacServiceProvider(container);
}
```

> [!NOTE]
> <span data-ttu-id="081b0-296">Cuando se usa un contenedor de inserción de dependencias de terceros, debe cambiar `ConfigureServices` para que devuelva `IServiceProvider` en lugar de `void`.</span><span class="sxs-lookup"><span data-stu-id="081b0-296">When using a third-party DI container, you must change `ConfigureServices` so that it returns `IServiceProvider` instead of `void`.</span></span>

<span data-ttu-id="081b0-297">Por último, configure Autofac de la forma habitual en `DefaultModule`:</span><span class="sxs-lookup"><span data-stu-id="081b0-297">Finally, configure Autofac as normal in `DefaultModule`:</span></span>

```csharp
public class DefaultModule : Module
{
    protected override void Load(ContainerBuilder builder)
    {
        builder.RegisterType<CharacterRepository>().As<ICharacterRepository>();
    }
}
```

<span data-ttu-id="081b0-298">En tiempo de ejecución, se usará Autofac para resolver tipos e insertar dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-298">At runtime, Autofac will be used to resolve types and inject dependencies.</span></span> <span data-ttu-id="081b0-299">[Más información sobre el uso de Autofac y ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span><span class="sxs-lookup"><span data-stu-id="081b0-299">[Learn more about using Autofac and ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span></span>

### <a name="thread-safety"></a><span data-ttu-id="081b0-300">Seguridad para subprocesos</span><span class="sxs-lookup"><span data-stu-id="081b0-300">Thread safety</span></span>

<span data-ttu-id="081b0-301">Los servicios de singleton deben ser seguros para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="081b0-301">Singleton services need to be thread safe.</span></span> <span data-ttu-id="081b0-302">Si un servicio de singleton tiene una dependencia en un servicio transitorio, es posible que este también deba ser seguro para subprocesos, según cómo lo use el singleton.</span><span class="sxs-lookup"><span data-stu-id="081b0-302">If a singleton service has a dependency on a transient service, the transient service may also need to be thread safe depending how it's used by the singleton.</span></span>

## <a name="recommendations"></a><span data-ttu-id="081b0-303">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="081b0-303">Recommendations</span></span>

<span data-ttu-id="081b0-304">Cuando trabaje con la inserción de dependencias, tenga en cuenta las recomendaciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="081b0-304">When working with dependency injection, keep the following recommendations in mind:</span></span>

* <span data-ttu-id="081b0-305">La inserción de dependencias está destinada a objetos que tienen dependencias complejas.</span><span class="sxs-lookup"><span data-stu-id="081b0-305">DI is for objects that have complex dependencies.</span></span> <span data-ttu-id="081b0-306">Los controladores, los servicios, los adaptadores y los repositorios son ejemplos de objetos que podrían agregarse a la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-306">Controllers, services, adapters, and repositories are all examples of objects that might be added to DI.</span></span>

* <span data-ttu-id="081b0-307">Evite almacenar datos y configuraciones directamente en la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="081b0-307">Avoid storing data and configuration directly in DI.</span></span> <span data-ttu-id="081b0-308">Por ejemplo, el carro de la compra de un usuario no debería agregarse al contenedor de servicios.</span><span class="sxs-lookup"><span data-stu-id="081b0-308">For example, a user's shopping cart shouldn't typically be added to the services container.</span></span> <span data-ttu-id="081b0-309">La configuración debe usar el [patrón de opciones](xref:fundamentals/configuration/options).</span><span class="sxs-lookup"><span data-stu-id="081b0-309">Configuration should use the [options pattern](xref:fundamentals/configuration/options).</span></span> <span data-ttu-id="081b0-310">Del mismo modo, evite los objetos de tipo "contenedor de datos" que solo existen para permitir el acceso a otro objeto.</span><span class="sxs-lookup"><span data-stu-id="081b0-310">Similarly, avoid "data holder" objects that only exist to allow access to some other object.</span></span> <span data-ttu-id="081b0-311">Es mejor solicitar el elemento real que se necesita mediante la inserción de dependencias, si es posible.</span><span class="sxs-lookup"><span data-stu-id="081b0-311">It's better to request the actual item needed via DI, if possible.</span></span>

* <span data-ttu-id="081b0-312">Evite el acceso estático a los servicios.</span><span class="sxs-lookup"><span data-stu-id="081b0-312">Avoid static access to services.</span></span>

* <span data-ttu-id="081b0-313">Evite la ubicación de servicios en el código de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="081b0-313">Avoid service location in your application code.</span></span>

* <span data-ttu-id="081b0-314">Evite el acceso estático a `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="081b0-314">Avoid static access to `HttpContext`.</span></span>

<span data-ttu-id="081b0-315">Al igual que sucede con todas las recomendaciones, podría verse en una situación que le obligue a ignorar alguna de ellas.</span><span class="sxs-lookup"><span data-stu-id="081b0-315">Like all sets of recommendations, you may encounter situations where ignoring one is required.</span></span> <span data-ttu-id="081b0-316">Por lo que sabemos las excepciones son muy poco frecuentes, ya que suelen ser casos muy especiales del propio marco de trabajo.</span><span class="sxs-lookup"><span data-stu-id="081b0-316">We have found exceptions to be rare -- mostly very special cases within the framework itself.</span></span>

<span data-ttu-id="081b0-317">La inserción de dependencias es una *alternativa* al uso de patrones de acceso a objetos estáticos o globales.</span><span class="sxs-lookup"><span data-stu-id="081b0-317">Dependency injection is an *alternative* to static/global object access patterns.</span></span> <span data-ttu-id="081b0-318">No podrá aprovechar las ventajas de la inserción de dependencias si la combina con el acceso a objetos estáticos.</span><span class="sxs-lookup"><span data-stu-id="081b0-318">You may not be able to realize the benefits of DI if you mix it with static object access.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="081b0-319">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="081b0-319">Additional resources</span></span>

* [<span data-ttu-id="081b0-320">Inserción de dependencias en vistas</span><span class="sxs-lookup"><span data-stu-id="081b0-320">Dependency injection into views</span></span>](xref:mvc/views/dependency-injection)
* [<span data-ttu-id="081b0-321">Inserción de dependencias en controladores</span><span class="sxs-lookup"><span data-stu-id="081b0-321">Dependency injection into controllers</span></span>](xref:mvc/controllers/dependency-injection)
* [<span data-ttu-id="081b0-322">Inserción de dependencias en controladores de requisitos</span><span class="sxs-lookup"><span data-stu-id="081b0-322">Dependency injection in requirement handlers</span></span>](xref:security/authorization/dependencyinjection)
* [<span data-ttu-id="081b0-323">Inicio de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="081b0-323">Application Startup</span></span>](xref:fundamentals/startup)
* [<span data-ttu-id="081b0-324">Prueba y depuración</span><span class="sxs-lookup"><span data-stu-id="081b0-324">Test and debug</span></span>](xref:test/index)
* <span data-ttu-id="081b0-325">[Factory-based middleware activation](xref:fundamentals/middleware/extensibility) (Activación de middleware basada en Factory)</span><span class="sxs-lookup"><span data-stu-id="081b0-325">[Factory-based middleware activation](xref:fundamentals/middleware/extensibility)</span></span>
* [<span data-ttu-id="081b0-326">Escritura de código limpio en ASP.NET Core con inserción de dependencias (MSDN)</span><span class="sxs-lookup"><span data-stu-id="081b0-326">Writing Clean Code in ASP.NET Core with Dependency Injection (MSDN)</span></span>](https://msdn.microsoft.com/magazine/mt703433.aspx)
* [<span data-ttu-id="081b0-327">Preludio del diseño de aplicaciones administradas por contenedor: ¿cuál es el lugar del contenedor?</span><span class="sxs-lookup"><span data-stu-id="081b0-327">Container-Managed Application Design, Prelude: Where does the Container Belong?</span></span>](https://blogs.msdn.microsoft.com/nblumhardt/2008/12/26/container-managed-application-design-prelude-where-does-the-container-belong/)
* [<span data-ttu-id="081b0-328">Principio de dependencias explícitas</span><span class="sxs-lookup"><span data-stu-id="081b0-328">Explicit Dependencies Principle</span></span>](http://deviq.com/explicit-dependencies-principle/)
* <span data-ttu-id="081b0-329">[Los contenedores de inversión de control y el patrón de inserción de dependencias](https://www.martinfowler.com/articles/injection.html) (Fowler)</span><span class="sxs-lookup"><span data-stu-id="081b0-329">[Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html) (Fowler)</span></span>
