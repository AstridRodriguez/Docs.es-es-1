---
title: "Inyección de dependencia en el núcleo de ASP.NET"
author: ardalis
description: "Obtenga información acerca de cómo ASP.NET Core implementa inyección de dependencia y cómo utilizarlo."
keywords: "Núcleo de ASP.NET, la inserción de dependencias, di"
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.assetid: fccd69be-7ad1-47fb-b203-b3633b6b9a9b
ms.technology: aspnet
ms.prod: asp.net-core
uid: fundamentals/dependency-injection
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: a3a6f755d8825d4bd31cad4e459750c549709c6d
ms.sourcegitcommit: 8f4d4fad1ca27adf9e396f5c205c9875a3963664
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/13/2017
---
# <a name="introduction-to-dependency-injection-in-aspnet-core"></a><span data-ttu-id="88452-104">Introducción a la inyección de dependencia en el núcleo de ASP.NET</span><span class="sxs-lookup"><span data-stu-id="88452-104">Introduction to Dependency Injection in ASP.NET Core</span></span>

<a name="fundamentals-dependency-injection"></a>

<span data-ttu-id="88452-105">Por [Steve Smith](https://ardalis.com/) y [Scott Addie](https://scottaddie.com)</span><span class="sxs-lookup"><span data-stu-id="88452-105">By [Steve Smith](https://ardalis.com/) and [Scott Addie](https://scottaddie.com)</span></span>

<span data-ttu-id="88452-106">ASP.NET Core está diseñado desde el principio para admitir y aprovechar la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="88452-106">ASP.NET Core is designed from the ground up to support and leverage dependency injection.</span></span> <span data-ttu-id="88452-107">Las aplicaciones principales de ASP.NET pueden aprovechar los servicios de marco integrado por indica que existen insertado en métodos de la clase de inicio y los servicios de aplicaciones pueden configurarse para la inyección de así.</span><span class="sxs-lookup"><span data-stu-id="88452-107">ASP.NET Core applications can leverage built-in framework services by having them injected into methods in the Startup class, and application services can be configured for injection as well.</span></span> <span data-ttu-id="88452-108">El contenedor de servicios predeterminado proporcionado por ASP.NET Core proporciona una característica mínimo establecido y no está diseñada para reemplazar otros contenedores.</span><span class="sxs-lookup"><span data-stu-id="88452-108">The default services container provided by ASP.NET Core provides a minimal feature set and is not intended to replace other containers.</span></span>

<span data-ttu-id="88452-109">[Vea o descargue el código de ejemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([cómo descargarlo](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="88452-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="what-is-dependency-injection"></a><span data-ttu-id="88452-110">¿Qué es la inyección de dependencia?</span><span class="sxs-lookup"><span data-stu-id="88452-110">What is Dependency Injection?</span></span>

<span data-ttu-id="88452-111">Inserción de dependencias (DI) es una técnica para lograr el acoplamiento flexible entre los objetos y sus colaboradores o dependencias.</span><span class="sxs-lookup"><span data-stu-id="88452-111">Dependency injection (DI) is a technique for achieving loose coupling between objects and their collaborators, or dependencies.</span></span> <span data-ttu-id="88452-112">En lugar de crear directamente instancias de colaboradores, o mediante las referencias estáticas, se proporcionan los objetos de una clase que se necesita para llevar a cabo sus acciones a la clase de algún modo.</span><span class="sxs-lookup"><span data-stu-id="88452-112">Rather than directly instantiating collaborators, or using static references, the objects a class needs in order to perform its actions are provided to the class in some fashion.</span></span> <span data-ttu-id="88452-113">A menudo, las clases declarará sus dependencias a través de su constructor, lo que les permite seguir el [principio de dependencias explícitas](http://deviq.com/explicit-dependencies-principle/).</span><span class="sxs-lookup"><span data-stu-id="88452-113">Most often, classes will declare their dependencies via their constructor, allowing them to follow the [Explicit Dependencies Principle](http://deviq.com/explicit-dependencies-principle/).</span></span> <span data-ttu-id="88452-114">Este enfoque se conoce como "inyección de constructor".</span><span class="sxs-lookup"><span data-stu-id="88452-114">This approach is known as "constructor injection".</span></span>

<span data-ttu-id="88452-115">Cuando las clases se diseñan con DI en mente, se acopla más flexible porque no tienen dependencias directas, codificado de forma rígida en sus colaboradores.</span><span class="sxs-lookup"><span data-stu-id="88452-115">When classes are designed with DI in mind, they are more loosely coupled because they do not have direct, hard-coded dependencies on their collaborators.</span></span> <span data-ttu-id="88452-116">Esto se sigue la [principio de inversión de dependencia](http://deviq.com/dependency-inversion-principle/), que indica que *"módulos de nivel alto no deben depender de los módulos de nivel inferiores; ambos deben depender de abstracciones."*</span><span class="sxs-lookup"><span data-stu-id="88452-116">This follows the [Dependency Inversion Principle](http://deviq.com/dependency-inversion-principle/), which states that *"high level modules should not depend on low level modules; both should depend on abstractions."*</span></span> <span data-ttu-id="88452-117">En lugar de hacer referencia a las implementaciones específicas, las clases de solicitud abstracciones (normalmente `interfaces`) que se proporcionan para ellos cuando se construye la clase.</span><span class="sxs-lookup"><span data-stu-id="88452-117">Instead of referencing specific implementations, classes request abstractions (typically `interfaces`) which are provided to them when the class is constructed.</span></span> <span data-ttu-id="88452-118">Extracción de dependencias en interfaces y proporciona las implementaciones de estas interfaces como parámetros también son un ejemplo de la [modelo de diseño de la estrategia](http://deviq.com/strategy-design-pattern/).</span><span class="sxs-lookup"><span data-stu-id="88452-118">Extracting dependencies into interfaces and providing implementations of these interfaces as parameters is also an example of the [Strategy design pattern](http://deviq.com/strategy-design-pattern/).</span></span>

<span data-ttu-id="88452-119">Cuando un sistema está diseñado para utilizar DI, con muchas clases solicitar sus dependencias a través de su constructor (o propiedades), resulta útil tener una clase dedicada a la creación de estas clases con sus dependencias asociadas.</span><span class="sxs-lookup"><span data-stu-id="88452-119">When a system is designed to use DI, with many classes requesting their dependencies via their constructor (or properties), it's helpful to have a class dedicated to creating these classes with their associated dependencies.</span></span> <span data-ttu-id="88452-120">Estas clases se conocen como *contenedores*, o más específicamente, [inversión de Control (IoC)](http://deviq.com/inversion-of-control/) contenedores o contenedores de inyección de dependencia (DI).</span><span class="sxs-lookup"><span data-stu-id="88452-120">These classes are referred to as *containers*, or more specifically, [Inversion of Control (IoC)](http://deviq.com/inversion-of-control/) containers or Dependency Injection (DI) containers.</span></span> <span data-ttu-id="88452-121">Un contenedor es básicamente un generador que se encarga de proporcionar instancias de tipos que se solicitan desde él.</span><span class="sxs-lookup"><span data-stu-id="88452-121">A container is essentially a factory that is responsible for providing instances of types that are requested from it.</span></span> <span data-ttu-id="88452-122">Si ha declarado un tipo determinado que tiene dependencias, y el contenedor se ha configurado para proporcionar los tipos de dependencia, creará las dependencias como parte de la creación de la instancia solicitada.</span><span class="sxs-lookup"><span data-stu-id="88452-122">If a given type has declared that it has dependencies, and the container has been configured to provide the dependency types, it will create the dependencies as part of creating the requested instance.</span></span> <span data-ttu-id="88452-123">De esta manera, gráficos de dependencias complejos pueden proporcionarse a clases sin necesidad de ninguna construcción de objetos codificados de forma rígida.</span><span class="sxs-lookup"><span data-stu-id="88452-123">In this way, complex dependency graphs can be provided to classes without the need for any hard-coded object construction.</span></span> <span data-ttu-id="88452-124">Además de crear objetos con sus dependencias, contenedores suelen administran la duración de los objetos dentro de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="88452-124">In addition to creating objects with their dependencies, containers typically manage object lifetimes within the application.</span></span>

<span data-ttu-id="88452-125">ASP.NET Core incluye un simple contenedor integrado (representado por la `IServiceProvider` interfaz) que admite la inserción del constructor de forma predeterminada y ASP.NET pone a disposición a través de DI determinados servicios.</span><span class="sxs-lookup"><span data-stu-id="88452-125">ASP.NET Core includes a simple built-in container (represented by the `IServiceProvider` interface) that supports constructor injection by default, and ASP.NET makes certain services available through DI.</span></span> <span data-ttu-id="88452-126">ASP. Contenedor de red hace referencia a los tipos que administra como *services*.</span><span class="sxs-lookup"><span data-stu-id="88452-126">ASP.NET's container refers to the types it manages as *services*.</span></span> <span data-ttu-id="88452-127">En el resto de este artículo, *servicios* hará referencia a tipos que están administrados por el contenedor de IoC del núcleo de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="88452-127">Throughout the rest of this article, *services* will refer to types that are managed by ASP.NET Core's IoC container.</span></span> <span data-ttu-id="88452-128">Configurar los servicios del contenedor integrados en el `ConfigureServices` método de la aplicación `Startup` clase.</span><span class="sxs-lookup"><span data-stu-id="88452-128">You configure the built-in container's services in the `ConfigureServices` method in your application's `Startup` class.</span></span>

> [!NOTE]
> <span data-ttu-id="88452-129">Martin Fowler ha escrito un artículo de una amplia en [contenedores de inversión de Control y el patrón de inyección de dependencia](https://www.martinfowler.com/articles/injection.html).</span><span class="sxs-lookup"><span data-stu-id="88452-129">Martin Fowler has written an extensive article on [Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html).</span></span> <span data-ttu-id="88452-130">Microsoft Patterns and Practices también tiene una descripción excelente de [inyección de dependencia](https://msdn.microsoft.com/library/hh323705.aspx).</span><span class="sxs-lookup"><span data-stu-id="88452-130">Microsoft Patterns and Practices also has a great description of [Dependency Injection](https://msdn.microsoft.com/library/hh323705.aspx).</span></span>

> [!NOTE]
> <span data-ttu-id="88452-131">Este artículo tratan inyección de dependencia tal como se aplica a todas las aplicaciones de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="88452-131">This article covers Dependency Injection as it applies to all ASP.NET applications.</span></span> <span data-ttu-id="88452-132">Inyección de dependencia dentro de los controladores de MVC se trata en [controladores e inserción de dependencias](../mvc/controllers/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="88452-132">Dependency Injection within MVC controllers is covered in [Dependency Injection and Controllers](../mvc/controllers/dependency-injection.md).</span></span>

### <a name="constructor-injection-behavior"></a><span data-ttu-id="88452-133">Comportamiento de inyección de constructor</span><span class="sxs-lookup"><span data-stu-id="88452-133">Constructor Injection Behavior</span></span>

<span data-ttu-id="88452-134">Inyección de constructor requiere que el constructor en cuestión sea *público*.</span><span class="sxs-lookup"><span data-stu-id="88452-134">Constructor injection requires that the constructor in question be *public*.</span></span> <span data-ttu-id="88452-135">En caso contrario, la aplicación producirá una `InvalidOperationException`:</span><span class="sxs-lookup"><span data-stu-id="88452-135">Otherwise, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="88452-136">No se pudo encontrar un constructor adecuado para el tipo 'YourType'.</span><span class="sxs-lookup"><span data-stu-id="88452-136">A suitable constructor for type 'YourType' could not be located.</span></span> <span data-ttu-id="88452-137">Asegúrese del tipo es concreto y los servicios se registran para todos los parámetros de un constructor público.</span><span class="sxs-lookup"><span data-stu-id="88452-137">Ensure the type is concrete and services are registered for all parameters of a public constructor.</span></span>


<span data-ttu-id="88452-138">Inyección de constructor requiere existe este solo constructor es aplicable.</span><span class="sxs-lookup"><span data-stu-id="88452-138">Constructor injection requires that only one applicable constructor exist.</span></span> <span data-ttu-id="88452-139">Se admiten las sobrecargas de constructor, pero solo una sobrecarga puede existir cuyos argumentos pueden cumplirse por inyección de dependencia.</span><span class="sxs-lookup"><span data-stu-id="88452-139">Constructor overloads are supported, but only one overload can exist whose arguments can all be fulfilled by dependency injection.</span></span> <span data-ttu-id="88452-140">Si existe más de uno, la aplicación producirá una `InvalidOperationException`:</span><span class="sxs-lookup"><span data-stu-id="88452-140">If more than one exists, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="88452-141">Se han encontrado varios constructores que acepta todos los tipos de argumento especificado en el tipo 'YourType'.</span><span class="sxs-lookup"><span data-stu-id="88452-141">Multiple constructors accepting all given argument types have been found in type 'YourType'.</span></span> <span data-ttu-id="88452-142">Solo debe haber un constructor es aplicable.</span><span class="sxs-lookup"><span data-stu-id="88452-142">There should only be one applicable constructor.</span></span>

<span data-ttu-id="88452-143">Los constructores pueden aceptar argumentos que no proceden de inserción de dependencias, pero éstas deben admitir valores predeterminados.</span><span class="sxs-lookup"><span data-stu-id="88452-143">Constructors can accept arguments that are not provided by dependency injection, but these must support default values.</span></span> <span data-ttu-id="88452-144">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="88452-144">For example:</span></span>

```csharp
// throws InvalidOperationException: Unable to resolve service for type 'System.String'...
public CharactersController(ICharacterRepository characterRepository, string title)
{
    _characterRepository = characterRepository;
    _title = title;
}

// runs without error
public CharactersController(ICharacterRepository characterRepository, string title = "Characters")
{
    _characterRepository = characterRepository;
    _title = title;
}
```

## <a name="using-framework-provided-services"></a><span data-ttu-id="88452-145">Uso de los servicios proporcionados por el marco de trabajo</span><span class="sxs-lookup"><span data-stu-id="88452-145">Using Framework-Provided Services</span></span>

<span data-ttu-id="88452-146">El `ConfigureServices` método en la `Startup` clase es responsable de definir los servicios que se va a utilizar la aplicación, incluidas las características de plataforma como Entity Framework Core y ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="88452-146">The `ConfigureServices` method in the `Startup` class is responsible for defining the services the application will use, including platform features like Entity Framework Core and ASP.NET Core MVC.</span></span> <span data-ttu-id="88452-147">Inicialmente, el `IServiceCollection` proporcionadas para `ConfigureServices` tiene los siguientes servicios definidos (en función de [cómo se configurara el host](xref:fundamentals/hosting)):</span><span class="sxs-lookup"><span data-stu-id="88452-147">Initially, the `IServiceCollection` provided to `ConfigureServices` has the following services defined (depending on [how the host was configured](xref:fundamentals/hosting)):</span></span>

| <span data-ttu-id="88452-148">Tipo de servicio</span><span class="sxs-lookup"><span data-stu-id="88452-148">Service Type</span></span> | <span data-ttu-id="88452-149">Período de duración</span><span class="sxs-lookup"><span data-stu-id="88452-149">Lifetime</span></span> |
| ----- | ------- |
| [<span data-ttu-id="88452-150">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span><span class="sxs-lookup"><span data-stu-id="88452-150">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.ihostingenvironment) | <span data-ttu-id="88452-151">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-151">Singleton</span></span> |
| [<span data-ttu-id="88452-152">Microsoft.Extensions.Logging.ILoggerFactory</span><span class="sxs-lookup"><span data-stu-id="88452-152">Microsoft.Extensions.Logging.ILoggerFactory</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.logging.iloggerfactory) | <span data-ttu-id="88452-153">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-153">Singleton</span></span> |
| [<span data-ttu-id="88452-154">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="88452-154">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.logging.ilogger) | <span data-ttu-id="88452-155">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-155">Singleton</span></span> |
| [<span data-ttu-id="88452-156">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span><span class="sxs-lookup"><span data-stu-id="88452-156">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.builder.iapplicationbuilderfactory) | <span data-ttu-id="88452-157">Transitorio</span><span class="sxs-lookup"><span data-stu-id="88452-157">Transient</span></span> |
| [<span data-ttu-id="88452-158">Microsoft.AspNetCore.Http.IHttpContextFactory</span><span class="sxs-lookup"><span data-stu-id="88452-158">Microsoft.AspNetCore.Http.IHttpContextFactory</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.http.ihttpcontextfactory) | <span data-ttu-id="88452-159">Transitorio</span><span class="sxs-lookup"><span data-stu-id="88452-159">Transient</span></span> |
| [<span data-ttu-id="88452-160">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="88452-160">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.options.ioptions-1) | <span data-ttu-id="88452-161">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-161">Singleton</span></span> |
| [<span data-ttu-id="88452-162">System.Diagnostics.DiagnosticSource</span><span class="sxs-lookup"><span data-stu-id="88452-162">System.Diagnostics.DiagnosticSource</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticsource) | <span data-ttu-id="88452-163">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-163">Singleton</span></span> |
| [<span data-ttu-id="88452-164">System.Diagnostics.DiagnosticListener</span><span class="sxs-lookup"><span data-stu-id="88452-164">System.Diagnostics.DiagnosticListener</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticlistener) | <span data-ttu-id="88452-165">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-165">Singleton</span></span> |
| [<span data-ttu-id="88452-166">Microsoft.AspNetCore.Hosting.IStartupFilter</span><span class="sxs-lookup"><span data-stu-id="88452-166">Microsoft.AspNetCore.Hosting.IStartupFilter</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.istartupfilter) | <span data-ttu-id="88452-167">Transitorio</span><span class="sxs-lookup"><span data-stu-id="88452-167">Transient</span></span> |
| [<span data-ttu-id="88452-168">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span><span class="sxs-lookup"><span data-stu-id="88452-168">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.objectpool.objectpoolprovider) | <span data-ttu-id="88452-169">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-169">Singleton</span></span> |
| [<span data-ttu-id="88452-170">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="88452-170">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.options.iconfigureoptions-1) | <span data-ttu-id="88452-171">Transitorio</span><span class="sxs-lookup"><span data-stu-id="88452-171">Transient</span></span> |
| [<span data-ttu-id="88452-172">Microsoft.AspNetCore.Hosting.Server.IServer</span><span class="sxs-lookup"><span data-stu-id="88452-172">Microsoft.AspNetCore.Hosting.Server.IServer</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.server.iserver) | <span data-ttu-id="88452-173">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-173">Singleton</span></span> |
| [<span data-ttu-id="88452-174">Microsoft.AspNetCore.Hosting.IStartup</span><span class="sxs-lookup"><span data-stu-id="88452-174">Microsoft.AspNetCore.Hosting.IStartup</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.istartup) | <span data-ttu-id="88452-175">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-175">Singleton</span></span> |
| [<span data-ttu-id="88452-176">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span><span class="sxs-lookup"><span data-stu-id="88452-176">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.iapplicationlifetime) | <span data-ttu-id="88452-177">Singleton</span><span class="sxs-lookup"><span data-stu-id="88452-177">Singleton</span></span> |

<span data-ttu-id="88452-178">A continuación se muestra un ejemplo de cómo agregar servicios adicionales para el contenedor mediante una serie de métodos de extensión como `AddDbContext`, `AddIdentity`, y `AddMvc`.</span><span class="sxs-lookup"><span data-stu-id="88452-178">Below is an example of how to add additional services to the container using a number of extension methods like `AddDbContext`, `AddIdentity`, and `AddMvc`.</span></span>

[!code-csharp[Main](../common/samples/WebApplication1/Startup.cs?highlight=5-6,8-10,12&range=39-56)]

<span data-ttu-id="88452-179">Las características y middleware proporcionadas por ASP.NET, como MVC, siguen una convención de usar un único complemento*ServiceName* método de extensión para registrar todos los servicios necesarios para esa característica.</span><span class="sxs-lookup"><span data-stu-id="88452-179">The features and middleware provided by ASP.NET, such as MVC, follow a convention of using a single Add*ServiceName* extension method to register all of the services required by that feature.</span></span>

>[!TIP]
> <span data-ttu-id="88452-180">Puede solicitar determinados servicios proporcionados por el marco de trabajo dentro de `Startup` Vea métodos a través de sus listas de parámetros - [inicio de la aplicación](startup.md) para obtener más detalles.</span><span class="sxs-lookup"><span data-stu-id="88452-180">You can request certain framework-provided services within `Startup` methods through their parameter lists - see [Application Startup](startup.md) for more details.</span></span>

## <a name="registering-your-own-services"></a><span data-ttu-id="88452-181">Registrar sus propios servicios</span><span class="sxs-lookup"><span data-stu-id="88452-181">Registering Your Own Services</span></span>

<span data-ttu-id="88452-182">Puede registrar sus propios servicios de aplicación de la siguiente manera.</span><span class="sxs-lookup"><span data-stu-id="88452-182">You can register your own application services as follows.</span></span> <span data-ttu-id="88452-183">El primer tipo genérico representa el tipo (normalmente una interfaz) que se le pedirá desde el contenedor.</span><span class="sxs-lookup"><span data-stu-id="88452-183">The first generic type represents the type (typically an interface) that will be requested from the container.</span></span> <span data-ttu-id="88452-184">El segundo tipo genérico representa el tipo concreto que se crea una instancia del contenedor y se usará para responder a dichas solicitudes.</span><span class="sxs-lookup"><span data-stu-id="88452-184">The second generic type represents the concrete type that will be instantiated by the container and used to fulfill such requests.</span></span>

[!code-csharp[Main](../common/samples/WebApplication1/Startup.cs?range=53-54)]

> [!NOTE]
> <span data-ttu-id="88452-185">Cada `services.Add<ServiceName>` método de extensión agrega (y potencialmente configura) en servicios.</span><span class="sxs-lookup"><span data-stu-id="88452-185">Each `services.Add<ServiceName>` extension method adds (and potentially configures) services.</span></span> <span data-ttu-id="88452-186">Por ejemplo, `services.AddMvc()` agrega los servicios que requiere de MVC.</span><span class="sxs-lookup"><span data-stu-id="88452-186">For example, `services.AddMvc()` adds the services MVC requires.</span></span> <span data-ttu-id="88452-187">Se recomienda que siga esta convención, colocar métodos de extensión en la `Microsoft.Extensions.DependencyInjection` espacio de nombres a encapsular grupos de registros de servicio.</span><span class="sxs-lookup"><span data-stu-id="88452-187">It's recommended that you follow this convention, placing extension methods in the `Microsoft.Extensions.DependencyInjection` namespace, to encapsulate groups of service registrations.</span></span>

<span data-ttu-id="88452-188">El `AddTransient` método se utiliza para asignar tipos abstractos a servicios concretos que se crean instancias por separado para cada objeto que lo requiera.</span><span class="sxs-lookup"><span data-stu-id="88452-188">The `AddTransient` method is used to map abstract types to concrete services that are instantiated separately for every object that requires it.</span></span> <span data-ttu-id="88452-189">Esto se conoce como el servicio *duración*, y a continuación se describen las opciones de duración adicional.</span><span class="sxs-lookup"><span data-stu-id="88452-189">This is known as the service's *lifetime*, and additional lifetime options are described below.</span></span> <span data-ttu-id="88452-190">Es importante elegir un período adecuado para cada uno de los servicios que registra.</span><span class="sxs-lookup"><span data-stu-id="88452-190">It is important to choose an appropriate lifetime for each of the services you register.</span></span> <span data-ttu-id="88452-191">¿Una nueva instancia del servicio se debe proporcionar para cada clase que lo solicita?</span><span class="sxs-lookup"><span data-stu-id="88452-191">Should a new instance of the service be provided to each class that requests it?</span></span> <span data-ttu-id="88452-192">¿Debe usarse una instancia a lo largo de una solicitud web determinado?</span><span class="sxs-lookup"><span data-stu-id="88452-192">Should one instance be used throughout a given web request?</span></span> <span data-ttu-id="88452-193">¿O bien, debe usarse una sola instancia para la duración de la aplicación?</span><span class="sxs-lookup"><span data-stu-id="88452-193">Or should a single instance be used for the lifetime of the application?</span></span>

<span data-ttu-id="88452-194">En el ejemplo de este artículo, hay un controlador simple que muestra los nombres de carácter, denominados `CharactersController`.</span><span class="sxs-lookup"><span data-stu-id="88452-194">In the sample for this article, there is a simple controller that displays character names, called `CharactersController`.</span></span> <span data-ttu-id="88452-195">Su `Index` método muestra la lista actual de caracteres que se han almacenado en la aplicación e inicializa la colección con una serie de caracteres si no existe ninguna.</span><span class="sxs-lookup"><span data-stu-id="88452-195">Its `Index` method displays the current list of characters that have been stored in the application, and initializes the collection with a handful of characters if none exist.</span></span> <span data-ttu-id="88452-196">Tenga en cuenta que, aunque esta aplicación usa Entity Framework Core y `ApplicationDbContext` clase para su persistencia, ninguno de los que es evidente en el controlador.</span><span class="sxs-lookup"><span data-stu-id="88452-196">Note that although this application uses Entity Framework Core and the `ApplicationDbContext` class for its persistence, none of that is apparent in the controller.</span></span> <span data-ttu-id="88452-197">En su lugar, se ha abstrae el mecanismo de acceso de datos específico detrás de una interfaz, `ICharacterRepository`, que sigue la [modelo de repositorio](http://deviq.com/repository-pattern/).</span><span class="sxs-lookup"><span data-stu-id="88452-197">Instead, the specific data access mechanism has been abstracted behind an interface, `ICharacterRepository`, which follows the [repository pattern](http://deviq.com/repository-pattern/).</span></span> <span data-ttu-id="88452-198">Una instancia de `ICharacterRepository` se solicita mediante el constructor y se asigna a un campo privado, que se usa para tener acceso a caracteres según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="88452-198">An instance of `ICharacterRepository` is requested via the constructor and assigned to a private field, which is then used to access characters as necessary.</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Controllers/CharactersController.cs?highlight=3,5,6,7,8,14,21-27&range=8-36)]

<span data-ttu-id="88452-199">El `ICharacterRepository` define los dos métodos es necesario trabajar con el controlador `Character` instancias.</span><span class="sxs-lookup"><span data-stu-id="88452-199">The `ICharacterRepository` defines the two methods the controller needs to work with `Character` instances.</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/ICharacterRepository.cs?highlight=8,9)]

<span data-ttu-id="88452-200">Esta interfaz se implementa a su vez por un tipo concreto, `CharacterRepository`, que se utiliza en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="88452-200">This interface is in turn implemented by a concrete type, `CharacterRepository`, that is used at runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="88452-201">La forma DI se utiliza con la `CharacterRepository` clase es un modelo general que puede seguir para todos los servicios de aplicación, no solo en "repositorios" o las clases de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="88452-201">The way DI is used with the `CharacterRepository` class is a general model you can follow for all of your application services, not just in "repositories" or data access classes.</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Models/CharacterRepository.cs?highlight=9,11,12,13,14)]

<span data-ttu-id="88452-202">Tenga en cuenta que `CharacterRepository` solicitudes un `ApplicationDbContext` en su constructor.</span><span class="sxs-lookup"><span data-stu-id="88452-202">Note that `CharacterRepository` requests an `ApplicationDbContext` in its constructor.</span></span> <span data-ttu-id="88452-203">No es inusual para la inyección de dependencia que se usará de forma encadenada como este, con cada dependencia solicitados a su vez solicitar sus propias dependencias.</span><span class="sxs-lookup"><span data-stu-id="88452-203">It is not unusual for dependency injection to be used in a chained fashion like this, with each requested dependency in turn requesting its own dependencies.</span></span> <span data-ttu-id="88452-204">El contenedor es responsable de resolver todas las dependencias en el gráfico y devolver el servicio totalmente resuelto.</span><span class="sxs-lookup"><span data-stu-id="88452-204">The container is responsible for resolving all of the dependencies in the graph and returning the fully resolved service.</span></span>

> [!NOTE]
> <span data-ttu-id="88452-205">Crear el objeto solicitado y todos los objetos que necesita y todos los objetos de los que requieren, se denomina a veces un *gráfico de objetos*.</span><span class="sxs-lookup"><span data-stu-id="88452-205">Creating the requested object, and all of the objects it requires, and all of the objects those require, is sometimes referred to as an *object graph*.</span></span> <span data-ttu-id="88452-206">Del mismo modo, el conjunto colectivo de dependencias que deben resolverse se suele hacer referencia a como un *árbol de dependencias* o *gráfico de dependencias*.</span><span class="sxs-lookup"><span data-stu-id="88452-206">Likewise, the collective set of dependencies that must be resolved is typically referred to as a *dependency tree* or *dependency graph*.</span></span>

<span data-ttu-id="88452-207">En este caso, ambos `ICharacterRepository` y a su vez `ApplicationDbContext` debe estar registrado en el contenedor de servicios de `ConfigureServices` en `Startup`.</span><span class="sxs-lookup"><span data-stu-id="88452-207">In this case, both `ICharacterRepository` and in turn `ApplicationDbContext` must be registered with the services container in `ConfigureServices` in `Startup`.</span></span> <span data-ttu-id="88452-208">`ApplicationDbContext`se configura con la llamada al método de extensión `AddDbContext<T>`.</span><span class="sxs-lookup"><span data-stu-id="88452-208">`ApplicationDbContext` is configured with the call to the extension method `AddDbContext<T>`.</span></span> <span data-ttu-id="88452-209">El código siguiente muestra el registro de la `CharacterRepository` tipo.</span><span class="sxs-lookup"><span data-stu-id="88452-209">The following code shows the registration of the `CharacterRepository` type.</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Startup.cs?highlight=3-5,11&range=16-32)]

<span data-ttu-id="88452-210">Contextos de Entity Framework deben agregarse en el contenedor de servicios mediante la `Scoped` duración.</span><span class="sxs-lookup"><span data-stu-id="88452-210">Entity Framework contexts should be added to the services container using the `Scoped` lifetime.</span></span> <span data-ttu-id="88452-211">Esto se encarga del automáticamente si utiliza los métodos auxiliares como se indicó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="88452-211">This is taken care of automatically if you use the helper methods as shown above.</span></span> <span data-ttu-id="88452-212">Repositorios que harán que el uso de Entity Framework deben usar la misma duración.</span><span class="sxs-lookup"><span data-stu-id="88452-212">Repositories that will make use of Entity Framework should use the same lifetime.</span></span>

>[!WARNING]
> <span data-ttu-id="88452-213">Está resolviendo el peligro principal sea cuidadoso con la representación de un `Scoped` servicio de un singleton.</span><span class="sxs-lookup"><span data-stu-id="88452-213">The main danger to be wary of is resolving a `Scoped` service from a singleton.</span></span> <span data-ttu-id="88452-214">Es probable que en este caso el servicio tendrá un estado incorrecto al procesar las solicitudes posteriores.</span><span class="sxs-lookup"><span data-stu-id="88452-214">It's likely in such a case that the service will have incorrect state when processing subsequent requests.</span></span>

<span data-ttu-id="88452-215">Servicios que tengan dependencias deben registrarlos en el contenedor.</span><span class="sxs-lookup"><span data-stu-id="88452-215">Services that have dependencies should register them in the container.</span></span> <span data-ttu-id="88452-216">Si el constructor de un servicio requiere un tipo primitivo, como un `string`, se pueden insertar utilizando el [opciones patrón y la configuración](configuration.md).</span><span class="sxs-lookup"><span data-stu-id="88452-216">If a service's constructor requires a primitive, such as a `string`, this can be injected by using the [options pattern and configuration](configuration.md).</span></span>

## <a name="service-lifetimes-and-registration-options"></a><span data-ttu-id="88452-217">Duración del servicio y las opciones de registro</span><span class="sxs-lookup"><span data-stu-id="88452-217">Service Lifetimes and Registration Options</span></span>

<span data-ttu-id="88452-218">Los servicios de ASP.NET pueden configurarse con la duración de la siguiente:</span><span class="sxs-lookup"><span data-stu-id="88452-218">ASP.NET services can be configured with the following lifetimes:</span></span>

<span data-ttu-id="88452-219">**Transitorio**</span><span class="sxs-lookup"><span data-stu-id="88452-219">**Transient**</span></span>

<span data-ttu-id="88452-220">Servicios de duración transitorios se crean cada vez que se solicitan.</span><span class="sxs-lookup"><span data-stu-id="88452-220">Transient lifetime services are created each time they are requested.</span></span> <span data-ttu-id="88452-221">Este período de vigencia funciona mejor para servicios sin estado ligeros.</span><span class="sxs-lookup"><span data-stu-id="88452-221">This lifetime works best for lightweight, stateless services.</span></span>

<span data-ttu-id="88452-222">**El ámbito**</span><span class="sxs-lookup"><span data-stu-id="88452-222">**Scoped**</span></span>

<span data-ttu-id="88452-223">Servicios de duración de ámbito se crean una vez por solicitud.</span><span class="sxs-lookup"><span data-stu-id="88452-223">Scoped lifetime services are created once per request.</span></span>

<span data-ttu-id="88452-224">**Singleton**</span><span class="sxs-lookup"><span data-stu-id="88452-224">**Singleton**</span></span>

<span data-ttu-id="88452-225">Servicios de duración de singleton se crean la primera vez que se solicitan (o cuando `ConfigureServices` se ejecuta si se especifica una instancia no existe) y, a continuación, todas las solicitudes subsiguientes usará la misma instancia.</span><span class="sxs-lookup"><span data-stu-id="88452-225">Singleton lifetime services are created the first time they are requested (or when `ConfigureServices` is run if you specify an instance there) and then every subsequent request will use the same instance.</span></span> <span data-ttu-id="88452-226">Si la aplicación requiere un comportamiento singleton, lo que permite el contenedor de servicios administrar la duración del servicio se recomienda en lugar de implementar el patrón de diseño singleton y administrar la duración del objeto en la clase por sí mismo.</span><span class="sxs-lookup"><span data-stu-id="88452-226">If your application requires singleton behavior, allowing the services container to manage the service's lifetime is recommended instead of implementing the singleton design pattern and managing your object's lifetime in the class yourself.</span></span>

<span data-ttu-id="88452-227">Los servicios se pueden registrar con el contenedor de varias maneras.</span><span class="sxs-lookup"><span data-stu-id="88452-227">Services can be registered with the container in several ways.</span></span> <span data-ttu-id="88452-228">Ya hemos visto cómo registrar una implementación de servicio con un tipo determinado mediante la especificación de tipo concreto para usar.</span><span class="sxs-lookup"><span data-stu-id="88452-228">We have already seen how to register a service implementation with a given type by specifying the concrete type to use.</span></span> <span data-ttu-id="88452-229">Además, un generador puede especificarse, que se utilizará para crear la instancia a petición.</span><span class="sxs-lookup"><span data-stu-id="88452-229">In addition, a factory can be specified, which will then be used to create the instance on demand.</span></span> <span data-ttu-id="88452-230">El tercer enfoque consiste en especificar directamente la instancia del tipo que se utiliza en el que caso el contenedor nunca intentará crear una instancia (ni eliminará de la instancia).</span><span class="sxs-lookup"><span data-stu-id="88452-230">The third approach is to directly specify the instance of the type to use, in which case the container will never attempt to create an instance (nor will it dispose of the instance).</span></span>

<span data-ttu-id="88452-231">Para mostrar la diferencia entre estas opciones de duración y el registro, considere la posibilidad de una interfaz simple que representa una o varias tareas como un *operación* con un identificador único, `OperationId`.</span><span class="sxs-lookup"><span data-stu-id="88452-231">To demonstrate the difference between these lifetime and registration options, consider a simple interface that represents one or more tasks as an *operation* with a unique identifier, `OperationId`.</span></span> <span data-ttu-id="88452-232">Según cómo se configura la duración de este servicio, el contenedor proporciona las mismas o diferentes instancias del servicio a la clase que lo solicita.</span><span class="sxs-lookup"><span data-stu-id="88452-232">Depending on how we configure the lifetime for this service, the container will provide either the same or different instances of the service to the requesting class.</span></span> <span data-ttu-id="88452-233">Para dejar claro qué duración se solicita, crearemos un tipo por la opción de duración:</span><span class="sxs-lookup"><span data-stu-id="88452-233">To make it clear which lifetime is being requested, we will create one type per lifetime option:</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/IOperation.cs?highlight=5-8)]

<span data-ttu-id="88452-234">Se implementan estas interfaces mediante una sola clase, `Operation`, que acepta un `Guid` en su constructor, o usa un nuevo `Guid` si no se proporciona ninguno.</span><span class="sxs-lookup"><span data-stu-id="88452-234">We implement these interfaces using a single class, `Operation`, that accepts a `Guid` in its constructor, or uses a new `Guid` if none is provided.</span></span>

<span data-ttu-id="88452-235">Después, en `ConfigureServices`, cada tipo se agrega al contenedor de acuerdo con su duración con nombre:</span><span class="sxs-lookup"><span data-stu-id="88452-235">Next, in `ConfigureServices`, each type is added to the container according to its named lifetime:</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Startup.cs?range=26-32)]

<span data-ttu-id="88452-236">Tenga en cuenta que la `IOperationSingletonInstance` servicio está usando una instancia específica con un identificador conocido de `Guid.Empty` para poder borrar cuando este tipo está en uso (su Guid será todo ceros).</span><span class="sxs-lookup"><span data-stu-id="88452-236">Note that the `IOperationSingletonInstance` service is using a specific instance with a known ID of `Guid.Empty` so it will be clear when this type is in use (its Guid will be all zeroes).</span></span> <span data-ttu-id="88452-237">También hemos registrado un `OperationService` que depende de cada uno de los otros `Operation` tipos, por lo que esté claro dentro de una solicitud si este servicio obtiene la misma instancia que el controlador o uno nuevo para cada tipo de operación.</span><span class="sxs-lookup"><span data-stu-id="88452-237">We have also registered an `OperationService` that depends on each of the other `Operation` types, so that it will be clear within a request whether this service is getting the same instance as the controller, or a new one, for each operation type.</span></span> <span data-ttu-id="88452-238">Todo lo que hace este servicio es exponer sus dependencias como propiedades, por lo que se pueden mostrar en la vista.</span><span class="sxs-lookup"><span data-stu-id="88452-238">All this service does is expose its dependencies as properties, so they can be displayed in the view.</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Services/OperationService.cs)]

<span data-ttu-id="88452-239">Para mostrar la duración de los objetos dentro y entre las solicitudes individuales independientes de la aplicación, el ejemplo incluye una `OperationsController` que cada tipo de solicitudes `IOperation` tipo así como un `OperationService`.</span><span class="sxs-lookup"><span data-stu-id="88452-239">To demonstrate the object lifetimes within and between separate individual requests to the application, the sample includes an `OperationsController` that requests each kind of `IOperation` type as well as an `OperationService`.</span></span> <span data-ttu-id="88452-240">El `Index` acción, a continuación, muestra todas del controlador y del servicio `OperationId` valores.</span><span class="sxs-lookup"><span data-stu-id="88452-240">The `Index` action then displays all of the controller's and service's `OperationId` values.</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Controllers/OperationsController.cs)]

<span data-ttu-id="88452-241">Ahora se realizan dos solicitudes diferentes para esta acción de controlador:</span><span class="sxs-lookup"><span data-stu-id="88452-241">Now two separate requests are made to this controller action:</span></span>

![La vista de operaciones de la aplicación web de ejemplo de inyección de dependencia ejecutando con Microsoft Edge con valores de Id. de operación (GUID) para transitorio, en el ámbito, Singleton y el controlador de instancia y las operaciones de servicio de operación en la primera solicitud.](dependency-injection/_static/lifetimes_request1.png)

![Las operaciones de vista que muestra los valores de Id. de operación para una segunda solicitud.](dependency-injection/_static/lifetimes_request2.png)

<span data-ttu-id="88452-244">Observe cuál de los `OperationId` valores variar dentro de una solicitud y entre las solicitudes.</span><span class="sxs-lookup"><span data-stu-id="88452-244">Observe which of the `OperationId` values vary within a request, and between requests.</span></span>

* <span data-ttu-id="88452-245">*Transitorio* objetos siempre son distintos; se proporciona una nueva instancia para cada controlador y todos los servicios.</span><span class="sxs-lookup"><span data-stu-id="88452-245">*Transient* objects are always different; a new instance is provided to every controller and every service.</span></span>

* <span data-ttu-id="88452-246">*Ámbito* objetos son iguales dentro de una solicitud, pero es diferente entre distintas solicitudes</span><span class="sxs-lookup"><span data-stu-id="88452-246">*Scoped* objects are the same within a request, but different across different requests</span></span>

* <span data-ttu-id="88452-247">*Singleton* objetos son los mismos para todos los objetos y todas las solicitudes (independientemente de si se proporciona una instancia en `ConfigureServices`)</span><span class="sxs-lookup"><span data-stu-id="88452-247">*Singleton* objects are the same for every object and every request (regardless of whether an instance is provided in `ConfigureServices`)</span></span>

## <a name="request-services"></a><span data-ttu-id="88452-248">Servicios de solicitud</span><span class="sxs-lookup"><span data-stu-id="88452-248">Request Services</span></span>

<span data-ttu-id="88452-249">Los servicios disponibles en un ASP.NET solicitar de `HttpContext` se exponen a través de la `RequestServices` colección.</span><span class="sxs-lookup"><span data-stu-id="88452-249">The services available within an ASP.NET request from `HttpContext` are exposed through the `RequestServices` collection.</span></span>

![Intellisense de servicios de solicitud de HttpContext contextual cuadro de diálogo que indica que los servicios de solicitud Obtiene o establece el IServiceProvider que proporciona acceso al contenedor de servicios de la solicitud.](dependency-injection/_static/request-services.png)

<span data-ttu-id="88452-251">Servicios de solicitud representan los servicios que configura y solicitar como parte de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="88452-251">Request Services represent the services you configure and request as part of your application.</span></span> <span data-ttu-id="88452-252">Cuando los objetos de especifican las dependencias, los tipos encontrados en satisface estos `RequestServices`, no `ApplicationServices`.</span><span class="sxs-lookup"><span data-stu-id="88452-252">When your objects specify dependencies, these are satisfied by the types found in `RequestServices`, not `ApplicationServices`.</span></span>

<span data-ttu-id="88452-253">Por lo general, no utilice estas propiedades directamente, por lo que prefieren en su lugar solicitar a los tipos de las clases que necesita a través de su constructor de clase y dejar que el marco de trabajo insertar estas dependencias.</span><span class="sxs-lookup"><span data-stu-id="88452-253">Generally, you shouldn't use these properties directly, preferring instead to request the types your classes you require via your class's constructor, and letting the framework inject these dependencies.</span></span> <span data-ttu-id="88452-254">Esto da como resultado las clases que son más fáciles de probar (vea [pruebas](../testing/index.md)) y más están acopladas.</span><span class="sxs-lookup"><span data-stu-id="88452-254">This yields classes that are easier to test (see [Testing](../testing/index.md)) and are more loosely coupled.</span></span>

> [!NOTE]
> <span data-ttu-id="88452-255">Prefiere solicitar dependencias como parámetros del constructor al tener acceso a la `RequestServices` colección.</span><span class="sxs-lookup"><span data-stu-id="88452-255">Prefer requesting dependencies as constructor parameters to accessing the `RequestServices` collection.</span></span>

## <a name="designing-your-services-for-dependency-injection"></a><span data-ttu-id="88452-256">Diseñar los servicios para la inyección de dependencia</span><span class="sxs-lookup"><span data-stu-id="88452-256">Designing Your Services For Dependency Injection</span></span>

<span data-ttu-id="88452-257">Debe diseñar los servicios para usar la inserción de dependencias para obtener sus colaboradores.</span><span class="sxs-lookup"><span data-stu-id="88452-257">You should design your services to use dependency injection to get their collaborators.</span></span> <span data-ttu-id="88452-258">Esto significa que evitar el uso de llamadas a métodos estáticos con estado (lo que ocasionará un olor de código que se conoce como [estáticos adhesivos para sus](http://deviq.com/static-cling/)) y la creación de instancias directa de las clases dependientes dentro de los servicios.</span><span class="sxs-lookup"><span data-stu-id="88452-258">This means avoiding the use of stateful static method calls (which result in a code smell known as [static cling](http://deviq.com/static-cling/)) and the direct instantiation of dependent classes within your services.</span></span> <span data-ttu-id="88452-259">Puede ser útil para recordar la frase [New es adherencia](https://ardalis.com/new-is-glue), al elegir si desea crear una instancia de un tipo o para solicitar a través de la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="88452-259">It may help to remember the phrase, [New is Glue](https://ardalis.com/new-is-glue), when choosing whether to instantiate a type or to request it via dependency injection.</span></span> <span data-ttu-id="88452-260">Siguiendo la [sólido principios de objeto orientada a servicios diseño](http://deviq.com/solid/), las clases naturalmente tienden a ser pequeña, correctamente factorizada y probados fácilmente.</span><span class="sxs-lookup"><span data-stu-id="88452-260">By following the [SOLID Principles of Object Oriented Design](http://deviq.com/solid/), your classes will naturally tend to be small, well-factored, and easily tested.</span></span>

<span data-ttu-id="88452-261">¿Qué ocurre si piensa que las clases suelen tener demasiadas dependencias que se va a insertar de forma?</span><span class="sxs-lookup"><span data-stu-id="88452-261">What if you find that your classes tend to have way too many dependencies being injected?</span></span> <span data-ttu-id="88452-262">Esto suele ser un inicio de sesión que está intentando hacer demasiado la clase y, probablemente es infringiendo SRP - la [principio de responsabilidad única](http://deviq.com/single-responsibility-principle/).</span><span class="sxs-lookup"><span data-stu-id="88452-262">This is generally a sign that your class is trying to do too much, and is probably violating SRP - the [Single Responsibility Principle](http://deviq.com/single-responsibility-principle/).</span></span> <span data-ttu-id="88452-263">Vea si puede refactorizar la clase moviendo algunos de sus responsabilidades en una nueva clase.</span><span class="sxs-lookup"><span data-stu-id="88452-263">See if you can refactor the class by moving some of its responsibilities into a new class.</span></span> <span data-ttu-id="88452-264">Tenga en cuenta que la `Controller` clases deberían centrarse en aspectos de la interfaz de usuario, por lo que se deben mantener detalles de implementación de acceso de reglas y datos empresariales en clases adecuadas a estos [separar los problemas](http://deviq.com/separation-of-concerns/).</span><span class="sxs-lookup"><span data-stu-id="88452-264">Keep in mind that your `Controller` classes should be focused on UI concerns, so business rules and data access implementation details should be kept in classes appropriate to these [separate concerns](http://deviq.com/separation-of-concerns/).</span></span>

<span data-ttu-id="88452-265">Con respecto a acceso a datos en concreto, puede insertar el `DbContext` en los controladores (suponiendo que ha agregado EF al contenedor de servicios de `ConfigureServices`).</span><span class="sxs-lookup"><span data-stu-id="88452-265">With regards to data access specifically, you can inject the `DbContext` into your controllers (assuming you've added EF to the services container in `ConfigureServices`).</span></span> <span data-ttu-id="88452-266">Algunos desarrolladores prefieren usar una interfaz de repositorio para la base de datos en lugar de insertar el `DbContext` directamente.</span><span class="sxs-lookup"><span data-stu-id="88452-266">Some developers prefer to use a repository interface to the database rather than injecting the `DbContext` directly.</span></span> <span data-ttu-id="88452-267">Mediante una interfaz para encapsular los datos lógica de acceso en un solo lugar puede minimizar el número de posiciones tendrá que cambiar cuando cambia la base de datos.</span><span class="sxs-lookup"><span data-stu-id="88452-267">Using an interface to encapsulate the data access logic in one place can minimize how many places you will have to change when your database changes.</span></span>

### <a name="disposing-of-services"></a><span data-ttu-id="88452-268">Eliminación de servicios</span><span class="sxs-lookup"><span data-stu-id="88452-268">Disposing of services</span></span>

<span data-ttu-id="88452-269">El contenedor llamará `Dispose` para `IDisposable` tipos lo crea.</span><span class="sxs-lookup"><span data-stu-id="88452-269">The container will call `Dispose` for `IDisposable` types it creates.</span></span> <span data-ttu-id="88452-270">Sin embargo, si agrega una instancia al contenedor usted mismo, lo no se eliminará.</span><span class="sxs-lookup"><span data-stu-id="88452-270">However, if you add an instance to the container yourself, it will not be disposed.</span></span>

<span data-ttu-id="88452-271">Ejemplo:</span><span class="sxs-lookup"><span data-stu-id="88452-271">Example:</span></span>

```csharp
// Services implement IDisposable:
public class Service1 : IDisposable {}
public class Service2 : IDisposable {}
public class Service3 : IDisposable {}

public void ConfigureServices(IServiceCollection services)
{
    // container will create the instance(s) of these types and will dispose them
    services.AddScoped<Service1>();
    services.AddSingleton<Service2>();

    // container did not create instance so it will NOT dispose it
    services.AddSingleton<Service3>(new Service3());
    services.AddSingleton(new Service3());
}
```

> [!NOTE]
> <span data-ttu-id="88452-272">En la versión 1.0, el contenedor llama a dispose en *todos los* `IDisposable` objetos, incluso aquellos que no ha creado.</span><span class="sxs-lookup"><span data-stu-id="88452-272">In version 1.0, the container called dispose on *all* `IDisposable` objects, including those it did not create.</span></span>

## <a name="replacing-the-default-services-container"></a><span data-ttu-id="88452-273">Reemplazar el contenedor de servicios predeterminado</span><span class="sxs-lookup"><span data-stu-id="88452-273">Replacing the default services container</span></span>

<span data-ttu-id="88452-274">El contenedor de servicios integrados está pensado para atender las necesidades básicas de la plataforma y la mayoría de las aplicaciones de consumidor creada en él.</span><span class="sxs-lookup"><span data-stu-id="88452-274">The built-in services container is meant to serve the basic needs of the framework and most consumer applications built on it.</span></span> <span data-ttu-id="88452-275">Sin embargo, los desarrolladores pueden reemplazar el contenedor integrado con el contenedor preferido.</span><span class="sxs-lookup"><span data-stu-id="88452-275">However, developers can replace the built-in container with their preferred container.</span></span> <span data-ttu-id="88452-276">El `ConfigureServices` método normalmente devuelve `void`, sin embargo, si se cambia la firma para devolver `IServiceProvider`, puede configurar y devolver un contenedor diferente.</span><span class="sxs-lookup"><span data-stu-id="88452-276">The `ConfigureServices` method typically returns `void`, but if its signature is changed to return `IServiceProvider`, a different container can be configured and returned.</span></span> <span data-ttu-id="88452-277">Hay muchos contenedores de IOC disponibles para. NET.</span><span class="sxs-lookup"><span data-stu-id="88452-277">There are many IOC containers available for .NET.</span></span> <span data-ttu-id="88452-278">En este ejemplo, el [Autofac](https://autofac.org/) se usa el paquete.</span><span class="sxs-lookup"><span data-stu-id="88452-278">In this example, the [Autofac](https://autofac.org/) package is used.</span></span>

<span data-ttu-id="88452-279">En primer lugar, instale los paquetes de contenedor adecuada:</span><span class="sxs-lookup"><span data-stu-id="88452-279">First, install the appropriate container package(s):</span></span>

* `Autofac`
* `Autofac.Extensions.DependencyInjection`

<span data-ttu-id="88452-280">A continuación, configure el contenedor en `ConfigureServices` y devolver un `IServiceProvider`:</span><span class="sxs-lookup"><span data-stu-id="88452-280">Next, configure the container in `ConfigureServices` and return an `IServiceProvider`:</span></span>

```csharp
public IServiceProvider ConfigureServices(IServiceCollection services)
{
    services.AddMvc();
    // Add other framework services

    // Add Autofac
    var containerBuilder = new ContainerBuilder();
    containerBuilder.RegisterModule<DefaultModule>();
    containerBuilder.Populate(services);
    var container = containerBuilder.Build();
    return new AutofacServiceProvider(container);
}
```

> [!NOTE]
> <span data-ttu-id="88452-281">Cuando se utiliza un contenedor de DI de terceros, debe cambiar `ConfigureServices` para que devuelva `IServiceProvider` en lugar de `void`.</span><span class="sxs-lookup"><span data-stu-id="88452-281">When using a third-party DI container, you must change `ConfigureServices` so that it returns `IServiceProvider` instead of `void`.</span></span>

<span data-ttu-id="88452-282">Por último, configure Autofac como es habitual en `DefaultModule`:</span><span class="sxs-lookup"><span data-stu-id="88452-282">Finally, configure Autofac as normal in `DefaultModule`:</span></span>

```csharp
public class DefaultModule : Module
{
    protected override void Load(ContainerBuilder builder)
    {
        builder.RegisterType<CharacterRepository>().As<ICharacterRepository>();
    }
}
```

<span data-ttu-id="88452-283">En tiempo de ejecución, se utilizará Autofac para resolver tipos e inyectar dependencias.</span><span class="sxs-lookup"><span data-stu-id="88452-283">At runtime, Autofac will be used to resolve types and inject dependencies.</span></span> <span data-ttu-id="88452-284">[Más información sobre el uso de Autofac y ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span><span class="sxs-lookup"><span data-stu-id="88452-284">[Learn more about using Autofac and ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span></span>

### <a name="thread-safety"></a><span data-ttu-id="88452-285">Seguridad para subprocesos</span><span class="sxs-lookup"><span data-stu-id="88452-285">Thread safety</span></span>

<span data-ttu-id="88452-286">Servicios de singleton deben ser seguros para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="88452-286">Singleton services need to be thread safe.</span></span> <span data-ttu-id="88452-287">Si un servicio de singleton tiene una dependencia en un servicio transitorio, el servicio transitorio también puede necesitar para subprocesos según su uso por el singleton.</span><span class="sxs-lookup"><span data-stu-id="88452-287">If a singleton service has a dependency on a transient service, the transient service may also need to be thread safe depending how it’s used by the singleton.</span></span>

## <a name="recommendations"></a><span data-ttu-id="88452-288">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="88452-288">Recommendations</span></span>

<span data-ttu-id="88452-289">Cuando se trabaja con la inserción de dependencias, tenga las siguientes recomendaciones en cuenta:</span><span class="sxs-lookup"><span data-stu-id="88452-289">When working with dependency injection, keep the following recommendations in mind:</span></span>

* <span data-ttu-id="88452-290">DI es para los objetos que tienen dependencias complejas.</span><span class="sxs-lookup"><span data-stu-id="88452-290">DI is for objects that have complex dependencies.</span></span> <span data-ttu-id="88452-291">Controladores, servicios, adaptadores y repositorios son ejemplos de objetos que podrían agregarse al DI.</span><span class="sxs-lookup"><span data-stu-id="88452-291">Controllers, services, adapters, and repositories are all examples of objects that might be added to DI.</span></span>

* <span data-ttu-id="88452-292">Evitar el almacenamiento de datos y la configuración directamente en DI.</span><span class="sxs-lookup"><span data-stu-id="88452-292">Avoid storing data and configuration directly in DI.</span></span> <span data-ttu-id="88452-293">Por ejemplo, normalmente no debería agregarse carro de la compra de un usuario para el contenedor de servicios.</span><span class="sxs-lookup"><span data-stu-id="88452-293">For example, a user's shopping cart shouldn't typically be added to the services container.</span></span> <span data-ttu-id="88452-294">Debe usar la configuración de la [opciones modelo](configuration.md#options-config-objects).</span><span class="sxs-lookup"><span data-stu-id="88452-294">Configuration should use the [Options Model](configuration.md#options-config-objects).</span></span> <span data-ttu-id="88452-295">Del mismo modo, evitar objetos "marcador de datos" que solo existen para permitir el acceso a otro objeto.</span><span class="sxs-lookup"><span data-stu-id="88452-295">Similarly, avoid "data holder" objects that only exist to allow access to some other object.</span></span> <span data-ttu-id="88452-296">Es mejor solicitar el elemento real que sea necesario mediante la inserción de dependencias, si es posible.</span><span class="sxs-lookup"><span data-stu-id="88452-296">It's better to request the actual item needed via DI, if possible.</span></span>

* <span data-ttu-id="88452-297">Evitar el acceso estático a los servicios.</span><span class="sxs-lookup"><span data-stu-id="88452-297">Avoid static access to services.</span></span>

* <span data-ttu-id="88452-298">Evite la ubicación del servicio en el código de aplicación.</span><span class="sxs-lookup"><span data-stu-id="88452-298">Avoid service location in your application code.</span></span>

* <span data-ttu-id="88452-299">Evitar el acceso estático a `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="88452-299">Avoid static access to `HttpContext`.</span></span>

> [!NOTE]
> <span data-ttu-id="88452-300">Al igual que todos los conjuntos de recomendaciones, puede encontrar situaciones donde se requiere omite uno.</span><span class="sxs-lookup"><span data-stu-id="88452-300">Like all sets of recommendations, you may encounter situations where ignoring one is required.</span></span> <span data-ttu-id="88452-301">Hemos encontrado excepciones deben ser infrecuentes--casos principalmente muy especiales en el marco de trabajo.</span><span class="sxs-lookup"><span data-stu-id="88452-301">We have found exceptions to be rare -- mostly very special cases within the framework itself.</span></span>

<span data-ttu-id="88452-302">Recuerde que la inyección de dependencia es un *alternativo* con los patrones de acceso de objeto estático o de forma global.</span><span class="sxs-lookup"><span data-stu-id="88452-302">Remember, dependency injection is an *alternative* to static/global object access patterns.</span></span> <span data-ttu-id="88452-303">No podrá aprovechar las ventajas de DI Si mezcla con el acceso a objetos estáticos.</span><span class="sxs-lookup"><span data-stu-id="88452-303">You will not be able to realize the benefits of DI if you mix it with static object access.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="88452-304">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="88452-304">Additional Resources</span></span>

* [<span data-ttu-id="88452-305">Inicio de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="88452-305">Application Startup</span></span>](startup.md)

* [<span data-ttu-id="88452-306">Pruebas</span><span class="sxs-lookup"><span data-stu-id="88452-306">Testing</span></span>](../testing/index.md)

* [<span data-ttu-id="88452-307">Escribir código correcto en el núcleo de ASP.NET con la inserción de dependencias (MSDN)</span><span class="sxs-lookup"><span data-stu-id="88452-307">Writing Clean Code in ASP.NET Core with Dependency Injection (MSDN)</span></span>](https://msdn.microsoft.com/magazine/mt703433.aspx)

* [<span data-ttu-id="88452-308">Administrado por el contenedor de diseño de la aplicación, preludio: Que lleva el contenedor pertenecen?</span><span class="sxs-lookup"><span data-stu-id="88452-308">Container-Managed Application Design, Prelude: Where does the Container Belong?</span></span>](https://blogs.msdn.microsoft.com/nblumhardt/2008/12/26/container-managed-application-design-prelude-where-does-the-container-belong/)

* [<span data-ttu-id="88452-309">Principio de dependencias explícitas</span><span class="sxs-lookup"><span data-stu-id="88452-309">Explicit Dependencies Principle</span></span>](http://deviq.com/explicit-dependencies-principle/)

* <span data-ttu-id="88452-310">[Inversión de contenedores de controles y el patrón de inyección de dependencia](https://www.martinfowler.com/articles/injection.html) (Fowler)</span><span class="sxs-lookup"><span data-stu-id="88452-310">[Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html) (Fowler)</span></span>
