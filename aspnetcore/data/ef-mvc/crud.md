---
title: "Núcleo de ASP.NET MVC con EF Core - CRUD - 2 de 10"
author: tdykstra
description: 
keywords: ASP.NET Core, Entity Framework Core, CRUD, crear, leer, actualizar, eliminar
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.assetid: 6e1cd570-40f1-4b24-8b6e-7d2d27758f18
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/crud
ms.openlocfilehash: 87aa7e63b1a08e457c5fdcbc052bfa039b8d2175
ms.sourcegitcommit: 9cdbfd0d670d70b9c354216aabee260c52dad5ee
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/12/2017
---
# <a name="create-read-update-and-delete---ef-core-with-aspnet-core-mvc-tutorial-2-of-10"></a><span data-ttu-id="6038f-103">Crear, leer, actualizar y eliminar - Core EF con el tutorial de MVC de ASP.NET Core (2 de 10)</span><span class="sxs-lookup"><span data-stu-id="6038f-103">Create, Read, Update, and Delete - EF Core with ASP.NET Core MVC tutorial (2 of 10)</span></span>

<span data-ttu-id="6038f-104">Por [Tom Dykstra](https://github.com/tdykstra) y [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="6038f-104">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="6038f-105">La aplicación web de ejemplo de la Universidad de Contoso muestra cómo crear aplicaciones web de MVC de ASP.NET Core con Entity Framework Core y Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="6038f-105">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="6038f-106">Para obtener información acerca de la serie de tutoriales, vea [el primer tutorial de la serie](intro.md).</span><span class="sxs-lookup"><span data-stu-id="6038f-106">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="6038f-107">En el tutorial anterior, creó una aplicación MVC que almacena y muestra los datos con Entity Framework y SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="6038f-107">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="6038f-108">En este tutorial, podrá revisar y personalizar el CRUD (crear, leer, actualizar y eliminar) código que el scaffolding de MVC crea automáticamente para usted en controladores y vistas.</span><span class="sxs-lookup"><span data-stu-id="6038f-108">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE] 
> <span data-ttu-id="6038f-109">Es una práctica común para implementar el modelo de repositorio con el fin de crear una capa de abstracción entre el controlador y la capa de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-109">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="6038f-110">Para mantener estos tutoriales sencilla y se centra en enseña a usar el marco de trabajo de entidad, no usan repositorios.</span><span class="sxs-lookup"><span data-stu-id="6038f-110">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="6038f-111">Para obtener información acerca de los repositorios con EF, consulte [del último tutorial de esta serie](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="6038f-111">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="6038f-112">En este tutorial, trabajará con las páginas web siguientes:</span><span class="sxs-lookup"><span data-stu-id="6038f-112">In this tutorial, you'll work with the following web pages:</span></span>

![Página de detalles de estudiante](crud/_static/student-details.png)

![Página de creación de estudiante](crud/_static/student-create.png)

![Página de edición de estudiante](crud/_static/student-edit.png)

![Página de borrado de estudiante](crud/_static/student-delete.png)

## <a name="customize-the-details-page"></a><span data-ttu-id="6038f-117">Personalizar la página de detalles</span><span class="sxs-lookup"><span data-stu-id="6038f-117">Customize the Details page</span></span>

<span data-ttu-id="6038f-118">El código con scaffolding de la página de índice de los alumnos se deja fuera del `Enrollments` propiedad, porque esta propiedad contiene una colección.</span><span class="sxs-lookup"><span data-stu-id="6038f-118">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="6038f-119">En el **detalles** página, se mostrará el contenido de la colección en una tabla HTML.</span><span class="sxs-lookup"><span data-stu-id="6038f-119">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="6038f-120">En *Controllers/StudentsController.cs*, el método de acción para los detalles de la vista utiliza la `SingleOrDefaultAsync` método para recuperar un único `Student` entidad.</span><span class="sxs-lookup"><span data-stu-id="6038f-120">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="6038f-121">Agregue código que llama a `Include`.</span><span class="sxs-lookup"><span data-stu-id="6038f-121">Add code that calls `Include`.</span></span> <span data-ttu-id="6038f-122">`ThenInclude`, y `AsNoTracking` métodos, como se muestra en el código que aparece resaltado.</span><span class="sxs-lookup"><span data-stu-id="6038f-122">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

<span data-ttu-id="6038f-123">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]</span><span class="sxs-lookup"><span data-stu-id="6038f-123">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]</span></span>

<span data-ttu-id="6038f-124">El `Include` y `ThenInclude` métodos hacen que el contexto cargar la `Student.Enrollments` propiedad de navegación y dentro de cada inscripción el `Enrollment.Course` propiedad de navegación.</span><span class="sxs-lookup"><span data-stu-id="6038f-124">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="6038f-125">Aprenderá más acerca de estos métodos en el [leer datos relacionados](read-related-data.md) tutorial.</span><span class="sxs-lookup"><span data-stu-id="6038f-125">You'll learn more about these methods in the [reading related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="6038f-126">El `AsNoTracking` método mejora el rendimiento en escenarios donde no se actualizará las entidades devueltas en la duración del contexto actual.</span><span class="sxs-lookup"><span data-stu-id="6038f-126">The `AsNoTracking` method improves performance in scenarios where the entities returned will not be updated in the current context's lifetime.</span></span> <span data-ttu-id="6038f-127">Aprenderá más acerca de `AsNoTracking` al final de este tutorial.</span><span class="sxs-lookup"><span data-stu-id="6038f-127">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="6038f-128">Datos de ruta</span><span class="sxs-lookup"><span data-stu-id="6038f-128">Route data</span></span>

<span data-ttu-id="6038f-129">El valor de clave que se pasa a la `Details` método procede de *enrutar datos*.</span><span class="sxs-lookup"><span data-stu-id="6038f-129">The key value that is passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="6038f-130">Datos de ruta son datos que el enlazador de modelos que se encuentra en un segmento de la dirección URL.</span><span class="sxs-lookup"><span data-stu-id="6038f-130">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="6038f-131">Por ejemplo, la ruta predeterminada especifica segmentos controlador, acción e Id.:</span><span class="sxs-lookup"><span data-stu-id="6038f-131">For example, the default route specifies controller, action, and id segments:</span></span>

<span data-ttu-id="6038f-132">[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]</span><span class="sxs-lookup"><span data-stu-id="6038f-132">[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]</span></span>

<span data-ttu-id="6038f-133">En la siguiente dirección URL, la ruta predeterminada se asigna Instructor como el controlador, el índice como la acción y 1 como el identificador; Éstos son valores de datos de ruta.</span><span class="sxs-lookup"><span data-stu-id="6038f-133">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="6038f-134">La última parte de la dirección URL ("? courseID = 2021") es un valor de cadena de consulta.</span><span class="sxs-lookup"><span data-stu-id="6038f-134">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="6038f-135">El enlazador de modelos también pasará el valor de identificador para la `Details` método `id` parámetro si se pasa como un valor de cadena de consulta:</span><span class="sxs-lookup"><span data-stu-id="6038f-135">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="6038f-136">En la página de índice, se crean direcciones URL del hipervínculo por las instrucciones de la aplicación auxiliar de etiqueta en la vista de Razor.</span><span class="sxs-lookup"><span data-stu-id="6038f-136">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="6038f-137">En el siguiente código Razor, el `id` parámetro coincide con la ruta predeterminada, por lo que `id` se agrega a los datos de ruta.</span><span class="sxs-lookup"><span data-stu-id="6038f-137">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="6038f-138">Esto genera el siguiente código HTML cuando `item.ID` es 6:</span><span class="sxs-lookup"><span data-stu-id="6038f-138">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="6038f-139">En el siguiente código Razor, `studentID` no coincide con un parámetro en la ruta predeterminada, por lo que se agrega como una cadena de consulta.</span><span class="sxs-lookup"><span data-stu-id="6038f-139">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="6038f-140">Esto genera el siguiente código HTML cuando `item.ID` es 6:</span><span class="sxs-lookup"><span data-stu-id="6038f-140">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="6038f-141">Para obtener más información acerca de aplicaciones auxiliares de etiquetas, consulte [aplicaciones auxiliares de etiquetas en ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span><span class="sxs-lookup"><span data-stu-id="6038f-141">For more information about tag helpers, see [Tag helpers in ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="6038f-142">Agregue las inscripciones a la vista de detalles</span><span class="sxs-lookup"><span data-stu-id="6038f-142">Add enrollments to the Details view</span></span>

<span data-ttu-id="6038f-143">Abra *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="6038f-143">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="6038f-144">Cada campo se muestra mediante `DisplayNameFor` y `DisplayFor` aplicaciones auxiliares, como se muestra en el ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="6038f-144">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="6038f-145">Después del último campo e inmediatamente antes del cierre `</dl>` etiqueta, agregue el código siguiente para mostrar una lista de las inscripciones:</span><span class="sxs-lookup"><span data-stu-id="6038f-145">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="6038f-146">Si no es correcta la sangría del código después de pegar el código, presione CTRL-K-D para corregirlo.</span><span class="sxs-lookup"><span data-stu-id="6038f-146">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="6038f-147">Este código recorre las entidades en el `Enrollments` propiedad de navegación.</span><span class="sxs-lookup"><span data-stu-id="6038f-147">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="6038f-148">Para cada inscripción muestra el título del curso y el grado de.</span><span class="sxs-lookup"><span data-stu-id="6038f-148">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="6038f-149">Se recupera el título del curso de la entidad de curso que se almacena en la `Course` propiedad de navegación de la entidad de inscripciones.</span><span class="sxs-lookup"><span data-stu-id="6038f-149">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="6038f-150">Ejecute la aplicación, seleccione la **estudiantes** ficha y haga clic en el **detalles** vínculo acerca de un estudiante.</span><span class="sxs-lookup"><span data-stu-id="6038f-150">Run the application, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="6038f-151">Ver la lista de cursos y sus notas para el alumno seleccionado:</span><span class="sxs-lookup"><span data-stu-id="6038f-151">You see the list of courses and grades for the selected student:</span></span>

![Página de detalles de estudiante](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="6038f-153">Actualizar la página Crear</span><span class="sxs-lookup"><span data-stu-id="6038f-153">Update the Create page</span></span>

<span data-ttu-id="6038f-154">En *StudentsController.cs*, modifique el HttpPost `Create` método agregando un bloque try-catch y quitar Id. de la `Bind` atributo.</span><span class="sxs-lookup"><span data-stu-id="6038f-154">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

<span data-ttu-id="6038f-155">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]</span><span class="sxs-lookup"><span data-stu-id="6038f-155">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]</span></span>

<span data-ttu-id="6038f-156">Este código agrega la entidad de estudiantes creada por el enlazador de modelos de ASP.NET MVC a la entidad de los alumnos establece y, a continuación, guarda los cambios en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-156">This code adds the Student entity created by the ASP.NET MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="6038f-157">(Enlazador de modelos se refiere a la funcionalidad de ASP.NET MVC que resulta más sencillo para trabajar con datos enviados por un formulario; un enlazador de modelos convierte los valores de formulario expuesto a tipos de CLR y los pasa al método de acción en parámetros.</span><span class="sxs-lookup"><span data-stu-id="6038f-157">(Model binder refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="6038f-158">En este caso, el enlazador de modelos crea instancias de una entidad de estudiante automáticamente con valores de propiedad de la colección de formulario.)</span><span class="sxs-lookup"><span data-stu-id="6038f-158">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="6038f-159">Que se han suprimido `ID` desde el `Bind` atributo porque Id. es el valor de clave principal que SQL Server establecerá automáticamente cuando se inserta la fila.</span><span class="sxs-lookup"><span data-stu-id="6038f-159">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="6038f-160">Entrada del usuario no establece el valor de identificador.</span><span class="sxs-lookup"><span data-stu-id="6038f-160">Input from the user does not set the ID value.</span></span>

<span data-ttu-id="6038f-161">Distinto de la `Bind` atributo, el bloque try-catch es el único cambio que haya realizado en el código con scaffolding.</span><span class="sxs-lookup"><span data-stu-id="6038f-161">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="6038f-162">Si una excepción que se deriva de `DbUpdateException` es detecta mientras se guardan los cambios, se muestra un mensaje de error genérico.</span><span class="sxs-lookup"><span data-stu-id="6038f-162">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="6038f-163">`DbUpdateException`excepciones se deben a veces por algo externo a la aplicación en lugar de un error de programación, por lo que el usuario se recomienda que vuelva a intentarlo.</span><span class="sxs-lookup"><span data-stu-id="6038f-163">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="6038f-164">Aunque no ha implementado en este ejemplo, una aplicación de calidad de producción debería registrar la excepción.</span><span class="sxs-lookup"><span data-stu-id="6038f-164">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="6038f-165">Para obtener más información, consulte el **registro para obtener información** sección [supervisión y telemetría (creación reales en la nube de aplicaciones con Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="6038f-165">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="6038f-166">El `ValidateAntiForgeryToken` atributo ayuda a evitar ataques de falsificación (CSRF) de solicitud entre sitios.</span><span class="sxs-lookup"><span data-stu-id="6038f-166">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="6038f-167">El token se inserta automáticamente en la vista de la [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) y se incluye cuando se envía el formulario por el usuario.</span><span class="sxs-lookup"><span data-stu-id="6038f-167">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="6038f-168">El token se valida mediante el `ValidateAntiForgeryToken` atributo.</span><span class="sxs-lookup"><span data-stu-id="6038f-168">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="6038f-169">Para obtener más información acerca de CSRF, consulte [falsificación de Anti-solicitudes](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="6038f-169">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="6038f-170">Nota de seguridad sobre overposting</span><span class="sxs-lookup"><span data-stu-id="6038f-170">Security note about overposting</span></span>

<span data-ttu-id="6038f-171">El `Bind` atributo que incluye el código con scaffolding en el `Create` método es una manera de proteger contra overposting en crear escenarios.</span><span class="sxs-lookup"><span data-stu-id="6038f-171">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="6038f-172">Por ejemplo, suponga que la entidad Student incluye un `Secret` propiedad que no desea que esta página web para establecer.</span><span class="sxs-lookup"><span data-stu-id="6038f-172">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="6038f-173">Incluso si no tienes un `Secret` campo en la página web, un pirata informático podría usar una herramienta como Fiddler o escribir código de JavaScript, para registrar un `Secret` formar el valor.</span><span class="sxs-lookup"><span data-stu-id="6038f-173">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="6038f-174">Sin el `Bind` atributo limitar los campos que el enlazador de modelos que se utiliza cuando crea una instancia de estudiantes, el enlazador de modelos seleccionará que `Secret` formato de valor y usarlo para crear la instancia de entidad de estudiante.</span><span class="sxs-lookup"><span data-stu-id="6038f-174">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="6038f-175">A continuación, cualquier valor el pirata especificado para el `Secret` campo de formulario se actualizarán en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-175">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="6038f-176">La siguiente imagen muestra la adición de la herramienta de Fiddler el `Secret` campo (con el valor "OverPost") a los valores de formulario expuesto.</span><span class="sxs-lookup"><span data-stu-id="6038f-176">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Campo de secreto adición de Fiddler](crud/_static/fiddler.png)

<span data-ttu-id="6038f-178">El valor "OverPost", a continuación, se agregaría correctamente a la `Secret` propiedad de las filas insertadas de fila, aunque se habían previsto que la página web pueda establece esta propiedad.</span><span class="sxs-lookup"><span data-stu-id="6038f-178">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="6038f-179">Puede evitar overposting en escenarios de edición leer primero la entidad desde la base de datos y, a continuación, llamando a `TryUpdateModel`, pasando una lista de propiedades permitidas explícita.</span><span class="sxs-lookup"><span data-stu-id="6038f-179">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="6038f-180">Que es el método utilizado en estos tutoriales.</span><span class="sxs-lookup"><span data-stu-id="6038f-180">That is the method used in these tutorials.</span></span>

<span data-ttu-id="6038f-181">Es una manera alternativa para evitar que overposting que muchos desarrolladores prefieren usar modelos de vista en lugar de las clases de entidad con el enlace de modelos.</span><span class="sxs-lookup"><span data-stu-id="6038f-181">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="6038f-182">Incluir solo las propiedades que desea actualizar en el modelo de vista.</span><span class="sxs-lookup"><span data-stu-id="6038f-182">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="6038f-183">Una vez que haya finalizado el enlazador de modelos MVC, copie las propiedades del modelo de vista a la instancia de entidad, opcionalmente mediante una herramienta como AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="6038f-183">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="6038f-184">Use `_context.Entry` en la instancia de entidad para establecer su estado en `Unchanged`y, a continuación, establezca `Property("PropertyName").IsModified` en true en cada propiedad de entidad que se incluye en el modelo de vista.</span><span class="sxs-lookup"><span data-stu-id="6038f-184">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="6038f-185">Este método da tanto en Editar y crear escenarios.</span><span class="sxs-lookup"><span data-stu-id="6038f-185">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="6038f-186">Probar la página Crear</span><span class="sxs-lookup"><span data-stu-id="6038f-186">Test the Create page</span></span>

<span data-ttu-id="6038f-187">El código en *Views/Students/Create.cshtml* utiliza `label`, `input`, y `span` (para los mensajes de validación) aplicaciones auxiliares para cada campo de etiquetas.</span><span class="sxs-lookup"><span data-stu-id="6038f-187">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="6038f-188">Ejecute la página seleccionando el **estudiantes** ficha y haga clic en **crear nuevo**.</span><span class="sxs-lookup"><span data-stu-id="6038f-188">Run the page by selecting the **Students** tab and clicking **Create New**.</span></span>

<span data-ttu-id="6038f-189">Especifique una fecha y nombres.</span><span class="sxs-lookup"><span data-stu-id="6038f-189">Enter names and a date.</span></span> <span data-ttu-id="6038f-190">Pruebe a escribir una fecha no válida si el explorador le permite hacerlo.</span><span class="sxs-lookup"><span data-stu-id="6038f-190">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="6038f-191">(Algunos exploradores obligan a utilizar un selector de fecha.) A continuación, haga clic en **crear** para ver el mensaje de error.</span><span class="sxs-lookup"><span data-stu-id="6038f-191">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Error de validación de fecha](crud/_static/date-error.png)

<span data-ttu-id="6038f-193">Se trata de validación del lado servidor que obtendrá de forma predeterminada; en un tutorial posterior verá cómo agregar atributos que se generarán código para la validación del lado cliente también.</span><span class="sxs-lookup"><span data-stu-id="6038f-193">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="6038f-194">El siguiente código resaltado muestra la comprobación de validación del modelo en el `Create` método.</span><span class="sxs-lookup"><span data-stu-id="6038f-194">The following highlighted code shows the model validation check in the `Create` method.</span></span>

<span data-ttu-id="6038f-195">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]</span><span class="sxs-lookup"><span data-stu-id="6038f-195">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]</span></span>

<span data-ttu-id="6038f-196">Cambie la fecha a un valor válido y haga clic en **crear** para ver el nuevo alumno aparecen en la **índice** página.</span><span class="sxs-lookup"><span data-stu-id="6038f-196">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="6038f-197">Actualizar la página de edición</span><span class="sxs-lookup"><span data-stu-id="6038f-197">Update the Edit page</span></span>

<span data-ttu-id="6038f-198">En *StudentController.cs*, el HttpGet `Edit` método (uno sin el `HttpPost` atributo) usa el `SingleOrDefaultAsync` método para recuperar la entidad seleccionada de estudiantes, tal y como se vio en el `Details` método.</span><span class="sxs-lookup"><span data-stu-id="6038f-198">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="6038f-199">No es necesario cambiar este método.</span><span class="sxs-lookup"><span data-stu-id="6038f-199">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="6038f-200">Recomienda HttpPost editar código: lectura y actualización</span><span class="sxs-lookup"><span data-stu-id="6038f-200">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="6038f-201">Reemplace el método de acción HttpPost editar con el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="6038f-201">Replace the HttpPost Edit action method with the following code.</span></span>

<span data-ttu-id="6038f-202">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]</span><span class="sxs-lookup"><span data-stu-id="6038f-202">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]</span></span>

<span data-ttu-id="6038f-203">Estos cambios implementan una práctica recomendada de seguridad para evitar overposting.</span><span class="sxs-lookup"><span data-stu-id="6038f-203">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="6038f-204">El scaffolder genera un `Bind` de atributo y agrega la entidad creada por el enlazador de modelos a la entidad establecida con un `Modified` marca.</span><span class="sxs-lookup"><span data-stu-id="6038f-204">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="6038f-205">Que no se recomienda código para muchos escenarios porque la `Bind` atributo borra los datos previamente existentes en los campos no aparecen en la `Include` parámetro.</span><span class="sxs-lookup"><span data-stu-id="6038f-205">That code is not recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="6038f-206">El nuevo código lee la entidad existente y llama `TryUpdateModel` para actualizar los campos en la entidad recuperada [en función de la entrada del usuario en los datos de formulario expuesto](xref:mvc/models/model-binding#how-model-binding-works).</span><span class="sxs-lookup"><span data-stu-id="6038f-206">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="6038f-207">Seguimiento de conjuntos de cambios automático de Entity Framework la `Modified` marca en los campos que se cambian mediante la entrada de formulario.</span><span class="sxs-lookup"><span data-stu-id="6038f-207">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="6038f-208">Cuando el `SaveChanges` se llama al método, Entity Framework crea instrucciones SQL para actualizar la fila de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-208">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="6038f-209">Conflictos de simultaneidad se omiten y las columnas de tabla que se actualizaron por el usuario se actualizan en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-209">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="6038f-210">(Un tutorial posterior muestra cómo controlar los conflictos de simultaneidad).</span><span class="sxs-lookup"><span data-stu-id="6038f-210">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="6038f-211">Como práctica recomendada para evitar la publicación excesiva, los campos que desea que se pueda actualizar por la **editar** en la lista de permitidos son los `TryUpdateModel` parámetros.</span><span class="sxs-lookup"><span data-stu-id="6038f-211">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="6038f-212">(La cadena vacía anterior a la lista de campos en la lista de parámetros es para que un prefijo para utilizarlo con los nombres de campos de formulario). Actualmente no hay ningún campo adicional que va a proteger, pero mostrar los campos que desea que el enlazador de modelos para enlazar garantiza que si agrega campos para el modelo de datos en el futuro, que están automáticamente protegidos hasta que se agreguen de forma explícita aquí.</span><span class="sxs-lookup"><span data-stu-id="6038f-212">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="6038f-213">Como resultado de estos cambios, la firma del método de la HttpPost `Edit` método es el mismo que el HttpGet `Edit` método; por lo tanto, se ha cambiado el nombre del método `EditPost`.</span><span class="sxs-lookup"><span data-stu-id="6038f-213">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="6038f-214">Código de edición HttpPost alternativo: crear y adjuntar</span><span class="sxs-lookup"><span data-stu-id="6038f-214">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="6038f-215">El código para modificar HttpPost recomendado garantiza que solo las columnas cambiadas se actualizan y conserva los datos de las propiedades que no desea que incluyen para el enlace de modelos.</span><span class="sxs-lookup"><span data-stu-id="6038f-215">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="6038f-216">Sin embargo, el enfoque basado principalmente de lectura requiere una base de datos adicional de lectura y puede dar lugar a un código más complejo para tratar los conflictos de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="6038f-216">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="6038f-217">Una alternativa consiste en adjuntar una entidad creada por el enlazador de modelos en el contexto EF y se marca como modificada.</span><span class="sxs-lookup"><span data-stu-id="6038f-217">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="6038f-218">(No se actualiza el proyecto con este código, solo se muestra para ilustrar un enfoque opcional.)</span><span class="sxs-lookup"><span data-stu-id="6038f-218">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span> 

<span data-ttu-id="6038f-219">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]</span><span class="sxs-lookup"><span data-stu-id="6038f-219">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]</span></span>

<span data-ttu-id="6038f-220">Puede usar este enfoque cuando la interfaz de usuario de la página web incluye todos los campos de la entidad y se puede actualizar cualquiera de ellos.</span><span class="sxs-lookup"><span data-stu-id="6038f-220">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="6038f-221">El código con scaffolding utiliza el enfoque de crear y adjuntar, sino solo detecta `DbUpdateConcurrencyException` excepciones y devuelve códigos de error 404.</span><span class="sxs-lookup"><span data-stu-id="6038f-221">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="6038f-222">El ejemplo mostrado detecta cualquier excepción de actualización de base de datos y muestra un mensaje de error.</span><span class="sxs-lookup"><span data-stu-id="6038f-222">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="6038f-223">Estados de entidad</span><span class="sxs-lookup"><span data-stu-id="6038f-223">Entity States</span></span>

<span data-ttu-id="6038f-224">El contexto de base de datos realiza un seguimiento de si las entidades en memoria están sincronizadas con sus filas correspondientes en la base de datos, y esta información determina lo que ocurre cuando se llama a la `SaveChanges` método.</span><span class="sxs-lookup"><span data-stu-id="6038f-224">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="6038f-225">Por ejemplo, cuando se pasa una nueva entidad a la `Add` método, que el estado de la entidad se establece en `Added`.</span><span class="sxs-lookup"><span data-stu-id="6038f-225">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="6038f-226">A continuación, cuando se llama a la `SaveChanges` método, el contexto de base de datos emite un comando INSERT de SQL.</span><span class="sxs-lookup"><span data-stu-id="6038f-226">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="6038f-227">Una entidad puede estar en uno de los siguientes estados:</span><span class="sxs-lookup"><span data-stu-id="6038f-227">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="6038f-228">`Added`.</span><span class="sxs-lookup"><span data-stu-id="6038f-228">`Added`.</span></span> <span data-ttu-id="6038f-229">La entidad no existe todavía en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-229">The entity does not yet exist in the database.</span></span> <span data-ttu-id="6038f-230">El `SaveChanges` método emite una instrucción INSERT.</span><span class="sxs-lookup"><span data-stu-id="6038f-230">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="6038f-231">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="6038f-231">`Unchanged`.</span></span> <span data-ttu-id="6038f-232">Nada debe hacerse con esta entidad mediante el `SaveChanges` método.</span><span class="sxs-lookup"><span data-stu-id="6038f-232">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="6038f-233">Al leer una entidad de la base de datos, la entidad empieza con este estado.</span><span class="sxs-lookup"><span data-stu-id="6038f-233">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="6038f-234">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="6038f-234">`Modified`.</span></span> <span data-ttu-id="6038f-235">Se han modificado algunos o todos los valores de propiedad de la entidad.</span><span class="sxs-lookup"><span data-stu-id="6038f-235">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="6038f-236">El `SaveChanges` método emite una instrucción UPDATE.</span><span class="sxs-lookup"><span data-stu-id="6038f-236">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="6038f-237">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="6038f-237">`Deleted`.</span></span> <span data-ttu-id="6038f-238">La entidad se ha marcado para su eliminación.</span><span class="sxs-lookup"><span data-stu-id="6038f-238">The entity has been marked for deletion.</span></span> <span data-ttu-id="6038f-239">El `SaveChanges` método emite una instrucción DELETE.</span><span class="sxs-lookup"><span data-stu-id="6038f-239">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="6038f-240">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="6038f-240">`Detached`.</span></span> <span data-ttu-id="6038f-241">La entidad no sometida a seguimiento por el contexto de base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-241">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="6038f-242">En una aplicación de escritorio, normalmente se establecen automáticamente los cambios de estado.</span><span class="sxs-lookup"><span data-stu-id="6038f-242">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="6038f-243">Leer una entidad y realizar cambios en algunas de sus valores de propiedad.</span><span class="sxs-lookup"><span data-stu-id="6038f-243">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="6038f-244">Esto hace que su estado de entidad que se cambie automáticamente al `Modified`.</span><span class="sxs-lookup"><span data-stu-id="6038f-244">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="6038f-245">A continuación, cuando se llama a `SaveChanges`, Entity Framework genera una instrucción UPDATE de SQL que actualiza solo las propiedades reales que se cambió.</span><span class="sxs-lookup"><span data-stu-id="6038f-245">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="6038f-246">En una aplicación web, el `DbContext` que inicialmente lee una entidad y muestra sus datos que se pueda editar se eliminan una vez que se representa una página.</span><span class="sxs-lookup"><span data-stu-id="6038f-246">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="6038f-247">Cuando el HttpPost `Edit` se llama al método de acción, se realiza una nueva solicitud de web y tiene una nueva instancia de la `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="6038f-247">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="6038f-248">Si vuelve a leer la entidad en ese contexto nuevo, simular procesamiento escritorio.</span><span class="sxs-lookup"><span data-stu-id="6038f-248">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="6038f-249">Sin embargo, si no quiere realizar adicional de la operación de lectura, tiene que usar el objeto de entidad creado por el enlazador de modelos.</span><span class="sxs-lookup"><span data-stu-id="6038f-249">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="6038f-250">La manera más sencilla de hacerlo es establecer el estado de entidad en Modified tal y como se hace en el código de edición HttpPost alternativo mostrado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="6038f-250">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="6038f-251">A continuación, cuando se llama a `SaveChanges`, Entity Framework actualiza todas las columnas de la fila de la base de datos, porque el contexto no tiene ninguna manera de saber qué propiedades ha cambiado.</span><span class="sxs-lookup"><span data-stu-id="6038f-251">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="6038f-252">Si desea evitar el enfoque basado principalmente de lectura, pero también desea que la instrucción UPDATE de SQL para actualizar solo los campos que el usuario cambia realmente, el código es más complejo.</span><span class="sxs-lookup"><span data-stu-id="6038f-252">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="6038f-253">Debe guardar los valores originales de alguna manera (como mediante el uso de los campos ocultos) para que estén disponibles cuando el HttpPost `Edit` se llama al método.</span><span class="sxs-lookup"><span data-stu-id="6038f-253">You have to save the original values in some way (such as by using hidden fields) so that they are available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="6038f-254">A continuación, puede crear una entidad de Student con los valores originales, llamada la `Attach` método con esa versión original de la entidad, actualizar los valores de la entidad a los nuevos valores y, a continuación, llamar a `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="6038f-254">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="6038f-255">Probar la página de edición</span><span class="sxs-lookup"><span data-stu-id="6038f-255">Test the Edit page</span></span>

<span data-ttu-id="6038f-256">Ejecute la aplicación y seleccione la **estudiantes** ficha, a continuación, haga clic en un **editar** hipervínculo.</span><span class="sxs-lookup"><span data-stu-id="6038f-256">Run the application and select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Página de edición de estudiantes](crud/_static/student-edit.png)

<span data-ttu-id="6038f-258">Cambiar algunos de los datos y haga clic en **guardar**.</span><span class="sxs-lookup"><span data-stu-id="6038f-258">Change some of the data and click **Save**.</span></span> <span data-ttu-id="6038f-259">El **índice** se abre la página y verá los datos modificados.</span><span class="sxs-lookup"><span data-stu-id="6038f-259">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="6038f-260">Actualizar la página de borrado</span><span class="sxs-lookup"><span data-stu-id="6038f-260">Update the Delete page</span></span>

<span data-ttu-id="6038f-261">En *StudentController.cs*, el código de plantilla para el HttpGet `Delete` método usa la `SingleOrDefaultAsync` método para recuperar la entidad seleccionada de estudiantes, tal y como se vieron en los detalles y modificar métodos.</span><span class="sxs-lookup"><span data-stu-id="6038f-261">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="6038f-262">Sin embargo, para implementar un mensaje de error personalizado cuando la llamada a `SaveChanges` se produce un error, agregará algunas funciones a este método y su vista correspondiente.</span><span class="sxs-lookup"><span data-stu-id="6038f-262">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="6038f-263">Como hemos visto de actualización y crea las operaciones, las operaciones de eliminación requieren dos métodos de acción.</span><span class="sxs-lookup"><span data-stu-id="6038f-263">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="6038f-264">El método que se llama en respuesta a una solicitud GET muestra una vista que proporciona al usuario una oportunidad para aprobar o cancelar la operación de eliminación.</span><span class="sxs-lookup"><span data-stu-id="6038f-264">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="6038f-265">Si el usuario lo aprueba, se crea una solicitud POST.</span><span class="sxs-lookup"><span data-stu-id="6038f-265">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="6038f-266">Cuando esto ocurre, el HttpPost `Delete` se llama al método y, a continuación, este método realiza la operación de eliminación.</span><span class="sxs-lookup"><span data-stu-id="6038f-266">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="6038f-267">Agregará un bloque try-catch para el HttpPost `Delete` método para controlar los errores que pueden producirse cuando se actualiza la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-267">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="6038f-268">Si se produce un error, el método HttpPost Delete llama al método de eliminación de HttpGet, pasando un parámetro que indica que se ha producido un error.</span><span class="sxs-lookup"><span data-stu-id="6038f-268">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="6038f-269">El método HttpGet Delete, a continuación, vuelve a mostrar la página de confirmación junto con el mensaje de error, dando al usuario la oportunidad de cancelar o vuelva a intentarlo.</span><span class="sxs-lookup"><span data-stu-id="6038f-269">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="6038f-270">Reemplace el HttpGet `Delete` método de acción con el código siguiente, que administra el informe de errores.</span><span class="sxs-lookup"><span data-stu-id="6038f-270">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

<span data-ttu-id="6038f-271">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]</span><span class="sxs-lookup"><span data-stu-id="6038f-271">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]</span></span>

<span data-ttu-id="6038f-272">Este código acepta un parámetro opcional que indica si se llamó al método después de un error al guardar los cambios.</span><span class="sxs-lookup"><span data-stu-id="6038f-272">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="6038f-273">Este parámetro es false cuando el HttpGet `Delete` método se llama sin un error anterior.</span><span class="sxs-lookup"><span data-stu-id="6038f-273">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="6038f-274">Cuando se llama por la HttpPost `Delete` método en respuesta a un error de actualización de base de datos, el parámetro es true y un mensaje de error se pasa a la vista.</span><span class="sxs-lookup"><span data-stu-id="6038f-274">When it is called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="6038f-275">El enfoque basado principalmente de lectura para HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="6038f-275">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="6038f-276">Reemplace el HttpPost `Delete` método de acción (denominado `DeleteConfirmed`) con el código siguiente, que realiza la operación de eliminación real y captura los errores de actualización de base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-276">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

<span data-ttu-id="6038f-277">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]</span><span class="sxs-lookup"><span data-stu-id="6038f-277">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]</span></span>

<span data-ttu-id="6038f-278">Este código recupera la entidad seleccionada, a continuación, llama el `Remove` método para establecer el estado de la entidad como `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="6038f-278">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="6038f-279">Cuando `SaveChanges` se denomina un DELETE de SQL se genere un comando.</span><span class="sxs-lookup"><span data-stu-id="6038f-279">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="6038f-280">El enfoque de crear y adjuntar a HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="6038f-280">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="6038f-281">Si mejora el rendimiento en una aplicación de gran volumen es una prioridad, podría impedir una consulta SQL innecesaria creando instancias de una entidad de estudiante con solo el principal valor y, a continuación, establecer el estado de entidad en la clave `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="6038f-281">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="6038f-282">Eso es todo lo que necesita de Entity Framework para eliminar la entidad.</span><span class="sxs-lookup"><span data-stu-id="6038f-282">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="6038f-283">(No coloque este código en el proyecto; aquí es únicamente para ilustrar una alternativa).</span><span class="sxs-lookup"><span data-stu-id="6038f-283">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

<span data-ttu-id="6038f-284">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]</span><span class="sxs-lookup"><span data-stu-id="6038f-284">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]</span></span>

<span data-ttu-id="6038f-285">Si la entidad con datos relacionados que también deben eliminarse, asegúrese de que la eliminación en cascada se configura en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-285">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="6038f-286">Con este enfoque a la eliminación de entidad, EF no podría saber que hay entidades relacionadas va a eliminar.</span><span class="sxs-lookup"><span data-stu-id="6038f-286">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="6038f-287">Actualizar la vista de eliminación</span><span class="sxs-lookup"><span data-stu-id="6038f-287">Update the Delete view</span></span>

<span data-ttu-id="6038f-288">En *Views/Student/Delete.cshtml*, agregar un mensaje de error entre el encabezado h2 y el título h3, tal como se muestra en el ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="6038f-288">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="6038f-289">Ejecute la página seleccionando el **estudiantes** ficha y haga clic en un **eliminar** hipervínculo:</span><span class="sxs-lookup"><span data-stu-id="6038f-289">Run the page by selecting the **Students** tab and clicking a **Delete** hyperlink:</span></span>

![Eliminar página de confirmación](crud/_static/student-delete.png)

<span data-ttu-id="6038f-291">Haga clic en **eliminar**.</span><span class="sxs-lookup"><span data-stu-id="6038f-291">Click **Delete**.</span></span> <span data-ttu-id="6038f-292">Se abrirá la página de índice sin los estudiantes eliminado.</span><span class="sxs-lookup"><span data-stu-id="6038f-292">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="6038f-293">(Verá un ejemplo de código de acción en el tutorial de simultaneidad de control de errores).</span><span class="sxs-lookup"><span data-stu-id="6038f-293">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="closing-database-connections"></a><span data-ttu-id="6038f-294">Cerrar las conexiones de base de datos</span><span class="sxs-lookup"><span data-stu-id="6038f-294">Closing database connections</span></span>

<span data-ttu-id="6038f-295">Para liberar los recursos que contiene una conexión de base de datos, la instancia de contexto debe eliminarse tan pronto como sea posible cuando haya terminado con él.</span><span class="sxs-lookup"><span data-stu-id="6038f-295">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="6038f-296">Integrado ASP.NET Core [inyección de dependencia](../../fundamentals/dependency-injection.md) se encarga de esa tarea.</span><span class="sxs-lookup"><span data-stu-id="6038f-296">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="6038f-297">En *Startup.cs*, se llama a la [método de extensión AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) para aprovisionar el `DbContext` clase en el contenedor de DI de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="6038f-297">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET DI container.</span></span> <span data-ttu-id="6038f-298">Que el método establece la duración del servicio en `Scoped` de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="6038f-298">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="6038f-299">`Scoped`significa que la duración del objeto de contexto coincide con el tiempo de vida de solicitud web, y el `Dispose` método llamará automáticamente al final de la solicitud web.</span><span class="sxs-lookup"><span data-stu-id="6038f-299">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handling-transactions"></a><span data-ttu-id="6038f-300">Controlar transacciones</span><span class="sxs-lookup"><span data-stu-id="6038f-300">Handling Transactions</span></span>

<span data-ttu-id="6038f-301">De forma predeterminada el Entity Framework implementa de manera implícita las transacciones.</span><span class="sxs-lookup"><span data-stu-id="6038f-301">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="6038f-302">En escenarios donde realizar cambios en varias filas o tablas y, a continuación, llamar a `SaveChanges`, Entity Framework automáticamente se asegura que todos los cambios se realizan correctamente o producirá un error en todas ellas.</span><span class="sxs-lookup"><span data-stu-id="6038f-302">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="6038f-303">Si se realizan algunos cambios en primer lugar y, a continuación, se produce un error, los cambios se deshacen automáticamente.</span><span class="sxs-lookup"><span data-stu-id="6038f-303">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="6038f-304">Para escenarios donde necesita más control, por ejemplo, si van a incluir operaciones realizadas fuera de Entity Framework en una transacción, consulte [transacciones](https://docs.microsoft.com/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="6038f-304">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](https://docs.microsoft.com/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="6038f-305">Consultas de seguimiento no</span><span class="sxs-lookup"><span data-stu-id="6038f-305">No-tracking queries</span></span>

<span data-ttu-id="6038f-306">Cuando un contexto de base de datos recupera las filas de tabla y crea objetos de entidad que tienen tipos de archivo, de forma predeterminada realiza un seguimiento de si las entidades en memoria están sincronizadas con el contenido de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="6038f-306">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="6038f-307">Los datos en memoria actúa como una memoria caché y se utilizan cuando se actualiza una entidad.</span><span class="sxs-lookup"><span data-stu-id="6038f-307">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="6038f-308">Este almacenamiento en caché a menudo es necesario en una aplicación web porque el contexto de instancias son normalmente de corta duración (un nuevo objeto uno se crea y se elimina para cada solicitud) y el contexto que lee una entidad normalmente se elimina antes de esa entidad se vuelve a usar.</span><span class="sxs-lookup"><span data-stu-id="6038f-308">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="6038f-309">Puede deshabilitar el seguimiento de los objetos de entidad en la memoria mediante una llamada a la `AsNoTracking` método.</span><span class="sxs-lookup"><span data-stu-id="6038f-309">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="6038f-310">En el que se puede hacer que los escenarios típicos son los siguientes:</span><span class="sxs-lookup"><span data-stu-id="6038f-310">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="6038f-311">Durante la vigencia de contexto no es necesario actualizar todas las entidades y no necesita EF a [cargar automáticamente las propiedades de navegación con entidades recuperadas por consultas independientes](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="6038f-311">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="6038f-312">Con frecuencia se cumplen estas condiciones en los métodos de acción del controlador HttpGet.</span><span class="sxs-lookup"><span data-stu-id="6038f-312">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="6038f-313">Se ejecuta una consulta que recupera un gran volumen de datos, y se actualizará solo una pequeña parte de los datos devueltos.</span><span class="sxs-lookup"><span data-stu-id="6038f-313">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="6038f-314">Puede ser más eficaz para desactivar el seguimiento de la consulta de gran tamaño y ejecutar una consulta más adelante para las entidades pocos que deben actualizarse.</span><span class="sxs-lookup"><span data-stu-id="6038f-314">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="6038f-315">Que desea asociar una entidad con el fin de actualizar, pero antes de recuperar la misma entidad para un propósito diferente.</span><span class="sxs-lookup"><span data-stu-id="6038f-315">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="6038f-316">Dado que la entidad ya está sometida a seguimiento por el contexto de base de datos, no se puede adjuntar la entidad que desea cambiar.</span><span class="sxs-lookup"><span data-stu-id="6038f-316">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="6038f-317">Una manera de controlar esta situación es llamar a `AsNoTracking` en la consulta anterior.</span><span class="sxs-lookup"><span data-stu-id="6038f-317">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="6038f-318">Para obtener más información, vea [seguimiento vs. Seguimiento de ningún](https://docs.microsoft.com/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="6038f-318">For more information, see [Tracking vs. No-Tracking](https://docs.microsoft.com/ef/core/querying/tracking).</span></span>

## <a name="summary"></a><span data-ttu-id="6038f-319">Resumen</span><span class="sxs-lookup"><span data-stu-id="6038f-319">Summary</span></span>

<span data-ttu-id="6038f-320">Ahora tiene un conjunto completo de páginas que realizan operaciones CRUD sencillas para entidades de estudiante.</span><span class="sxs-lookup"><span data-stu-id="6038f-320">You now have a complete set of pages that perform simple CRUD operations for Student entities.</span></span> <span data-ttu-id="6038f-321">En el siguiente tutorial se podrá expandir la funcionalidad de la **índice** página mediante la adición de ordenación, filtrado y paginación.</span><span class="sxs-lookup"><span data-stu-id="6038f-321">In the next tutorial you'll expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="6038f-322">[Anterior](intro.md)
[Siguiente](sort-filter-page.md)</span><span class="sxs-lookup"><span data-stu-id="6038f-322">[Previous](intro.md)
[Next](sort-filter-page.md)</span></span>  
