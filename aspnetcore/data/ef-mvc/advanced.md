---
title: "Núcleo de ASP.NET MVC con EF Core - avanzada - 10 de 10"
author: tdykstra
description: "Este tutorial presentan varios temas que son útiles para tener en cuenta cuando va más allá de los conceptos básicos sobre el desarrollo de aplicaciones web ASP.NET que usan Entity Framework Core."
keywords: "Núcleo de ASP.NET, Entity Framework Core, sql sin procesar, examinar sql, modelo de repositorio, unidad de trabajo patrón, la detección de cambios automático, base de datos existente"
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.assetid: 92a2986a-d005-4ff6-9559-6657fd466bb7
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/advanced
ms.openlocfilehash: d63502a32e38eb192b40f21f5cd57d20048154e3
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/10/2017
---
# <a name="advanced-topics---ef-core-with-aspnet-core-mvc-tutorial-10-of-10"></a><span data-ttu-id="69e15-104">Temas avanzados - Core EF con el tutorial de MVC de ASP.NET Core (10 de 10)</span><span class="sxs-lookup"><span data-stu-id="69e15-104">Advanced topics - EF Core with ASP.NET Core MVC tutorial (10 of 10)</span></span>

<span data-ttu-id="69e15-105">Por [Tom Dykstra](https://github.com/tdykstra) y [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="69e15-105">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="69e15-106">La aplicación web de ejemplo de la Universidad de Contoso muestra cómo crear aplicaciones web de MVC de ASP.NET Core con Entity Framework Core y Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="69e15-106">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="69e15-107">Para obtener información acerca de la serie de tutoriales, vea [el primer tutorial de la serie](intro.md).</span><span class="sxs-lookup"><span data-stu-id="69e15-107">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="69e15-108">En el tutorial anterior, se implementa la herencia de tabla por jerarquía.</span><span class="sxs-lookup"><span data-stu-id="69e15-108">In the previous tutorial, you implemented table-per-hierarchy inheritance.</span></span> <span data-ttu-id="69e15-109">Este tutorial presentan varios temas que son útiles para tener en cuenta cuando va más allá de los conceptos básicos sobre el desarrollo de aplicaciones web de ASP.NET Core que usan Entity Framework Core.</span><span class="sxs-lookup"><span data-stu-id="69e15-109">This tutorial introduces several topics that are useful to be aware of when you go beyond the basics of developing ASP.NET Core web applications that use Entity Framework Core.</span></span>

## <a name="raw-sql-queries"></a><span data-ttu-id="69e15-110">Consultas SQL sin formato</span><span class="sxs-lookup"><span data-stu-id="69e15-110">Raw SQL Queries</span></span>

<span data-ttu-id="69e15-111">Una de las ventajas del uso de Entity Framework es que evita enlazar el código demasiado ajustado a un método concreto de almacenamiento de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-111">One of the advantages of using the Entity Framework is that it avoids tying your code too closely to a particular method of storing data.</span></span> <span data-ttu-id="69e15-112">Hace esto mediante la generación de consultas SQL y comandos para usted, que también se evita tener que escribir usted mismo.</span><span class="sxs-lookup"><span data-stu-id="69e15-112">It does this by generating SQL queries and commands for you, which also frees you from having to write them yourself.</span></span> <span data-ttu-id="69e15-113">Pero hay situaciones excepcionales cuando se necesita ejecutar consultas específicas de SQL que ha creado manualmente.</span><span class="sxs-lookup"><span data-stu-id="69e15-113">But there are exceptional scenarios when you need to run specific SQL queries that you have manually created.</span></span> <span data-ttu-id="69e15-114">En estos casos, la API First de Entity Framework código incluye métodos que permiten pasar comandos SQL directamente a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-114">For these scenarios, the Entity Framework Code First API includes methods that enable you to pass SQL commands directly to the database.</span></span> <span data-ttu-id="69e15-115">Tiene las siguientes opciones en EF Core 1.0:</span><span class="sxs-lookup"><span data-stu-id="69e15-115">You have the following options in EF Core 1.0:</span></span>

* <span data-ttu-id="69e15-116">Use la `DbSet.FromSql` método para las consultas que devuelven tipos de entidad.</span><span class="sxs-lookup"><span data-stu-id="69e15-116">Use the `DbSet.FromSql` method for queries that return entity types.</span></span> <span data-ttu-id="69e15-117">Los objetos devueltos deben ser del tipo esperado por la `DbSet` objeto y se realiza automáticamente un seguimiento por el contexto de base de datos a menos que se [desactivar el seguimiento](crud.md#no-tracking-queries).</span><span class="sxs-lookup"><span data-stu-id="69e15-117">The returned objects must be of the type expected by the `DbSet` object, and they are automatically tracked by the database context unless you [turn tracking off](crud.md#no-tracking-queries).</span></span>

* <span data-ttu-id="69e15-118">Use la `Database.ExecuteSqlCommand` para comandos de consulta no.</span><span class="sxs-lookup"><span data-stu-id="69e15-118">Use the `Database.ExecuteSqlCommand` for non-query commands.</span></span>

<span data-ttu-id="69e15-119">Si tiene que ejecutar una consulta que devuelve tipos que no son entidades, puede usar ADO.NET con la conexión de base de datos proporcionada por EF.</span><span class="sxs-lookup"><span data-stu-id="69e15-119">If you need to run a query that returns types that aren't entities, you can use ADO.NET with the database connection provided by EF.</span></span> <span data-ttu-id="69e15-120">No realiza un seguimiento de los datos devueltos por el contexto de la base de datos, incluso si utiliza este método para recuperar tipos de entidad.</span><span class="sxs-lookup"><span data-stu-id="69e15-120">The returned data isn't tracked by the database context, even if you use this method to retrieve entity types.</span></span>

<span data-ttu-id="69e15-121">Como siempre es true cuando ejecuta comandos SQL en una aplicación web, debe tomar precauciones para proteger su sitio contra los ataques de inyección de SQL.</span><span class="sxs-lookup"><span data-stu-id="69e15-121">As is always true when you execute SQL commands in a web application, you must take precautions to protect your site against SQL injection attacks.</span></span> <span data-ttu-id="69e15-122">Una manera de hacerlo es utilizar consultas parametrizadas para asegurarse de que no se puede interpretar cadenas enviadas por una página web que los comandos SQL.</span><span class="sxs-lookup"><span data-stu-id="69e15-122">One way to do that is to use parameterized queries to make sure that strings submitted by a web page can't be interpreted as SQL commands.</span></span> <span data-ttu-id="69e15-123">En este tutorial usará las consultas con parámetros cuando se integra proporcionados por el usuario en una consulta.</span><span class="sxs-lookup"><span data-stu-id="69e15-123">In this tutorial you'll use parameterized queries when integrating user input into a query.</span></span>

## <a name="call-a-query-that-returns-entities"></a><span data-ttu-id="69e15-124">Llamar a una consulta que devuelve las entidades</span><span class="sxs-lookup"><span data-stu-id="69e15-124">Call a query that returns entities</span></span>

<span data-ttu-id="69e15-125">El `DbSet<TEntity>` clase proporciona un método que puede usar para ejecutar una consulta que devuelve una entidad de tipo `TEntity`.</span><span class="sxs-lookup"><span data-stu-id="69e15-125">The `DbSet<TEntity>` class provides a method that you can use to execute a query that returns an entity of type `TEntity`.</span></span> <span data-ttu-id="69e15-126">Para ver cómo funciona esto, cambiará el código en el `Details` método del controlador de departamento.</span><span class="sxs-lookup"><span data-stu-id="69e15-126">To see how this works you'll change the code in the `Details` method of the Department controller.</span></span>

<span data-ttu-id="69e15-127">En *DepartmentsController.cs*, en la `Details` método, reemplace el código que recupera un departamento con un `FromSql` llamada al método, como se muestra en el código resaltado siguiente:</span><span class="sxs-lookup"><span data-stu-id="69e15-127">In *DepartmentsController.cs*, in the `Details` method, replace the code that retrieves a department with a `FromSql` method call, as shown in the following highlighted code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_RawSQL&highlight=8,9,10,13)]

<span data-ttu-id="69e15-128">Para comprobar que el nuevo código funciona correctamente, seleccione la **departamentos** ficha y, a continuación, **detalles** para uno de los departamentos.</span><span class="sxs-lookup"><span data-stu-id="69e15-128">To verify that the new code works correctly, select the **Departments** tab and then **Details** for one of the departments.</span></span>

![Detalles del departamento](advanced/_static/department-details.png)

## <a name="call-a-query-that-returns-other-types"></a><span data-ttu-id="69e15-130">Llamar a una consulta que devuelve otros tipos</span><span class="sxs-lookup"><span data-stu-id="69e15-130">Call a query that returns other types</span></span>

<span data-ttu-id="69e15-131">Anteriormente, se crea una cuadrícula de estadísticas de estudiante de la página acerca de que el número de alumnos se ha explicado para cada fecha de inscripción.</span><span class="sxs-lookup"><span data-stu-id="69e15-131">Earlier you created a student statistics grid for the About page that showed the number of students for each enrollment date.</span></span> <span data-ttu-id="69e15-132">Obtuvo los datos en el conjunto de entidades de los alumnos (`_context.Students`) y utiliza LINQ para proyectar los resultados en una lista de `EnrollmentDateGroup` ver objetos del modelo.</span><span class="sxs-lookup"><span data-stu-id="69e15-132">You got the data from the Students entity set (`_context.Students`) and used LINQ to project the results into a list of `EnrollmentDateGroup` view model objects.</span></span> <span data-ttu-id="69e15-133">Suponga que desea escribir la instrucción SQL propia en lugar de usar LINQ.</span><span class="sxs-lookup"><span data-stu-id="69e15-133">Suppose you want to write the SQL itself rather than using LINQ.</span></span> <span data-ttu-id="69e15-134">Para hacer que se necesita ejecutar una consulta SQL que devuelve un valor distinto de objetos entidad.</span><span class="sxs-lookup"><span data-stu-id="69e15-134">To do that you need to run a SQL query that returns something other than entity objects.</span></span> <span data-ttu-id="69e15-135">En EF Core 1.0, una manera de hacerlo es escribir código de ADO.NET y obtener la conexión de base de datos de EF.</span><span class="sxs-lookup"><span data-stu-id="69e15-135">In EF Core 1.0, one way to do that is write ADO.NET code and get the database connection from EF.</span></span>

<span data-ttu-id="69e15-136">En *HomeController.cs*, reemplace el `About` método por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="69e15-136">In *HomeController.cs*, replace the `About` method with the following code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_UseRawSQL&highlight=3-32)]

<span data-ttu-id="69e15-137">Agregar un elemento using instrucción:</span><span class="sxs-lookup"><span data-stu-id="69e15-137">Add a using statement:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_Usings2)]

<span data-ttu-id="69e15-138">Ejecute la aplicación y vaya a la página acerca de.</span><span class="sxs-lookup"><span data-stu-id="69e15-138">Run the app and go to the About page.</span></span> <span data-ttu-id="69e15-139">Muestra los mismos datos que lo hacía anteriormente.</span><span class="sxs-lookup"><span data-stu-id="69e15-139">It displays the same data it did before.</span></span>

![Acerca de la página](advanced/_static/about.png)

## <a name="call-an-update-query"></a><span data-ttu-id="69e15-141">Llamar a una consulta update</span><span class="sxs-lookup"><span data-stu-id="69e15-141">Call an update query</span></span>

<span data-ttu-id="69e15-142">Imagine que desean que los administradores de la Universidad de Contoso realizar cambios globales en la base de datos, como cambiar el número de créditos para cada curso.</span><span class="sxs-lookup"><span data-stu-id="69e15-142">Suppose Contoso University administrators want to perform global changes in the database, such as changing the number of credits for every course.</span></span> <span data-ttu-id="69e15-143">Si la Universidad tiene un gran número de cursos, sería ineficaz para recuperarlos todos como entidades y cambiarlos de forma individual.</span><span class="sxs-lookup"><span data-stu-id="69e15-143">If the university has a large number of courses, it would be inefficient to retrieve them all as entities and change them individually.</span></span> <span data-ttu-id="69e15-144">En esta sección implementaremos una página web que permite al usuario especificar un factor por el que se va a cambiar el número de créditos para todos los cursos y podrá realizar el cambio mediante la ejecución de una instrucción UPDATE de SQL.</span><span class="sxs-lookup"><span data-stu-id="69e15-144">In this section you'll implement a web page that enables the user to specify a factor by which to change the number of credits for all courses, and you'll make the change by executing a SQL UPDATE statement.</span></span> <span data-ttu-id="69e15-145">La página web tendrá un aspecto similar de la ilustración siguiente:</span><span class="sxs-lookup"><span data-stu-id="69e15-145">The web page will look like the following illustration:</span></span>

![Página de créditos del curso de actualización](advanced/_static/update-credits.png)

<span data-ttu-id="69e15-147">En *CoursesContoller.cs*, agregue métodos UpdateCourseCredits para HttpGet y HttpPost:</span><span class="sxs-lookup"><span data-stu-id="69e15-147">In *CoursesContoller.cs*, add UpdateCourseCredits methods for HttpGet and HttpPost:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdateGet)]

[!code-csharp[Main](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdatePost)]

<span data-ttu-id="69e15-148">Cuando el controlador procesa una solicitud HttpGet, se devuelve nada en `ViewData["RowsAffected"]`, y la vista muestra un cuadro de texto vacío y un botón de envío, tal como se muestra en la ilustración anterior.</span><span class="sxs-lookup"><span data-stu-id="69e15-148">When the controller processes an HttpGet request, nothing is returned in `ViewData["RowsAffected"]`, and the view displays an empty text box and a submit button, as shown in the preceding illustration.</span></span>

<span data-ttu-id="69e15-149">Cuando el **actualización** se hace clic en el botón, se llama al método HttpPost y multiplicador tiene el valor especificado en el cuadro de texto.</span><span class="sxs-lookup"><span data-stu-id="69e15-149">When the **Update** button is clicked, the HttpPost method is called, and multiplier has the value entered in the text box.</span></span> <span data-ttu-id="69e15-150">El código, a continuación, ejecuta las instrucciones SQL que actualiza cursos y devuelve el número de filas afectadas a la vista en `ViewData`.</span><span class="sxs-lookup"><span data-stu-id="69e15-150">The code then executes the SQL that updates courses and returns the number of affected rows to the view in `ViewData`.</span></span> <span data-ttu-id="69e15-151">Cuando se obtiene la vista de un `RowsAffected` valor, muestra el número de filas actualizadas.</span><span class="sxs-lookup"><span data-stu-id="69e15-151">When the view gets a `RowsAffected` value, it displays the number of rows updated.</span></span>

<span data-ttu-id="69e15-152">En **el Explorador de soluciones**, haga clic en el *vistas/cursos* carpeta y, a continuación, haga clic en **Agregar > nuevo elemento**.</span><span class="sxs-lookup"><span data-stu-id="69e15-152">In **Solution Explorer**, right-click the *Views/Courses* folder, and then click **Add > New Item**.</span></span>

<span data-ttu-id="69e15-153">En el **Agregar nuevo elemento** cuadro de diálogo, haga clic en **ASP.NET** en **instalado** en el panel izquierdo, haga clic en **página vista de MVC**y el nombre de la nueva vista  *UpdateCourseCredits.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="69e15-153">In the **Add New Item** dialog, click **ASP.NET** under **Installed** in the left pane, click **MVC View Page**, and name the new view *UpdateCourseCredits.cshtml*.</span></span>

<span data-ttu-id="69e15-154">En *Views/Courses/UpdateCourseCredits.cshtml*, reemplace el código de plantilla con el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="69e15-154">In *Views/Courses/UpdateCourseCredits.cshtml*, replace the template code with the following code:</span></span>

[!code-html[Main](intro/samples/cu/Views/Courses/UpdateCourseCredits.cshtml)]

<span data-ttu-id="69e15-155">Ejecute el `UpdateCourseCredits` método seleccionando la **cursos** ficha, a continuación, agregar "/ UpdateCourseCredits" al final de la dirección URL en la barra de direcciones del explorador (por ejemplo: `http://localhost:5813/Courses/UpdateCourseCredits`).</span><span class="sxs-lookup"><span data-stu-id="69e15-155">Run the `UpdateCourseCredits` method by selecting the **Courses** tab, then adding "/UpdateCourseCredits" to the end of the URL in the browser's address bar (for example: `http://localhost:5813/Courses/UpdateCourseCredits`).</span></span> <span data-ttu-id="69e15-156">Escriba un número en el cuadro de texto:</span><span class="sxs-lookup"><span data-stu-id="69e15-156">Enter a number in the text box:</span></span>

![Página de créditos del curso de actualización](advanced/_static/update-credits.png)

<span data-ttu-id="69e15-158">Haga clic en **Actualizar**.</span><span class="sxs-lookup"><span data-stu-id="69e15-158">Click **Update**.</span></span> <span data-ttu-id="69e15-159">Ver el número de filas afectadas:</span><span class="sxs-lookup"><span data-stu-id="69e15-159">You see the number of rows affected:</span></span>

![Página de actualización curso créditos filas afectadas](advanced/_static/update-credits-rows-affected.png)

<span data-ttu-id="69e15-161">Haga clic en **volver a la lista** para ver la lista de cursos con el número de créditos revisado.</span><span class="sxs-lookup"><span data-stu-id="69e15-161">Click **Back to List** to see the list of courses with the revised number of credits.</span></span>

<span data-ttu-id="69e15-162">Tenga en cuenta que el código de producción garantiza que siempre actualiza el resultado de datos válido.</span><span class="sxs-lookup"><span data-stu-id="69e15-162">Note that production code would ensure that updates always result in valid data.</span></span> <span data-ttu-id="69e15-163">El código simplificado que se muestra a continuación puede multiplicar al número de créditos suficiente para dar lugar a un número superior a 5.</span><span class="sxs-lookup"><span data-stu-id="69e15-163">The simplified code shown here could multiply the number of credits enough to result in numbers greater than 5.</span></span> <span data-ttu-id="69e15-164">(El `Credits` propiedad tiene un `[Range(0, 5)]` atributo.) La consulta update podría funcionar, pero los datos no válidos pudieron producir resultados inesperados en otras partes del sistema que asumen que el número de créditos es 5 o menos.</span><span class="sxs-lookup"><span data-stu-id="69e15-164">(The `Credits` property has a `[Range(0, 5)]` attribute.) The update query would work but the invalid data could cause unexpected results in other parts of the system that assume the number of credits is 5 or less.</span></span>

<span data-ttu-id="69e15-165">Para obtener más información acerca de las consultas SQL sin formato, vea [sin procesar consultas SQL](https://docs.microsoft.com/ef/core/querying/raw-sql).</span><span class="sxs-lookup"><span data-stu-id="69e15-165">For more information about raw SQL queries, see [Raw SQL Queries](https://docs.microsoft.com/ef/core/querying/raw-sql).</span></span>

## <a name="examine-sql-sent-to-the-database"></a><span data-ttu-id="69e15-166">Examinar SQL enviado a la base de datos</span><span class="sxs-lookup"><span data-stu-id="69e15-166">Examine SQL sent to the database</span></span>

<span data-ttu-id="69e15-167">A veces resulta útil poder ver las consultas SQL reales que se envían a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-167">Sometimes it's helpful to be able to see the actual SQL queries that are sent to the database.</span></span> <span data-ttu-id="69e15-168">EF Core usa automáticamente la funcionalidad de registro integrados para ASP.NET Core para escribir los registros que contienen el código SQL para las consultas y actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="69e15-168">Built-in logging functionality for ASP.NET Core is automatically used by EF Core to write logs that contain the SQL for queries and updates.</span></span> <span data-ttu-id="69e15-169">En esta sección podrá ver algunos ejemplos de inicio de sesión SQL.</span><span class="sxs-lookup"><span data-stu-id="69e15-169">In this section you'll see some examples of SQL logging.</span></span>

<span data-ttu-id="69e15-170">Abra *StudentsController.cs* y en el `Details` método establece un punto de interrupción en el `if (student == null)` instrucción.</span><span class="sxs-lookup"><span data-stu-id="69e15-170">Open *StudentsController.cs* and in the `Details` method set a breakpoint on the `if (student == null)` statement.</span></span>

<span data-ttu-id="69e15-171">Ejecutar la aplicación en modo de depuración y vaya a la página de detalles acerca de un estudiante.</span><span class="sxs-lookup"><span data-stu-id="69e15-171">Run the app in debug mode, and go to the Details page for a student.</span></span>

<span data-ttu-id="69e15-172">Vaya a la **salida** de salida de ventana que muestra la depuración, y verá que la consulta:</span><span class="sxs-lookup"><span data-stu-id="69e15-172">Go to the **Output** window showing debug output, and you see the query:</span></span>

```
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (56ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT TOP(2) [s].[ID], [s].[Discriminator], [s].[FirstName], [s].[LastName], [s].[EnrollmentDate]
FROM [Person] AS [s]
WHERE ([s].[Discriminator] = N'Student') AND ([s].[ID] = @__id_0)
ORDER BY [s].[ID]
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (122ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT [s.Enrollments].[EnrollmentID], [s.Enrollments].[CourseID], [s.Enrollments].[Grade], [s.Enrollments].[StudentID], [e.Course].[CourseID], [e.Course].[Credits], [e.Course].[DepartmentID], [e.Course].[Title]
FROM [Enrollment] AS [s.Enrollments]
INNER JOIN [Course] AS [e.Course] ON [s.Enrollments].[CourseID] = [e.Course].[CourseID]
INNER JOIN (
    SELECT TOP(1) [s0].[ID]
    FROM [Person] AS [s0]
    WHERE ([s0].[Discriminator] = N'Student') AND ([s0].[ID] = @__id_0)
    ORDER BY [s0].[ID]
) AS [t] ON [s.Enrollments].[StudentID] = [t].[ID]
ORDER BY [t].[ID]
```

<span data-ttu-id="69e15-173">Verá algo aquí que actuales podrían sorprenderle: la instrucción SQL selecciona filas hasta 2 (`TOP(2)`) de la tabla Person.</span><span class="sxs-lookup"><span data-stu-id="69e15-173">You'll notice something here that might surprise you: the SQL selects up to 2 rows (`TOP(2)`) from the Person table.</span></span> <span data-ttu-id="69e15-174">El `SingleOrDefaultAsync` método no se resuelve en 1 fila en el servidor.</span><span class="sxs-lookup"><span data-stu-id="69e15-174">The `SingleOrDefaultAsync` method doesn't resolve to 1 row on the server.</span></span> <span data-ttu-id="69e15-175">El motivo es el siguiente:</span><span class="sxs-lookup"><span data-stu-id="69e15-175">Here's why:</span></span>

* <span data-ttu-id="69e15-176">Si la consulta devuelve varias filas, el método devuelve null.</span><span class="sxs-lookup"><span data-stu-id="69e15-176">If the query would return multiple rows, the method returns null.</span></span>
* <span data-ttu-id="69e15-177">Para determinar si la consulta devuelve varias filas, EF tiene que comprobar si devuelve al menos 2.</span><span class="sxs-lookup"><span data-stu-id="69e15-177">To determine whether the query would return multiple rows, EF has to check if it returns at least 2.</span></span>

<span data-ttu-id="69e15-178">Tenga en cuenta que no tienes que usar el modo de depuración y dejar a un punto de interrupción para obtener los resultados del registro en el **salida** ventana.</span><span class="sxs-lookup"><span data-stu-id="69e15-178">Note that you don't have to use debug mode and stop at a breakpoint to get logging output in the **Output** window.</span></span> <span data-ttu-id="69e15-179">Es una manera cómoda de detener el registro en el punto que desea buscar en la salida.</span><span class="sxs-lookup"><span data-stu-id="69e15-179">It's just a convenient way to stop the logging at the point you want to look at the output.</span></span> <span data-ttu-id="69e15-180">Si no hacerlo, el registro continúa y tiene que desplazarse hacia atrás para encontrar los elementos que le interesa.</span><span class="sxs-lookup"><span data-stu-id="69e15-180">If you don't do that, logging continues and you have to scroll back to find the parts you're interested in.</span></span>

## <a name="repository-and-unit-of-work-patterns"></a><span data-ttu-id="69e15-181">Repositorio y una unidad de patrones de trabajo</span><span class="sxs-lookup"><span data-stu-id="69e15-181">Repository and unit of work patterns</span></span>

<span data-ttu-id="69e15-182">Muchos desarrolladores escriben código para implementar el repositorio y una unidad de patrones de trabajo como un contenedor alrededor de código que funcione con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="69e15-182">Many developers write code to implement the repository and unit of work patterns as a wrapper around code that works with the Entity Framework.</span></span> <span data-ttu-id="69e15-183">Estos modelos están diseñados para crear una capa de abstracción entre la capa de acceso a datos y la capa de lógica empresarial de una aplicación.</span><span class="sxs-lookup"><span data-stu-id="69e15-183">These patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="69e15-184">Implementación de estos modelos puede ayudar a aislar la aplicación de cambios en el almacén de datos y puede facilitar el desarrollo controlado por pruebas (TDD) o pruebas unitarias automatizadas.</span><span class="sxs-lookup"><span data-stu-id="69e15-184">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span> <span data-ttu-id="69e15-185">Sin embargo, escribir código adicional para implementar estos patrones no siempre es la mejor opción para las aplicaciones que usan EF, por varias razones:</span><span class="sxs-lookup"><span data-stu-id="69e15-185">However, writing additional code to implement these patterns is not always the best choice for applications that use EF, for several reasons:</span></span>

* <span data-ttu-id="69e15-186">La propia clase de contexto EF aísla el código desde el código específico del almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-186">The EF context class itself insulates your code from data-store-specific code.</span></span>

* <span data-ttu-id="69e15-187">La clase de contexto EF puede actuar como una clase de unidad de trabajo para la base de datos de las actualizaciones que se hace con EF.</span><span class="sxs-lookup"><span data-stu-id="69e15-187">The EF context class can act as a unit-of-work class for database updates that you do using EF.</span></span>

* <span data-ttu-id="69e15-188">EF incluye características para implementar TDD sin escribir código de repositorio.</span><span class="sxs-lookup"><span data-stu-id="69e15-188">EF includes features for implementing TDD without writing repository code.</span></span>

<span data-ttu-id="69e15-189">Para obtener información sobre cómo implementar el repositorio y una unidad de patrones de trabajo, consulte [la versión de Entity Framework 5 de esta serie de tutoriales](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application).</span><span class="sxs-lookup"><span data-stu-id="69e15-189">For information about how to implement the repository and unit of work patterns, see [the Entity Framework 5 version of this tutorial series](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application).</span></span>

<span data-ttu-id="69e15-190">Núcleo de Entity Framework implementa un proveedor de base de datos en memoria que puede utilizarse para realizar pruebas.</span><span class="sxs-lookup"><span data-stu-id="69e15-190">Entity Framework Core implements an in-memory database provider that can be used for testing.</span></span> <span data-ttu-id="69e15-191">Para obtener más información, consulte [pruebas con InMemory](https://docs.microsoft.com/ef/core/miscellaneous/testing/in-memory).</span><span class="sxs-lookup"><span data-stu-id="69e15-191">For more information, see [Testing with InMemory](https://docs.microsoft.com/ef/core/miscellaneous/testing/in-memory).</span></span>

## <a name="automatic-change-detection"></a><span data-ttu-id="69e15-192">Detección de cambios automático</span><span class="sxs-lookup"><span data-stu-id="69e15-192">Automatic change detection</span></span>

<span data-ttu-id="69e15-193">Entity Framework determina cómo ha cambiado una entidad (y, por tanto, las actualizaciones que necesitan para enviarse a la base de datos) mediante la comparación de los valores actuales de una entidad con los valores originales.</span><span class="sxs-lookup"><span data-stu-id="69e15-193">The Entity Framework determines how an entity has changed (and therefore which updates need to be sent to the database) by comparing the current values of an entity with the original values.</span></span> <span data-ttu-id="69e15-194">Cuando se consulta o se adjunta la entidad, se almacenan los valores originales.</span><span class="sxs-lookup"><span data-stu-id="69e15-194">The original values are stored when the entity is queried or attached.</span></span> <span data-ttu-id="69e15-195">Algunos de los métodos que provocan la detección de cambios automático son los siguientes:</span><span class="sxs-lookup"><span data-stu-id="69e15-195">Some of the methods that cause automatic change detection are the following:</span></span>

* <span data-ttu-id="69e15-196">DbContext.SaveChanges</span><span class="sxs-lookup"><span data-stu-id="69e15-196">DbContext.SaveChanges</span></span>

* <span data-ttu-id="69e15-197">DbContext.Entry</span><span class="sxs-lookup"><span data-stu-id="69e15-197">DbContext.Entry</span></span>

* <span data-ttu-id="69e15-198">ChangeTracker.Entries</span><span class="sxs-lookup"><span data-stu-id="69e15-198">ChangeTracker.Entries</span></span>

<span data-ttu-id="69e15-199">Si está realizando el seguimiento de un gran número de entidades y se llama a uno de estos métodos muchas veces en un bucle, podría obtener mejoras de rendimiento significativas desactivando temporalmente detección de cambios automático mediante el `ChangeTracker.AutoDetectChangesEnabled` propiedad.</span><span class="sxs-lookup"><span data-stu-id="69e15-199">If you're tracking a large number of entities and you call one of these methods many times in a loop, you might get significant performance improvements by temporarily turning off automatic change detection using the `ChangeTracker.AutoDetectChangesEnabled` property.</span></span> <span data-ttu-id="69e15-200">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="69e15-200">For example:</span></span>

```csharp
_context.ChangeTracker.AutoDetectChangesEnabled = false;
```

## <a name="entity-framework-core-source-code-and-development-plans"></a><span data-ttu-id="69e15-201">Entity Framework Core origen código y planes de desarrollo</span><span class="sxs-lookup"><span data-stu-id="69e15-201">Entity Framework Core source code and development plans</span></span>

<span data-ttu-id="69e15-202">El código fuente de Entity Framework Core está disponible en [https://github.com/aspnet/EntityFrameworkCore](https://github.com/aspnet/EntityFrameworkCore).</span><span class="sxs-lookup"><span data-stu-id="69e15-202">The source code for Entity Framework Core is available at [https://github.com/aspnet/EntityFrameworkCore](https://github.com/aspnet/EntityFrameworkCore).</span></span> <span data-ttu-id="69e15-203">Además de código fuente, puede obtener las compilaciones nocturnas, seguimiento de problemas, las especificaciones de características, diseñar notas de la reunión, [el plan de desarrollo futuro](https://github.com/aspnet/EntityFrameworkCore/wiki/Roadmap)y mucho más.</span><span class="sxs-lookup"><span data-stu-id="69e15-203">Besides source code, you can get nightly builds, issue tracking, feature specs, design meeting notes, [the roadmap for future development](https://github.com/aspnet/EntityFrameworkCore/wiki/Roadmap), and more.</span></span> <span data-ttu-id="69e15-204">Se pueden informar de errores y puede aportar sus propias mejoras en el código fuente EF.</span><span class="sxs-lookup"><span data-stu-id="69e15-204">You can file bugs, and you can contribute your own enhancements to the EF source code.</span></span>

<span data-ttu-id="69e15-205">Aunque el código fuente está abierto, Entity Framework Core es totalmente compatible como un producto de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="69e15-205">Although the source code is open, Entity Framework Core is fully supported as a Microsoft product.</span></span> <span data-ttu-id="69e15-206">El equipo de Microsoft Entity Framework mantiene el control sobre el que se aceptan las contribuciones y comprueba todos los cambios de código para garantizar la calidad de cada versión.</span><span class="sxs-lookup"><span data-stu-id="69e15-206">The Microsoft Entity Framework team keeps control over which contributions are accepted and tests all code changes to ensure the quality of each release.</span></span>

## <a name="reverse-engineer-from-existing-database"></a><span data-ttu-id="69e15-207">Ingeniería inversa de la base de datos existente</span><span class="sxs-lookup"><span data-stu-id="69e15-207">Reverse engineer from existing database</span></span>

<span data-ttu-id="69e15-208">Para aplicar ingeniería inversa a un modelo de datos, incluidas las clases de entidad de una base de datos existente, use la [scaffold dbcontext](https://docs.microsoft.com/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext) comando.</span><span class="sxs-lookup"><span data-stu-id="69e15-208">To reverse engineer a data model including entity classes from an existing database, use the [scaffold-dbcontext](https://docs.microsoft.com/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext) command.</span></span> <span data-ttu-id="69e15-209">Consulte la [tutorial de introducción](https://docs.microsoft.com/ef/core/get-started/aspnetcore/existing-db).</span><span class="sxs-lookup"><span data-stu-id="69e15-209">See the [getting-started tutorial](https://docs.microsoft.com/ef/core/get-started/aspnetcore/existing-db).</span></span>

<a id="dynamic-linq"></a>
## <a name="use-dynamic-linq-to-simplify-sort-selection-code"></a><span data-ttu-id="69e15-210">Utilizar LINQ dinámicos para simplificar código de selección de ordenación</span><span class="sxs-lookup"><span data-stu-id="69e15-210">Use dynamic LINQ to simplify sort selection code</span></span>

<span data-ttu-id="69e15-211">El [tercer tutorial de esta serie](sort-filter-page.md) muestra cómo escribir código LINQ codificar de forma rígida los nombres de columna en un `switch` instrucción.</span><span class="sxs-lookup"><span data-stu-id="69e15-211">The [third tutorial in this series](sort-filter-page.md) shows how to write LINQ code by hard-coding column names in a `switch` statement.</span></span> <span data-ttu-id="69e15-212">Con dos columnas para elegir, esto funciona bien, pero si tiene muchas columnas el código podría considerarse detallado.</span><span class="sxs-lookup"><span data-stu-id="69e15-212">With two columns to choose from, this works fine, but if you have many columns the code could get verbose.</span></span> <span data-ttu-id="69e15-213">Para solucionar este problema, puede usar el `EF.Property` método para especificar el nombre de la propiedad como una cadena.</span><span class="sxs-lookup"><span data-stu-id="69e15-213">To solve that problem, you can use the `EF.Property` method to specify the name of the property as a string.</span></span> <span data-ttu-id="69e15-214">Para probar este enfoque, reemplace la `Index` método en la `StudentsController` con el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="69e15-214">To try out this approach, replace the `Index` method in the `StudentsController` with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DynamicLinq)]

## <a name="next-steps"></a><span data-ttu-id="69e15-215">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="69e15-215">Next steps</span></span>

<span data-ttu-id="69e15-216">Con esto finaliza la siguiente serie de tutoriales sobre cómo utilizar el núcleo de Entity Framework en una aplicación ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="69e15-216">This completes this series of tutorials on using the Entity Framework Core in an ASP.NET MVC application.</span></span>

<span data-ttu-id="69e15-217">Para obtener más información sobre el núcleo de EF, consulte la [documentación de Entity Framework Core](https://docs.microsoft.com/ef/core).</span><span class="sxs-lookup"><span data-stu-id="69e15-217">For more information about EF Core, see the [Entity Framework Core documentation](https://docs.microsoft.com/ef/core).</span></span> <span data-ttu-id="69e15-218">También está disponible un libro: [Entity Framework Core en acción](https://www.manning.com/books/entity-framework-core-in-action).</span><span class="sxs-lookup"><span data-stu-id="69e15-218">A book is also available: [Entity Framework Core in Action](https://www.manning.com/books/entity-framework-core-in-action).</span></span>

<span data-ttu-id="69e15-219">Para obtener información sobre cómo implementar la aplicación web después de que haya creado, vea [publicación e implementación](../../publishing/index.md).</span><span class="sxs-lookup"><span data-stu-id="69e15-219">For information about how to deploy your web application after you've built it, see [Publishing and deployment](../../publishing/index.md).</span></span>

<span data-ttu-id="69e15-220">Para obtener información acerca de otros temas relacionados con ASP.NET MVC de núcleo, como la autenticación y autorización, consulte la [documentación principal de ASP.NET](https://docs.microsoft.com/aspnet/core/).</span><span class="sxs-lookup"><span data-stu-id="69e15-220">For information about other topics related to ASP.NET Core MVC, such as authentication and authorization, see the [ASP.NET Core documentation](https://docs.microsoft.com/aspnet/core/).</span></span>

## <a name="acknowledgments"></a><span data-ttu-id="69e15-221">Confirmaciones</span><span class="sxs-lookup"><span data-stu-id="69e15-221">Acknowledgments</span></span>

<span data-ttu-id="69e15-222">Tom Dykstra y Rick Anderson (twitter @RickAndMSFT) en este tutorial se escribió.</span><span class="sxs-lookup"><span data-stu-id="69e15-222">Tom Dykstra and Rick Anderson (twitter @RickAndMSFT) wrote this tutorial.</span></span> <span data-ttu-id="69e15-223">Rowan Miller, Diego Vega y otros miembros del equipo de Entity Framework había asistida con revisiones de código y ayudó a depurar problemas que se produjeron mientras se estábamos escribiendo código para los tutoriales.</span><span class="sxs-lookup"><span data-stu-id="69e15-223">Rowan Miller, Diego Vega, and other members of the Entity Framework team assisted with code reviews and helped debug issues that arose while we were writing code for the tutorials.</span></span>

## <a name="common-errors"></a><span data-ttu-id="69e15-224">Errores comunes</span><span class="sxs-lookup"><span data-stu-id="69e15-224">Common errors</span></span>  

### <a name="contosouniversitydll-used-by-another-process"></a><span data-ttu-id="69e15-225">ContosoUniversity.dll utilizado por otro proceso</span><span class="sxs-lookup"><span data-stu-id="69e15-225">ContosoUniversity.dll used by another process</span></span>

<span data-ttu-id="69e15-226">Mensaje de error:</span><span class="sxs-lookup"><span data-stu-id="69e15-226">Error message:</span></span>

> <span data-ttu-id="69e15-227">No se puede abrir ' … bin\Debug\netcoreapp1.0\ContosoUniversity.dll' para escritura: ' el proceso no puede tener acceso al archivo '... \bin\Debug\netcoreapp1.0\ContosoUniversity.dll' porque está siendo utilizado por otro proceso.</span><span class="sxs-lookup"><span data-stu-id="69e15-227">Cannot open '...bin\Debug\netcoreapp1.0\ContosoUniversity.dll' for writing -- 'The process cannot access the file '...\bin\Debug\netcoreapp1.0\ContosoUniversity.dll' because it is being used by another process.</span></span>

<span data-ttu-id="69e15-228">Solución:</span><span class="sxs-lookup"><span data-stu-id="69e15-228">Solution:</span></span>

<span data-ttu-id="69e15-229">Detener el sitio en IIS Express.</span><span class="sxs-lookup"><span data-stu-id="69e15-229">Stop the site in IIS Express.</span></span> <span data-ttu-id="69e15-230">Ir a la bandeja del sistema Windows, buscar IIS Express y haga clic en su icono, seleccione el sitio de la Universidad de Contoso y, a continuación, haga clic en **Detener sitio**.</span><span class="sxs-lookup"><span data-stu-id="69e15-230">Go to the Windows System Tray, find IIS Express and right-click its icon, select the Contoso University site, and then click **Stop Site**.</span></span>

### <a name="migration-scaffolded-with-no-code-in-up-and-down-methods"></a><span data-ttu-id="69e15-231">Migración scaffolding sin código en métodos de arriba y abajo</span><span class="sxs-lookup"><span data-stu-id="69e15-231">Migration scaffolded with no code in Up and Down methods</span></span>

<span data-ttu-id="69e15-232">Causa posible:</span><span class="sxs-lookup"><span data-stu-id="69e15-232">Possible cause:</span></span>

<span data-ttu-id="69e15-233">Los comandos de CLI de EF no cerrar automáticamente y guardar archivos de código.</span><span class="sxs-lookup"><span data-stu-id="69e15-233">The EF CLI commands don't automatically close and save code files.</span></span> <span data-ttu-id="69e15-234">Si no ha guardado los cambios cuando se ejecuta el `migrations add` comando EF no encontrará los cambios.</span><span class="sxs-lookup"><span data-stu-id="69e15-234">If you have unsaved changes when you run the `migrations add` command, EF won't find your changes.</span></span>

<span data-ttu-id="69e15-235">Solución:</span><span class="sxs-lookup"><span data-stu-id="69e15-235">Solution:</span></span>

<span data-ttu-id="69e15-236">Ejecute el `migrations remove` de comandos, guardar los cambios de código y vuelva a ejecutar el `migrations add` comando.</span><span class="sxs-lookup"><span data-stu-id="69e15-236">Run the `migrations remove` command, save your code changes and rerun the `migrations add` command.</span></span>

### <a name="errors-while-running-database-update"></a><span data-ttu-id="69e15-237">Errores durante la ejecución de actualización de base de datos</span><span class="sxs-lookup"><span data-stu-id="69e15-237">Errors while running database update</span></span>

<span data-ttu-id="69e15-238">Es posible obtener otros errores al realizar cambios de esquema en una base de datos con los datos existentes.</span><span class="sxs-lookup"><span data-stu-id="69e15-238">It's possible to get other errors when making schema changes in a database that has existing data.</span></span> <span data-ttu-id="69e15-239">Si se producen errores de migración que no se puede resolver, puede cambiar el nombre de la base de datos en la cadena de conexión o eliminar la base de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-239">If you get migration errors you can't resolve, you can either change the database name in the connection string or delete the database.</span></span> <span data-ttu-id="69e15-240">Con una base de datos, no hay ningún dato para migrar y el comando de actualización de base de datos es mucho más probable que se completan sin errores.</span><span class="sxs-lookup"><span data-stu-id="69e15-240">With a new database, there is no data to migrate, and the update-database command is much more likely to complete without errors.</span></span>

<span data-ttu-id="69e15-241">El enfoque más sencillo consiste en cambiar el nombre de la base de datos *appSettings.JSON que se*.</span><span class="sxs-lookup"><span data-stu-id="69e15-241">The simplest approach is to rename the database in *appsettings.json*.</span></span> <span data-ttu-id="69e15-242">La próxima vez que ejecute `database update`, se creará una nueva base de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-242">The next time you run `database update`, a new database will be created.</span></span>

<span data-ttu-id="69e15-243">Para eliminar una base de datos en SSOX, haga clic en la base de datos, haga clic en **eliminar**y, a continuación, en la **Eliminar base de datos** cuadro de diálogo, seleccione **cerrar conexiones existentes** y haga clic en  **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="69e15-243">To delete a database in SSOX, right-click the database, click **Delete**, and then in the **Delete Database** dialog box select **Close existing connections** and click **OK**.</span></span>

<span data-ttu-id="69e15-244">Para eliminar una base de datos mediante el uso de la CLI, ejecute el `database drop` comando de CLI:</span><span class="sxs-lookup"><span data-stu-id="69e15-244">To delete a database by using the CLI, run the `database drop` CLI command:</span></span>

```console
dotnet ef database drop
```

### <a name="error-locating-sql-server-instance"></a><span data-ttu-id="69e15-245">Instancia de SQL Server de localización de error</span><span class="sxs-lookup"><span data-stu-id="69e15-245">Error locating SQL Server instance</span></span>

<span data-ttu-id="69e15-246">Mensaje de error:</span><span class="sxs-lookup"><span data-stu-id="69e15-246">Error Message:</span></span>

> <span data-ttu-id="69e15-247">Se ha producido un error relacionado con la red o específico de la instancia al establecer una conexión a SQL Server.</span><span class="sxs-lookup"><span data-stu-id="69e15-247">A network-related or instance-specific error occurred while establishing a connection to SQL Server.</span></span> <span data-ttu-id="69e15-248">No se encontró el servidor o éste no estaba accesible.</span><span class="sxs-lookup"><span data-stu-id="69e15-248">The server was not found or was not accessible.</span></span> <span data-ttu-id="69e15-249">Compruebe que el nombre de la instancia es correcto y que SQL Server está configurado para admitir conexiones remotas.</span><span class="sxs-lookup"><span data-stu-id="69e15-249">Verify that the instance name is correct and that SQL Server is configured to allow remote connections.</span></span> <span data-ttu-id="69e15-250">(proveedor: Interfaces de red SQL, error: 26 - Error Buscar servidor/instancia especificado)</span><span class="sxs-lookup"><span data-stu-id="69e15-250">(provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance Specified)</span></span>

<span data-ttu-id="69e15-251">Solución:</span><span class="sxs-lookup"><span data-stu-id="69e15-251">Solution:</span></span>

<span data-ttu-id="69e15-252">Compruebe la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="69e15-252">Check the connection string.</span></span> <span data-ttu-id="69e15-253">Si se ha eliminado manualmente el archivo de base de datos, cambiar el nombre de la base de datos en la cadena de construcción para volver a empezar con una base de datos.</span><span class="sxs-lookup"><span data-stu-id="69e15-253">If you have manually deleted the database file, change the name of the database in the construction string to start over with a new database.</span></span>

>[!div class="step-by-step"]
[<span data-ttu-id="69e15-254">Anterior</span><span class="sxs-lookup"><span data-stu-id="69e15-254">Previous</span></span>](inheritance.md)
