---
title: "Proveedor de configuración de almacén de claves de Azure"
author: guardrex
description: "Obtenga información acerca de cómo usar el proveedor de configuración de almacén de claves de Azure para configurar una aplicación con pares de nombre / valor que se carga en tiempo de ejecución."
keywords: "Núcleo de ASP.NET, configuración, el almacén de claves de Azure"
ms.author: riande
manager: wpickett
ms.date: 08/09/2017
ms.topic: article
ms.assetid: 0292bdae-b3ed-4637-bd67-19b9bb8b65cb
ms.prod: asp.net-core
uid: security/key-vault-configuration
ms.openlocfilehash: 2c94daafec8d3b4051bd3091478521ab12a434bd
ms.sourcegitcommit: 78d28178345a0eea91556e4cd1adad98b1446db8
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/22/2017
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="6332e-104">Proveedor de configuración de almacén de claves de Azure</span><span class="sxs-lookup"><span data-stu-id="6332e-104">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="6332e-105">Por [Luke Latham](https://github.com/GuardRex) y [Andrew Stanton-enfermera](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="6332e-105">By [Luke Latham](https://github.com/GuardRex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="6332e-106">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="6332e-106">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="6332e-107">Ver o descargar el código de ejemplo para 2.x:</span><span class="sxs-lookup"><span data-stu-id="6332e-107">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="6332e-108">[Ejemplo básico](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) -lee los valores de secreto en una aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-108">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) - Reads secret values into an app.</span></span>
* <span data-ttu-id="6332e-109">[Ejemplo de prefijo de nombre de clave](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) : lecturas valores secretos utilizando un prefijo de nombre de la clave que representa la versión de una aplicación, lo que permite cargar un conjunto diferente de valores secretos para cada versión de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-109">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="6332e-110">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="6332e-110">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="6332e-111">Ver o descargar el código de ejemplo para 1.x:</span><span class="sxs-lookup"><span data-stu-id="6332e-111">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="6332e-112">[Ejemplo básico](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) -lee los valores de secreto en una aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-112">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) - Reads secret values into an app.</span></span>
* <span data-ttu-id="6332e-113">[Ejemplo de prefijo de nombre de clave](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) : lecturas valores secretos utilizando un prefijo de nombre de la clave que representa la versión de una aplicación, lo que permite cargar un conjunto diferente de valores secretos para cada versión de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-113">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="6332e-114">Este documento explica cómo utilizar el [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) proveedor de configuración para cargar valores de configuración de aplicación de secretos del almacén de claves de Azure.</span><span class="sxs-lookup"><span data-stu-id="6332e-114">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="6332e-115">Almacén de claves de Azure es un servicio basado en la nube que le ayuda a proteger las claves criptográficas y secretos usados por aplicaciones y servicios.</span><span class="sxs-lookup"><span data-stu-id="6332e-115">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="6332e-116">Escenarios comunes incluyen controlar el acceso a datos confidenciales de la configuración y satisfacer el requisito para FIPS 140-2 nivel 2 validar módulos de seguridad de Hardware (HSM) al almacenar los datos de configuración.</span><span class="sxs-lookup"><span data-stu-id="6332e-116">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="6332e-117">Esta característica está disponible para las aplicaciones que tienen como destino ASP.NET Core 1.1 o posterior.</span><span class="sxs-lookup"><span data-stu-id="6332e-117">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="6332e-118">Package</span><span class="sxs-lookup"><span data-stu-id="6332e-118">Package</span></span>
<span data-ttu-id="6332e-119">Para usar el proveedor, agregue una referencia a la [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) paquete.</span><span class="sxs-lookup"><span data-stu-id="6332e-119">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="6332e-120">Configuración de aplicación</span><span class="sxs-lookup"><span data-stu-id="6332e-120">Application configuration</span></span>
<span data-ttu-id="6332e-121">Puede explorar el proveedor con el [aplicaciones de ejemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="6332e-121">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="6332e-122">Una vez que establezca un almacén de claves y crear secretos en el almacén, las aplicaciones de ejemplo segura cargar los valores de secreto en sus configuraciones y mostrarlos en las páginas Web.</span><span class="sxs-lookup"><span data-stu-id="6332e-122">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="6332e-123">El proveedor se agrega a la `ConfigurationBuilder` con el `AddAzureKeyVault` extensión.</span><span class="sxs-lookup"><span data-stu-id="6332e-123">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="6332e-124">En las aplicaciones de ejemplo, la extensión utiliza tres valores de configuración cargados desde el *appSettings.JSON que se* archivo.</span><span class="sxs-lookup"><span data-stu-id="6332e-124">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="6332e-125">Configuración de la aplicación</span><span class="sxs-lookup"><span data-stu-id="6332e-125">App Setting</span></span>    | <span data-ttu-id="6332e-126">Descripción</span><span class="sxs-lookup"><span data-stu-id="6332e-126">Description</span></span>                    | <span data-ttu-id="6332e-127">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="6332e-127">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="6332e-128">Nombre del almacén de claves de Azure</span><span class="sxs-lookup"><span data-stu-id="6332e-128">Azure Key Vault name</span></span>           | <span data-ttu-id="6332e-129">contosovault</span><span class="sxs-lookup"><span data-stu-id="6332e-129">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="6332e-130">Id. de aplicación de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="6332e-130">Azure Active Directory App Id</span></span>  | <span data-ttu-id="6332e-131">627e911e-43CC-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="6332e-131">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="6332e-132">Clave de aplicación de Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="6332e-132">Azure Active Directory App Key</span></span> | <span data-ttu-id="6332e-133">g58K3dtg59o1Pa + e59v2Tx829w6VxTB2yv9sv/101di =</span><span class="sxs-lookup"><span data-stu-id="6332e-133">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="6332e-134">Creación de secretos del almacén de claves y cargar los valores de configuración (ejemplo de basic)</span><span class="sxs-lookup"><span data-stu-id="6332e-134">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="6332e-135">Crear un almacén de claves y configurar Azure Active Directory (Azure AD) para la aplicación siguiendo las instrucciones de [empezar a trabajar con el almacén de claves de Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="6332e-135">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="6332e-136">Agregar secretos en el almacén de claves mediante el [módulo de PowerShell de almacén de claves AzureRM](/powershell/module/azurerm.keyvault) disponibles desde el [Galería de PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), el [API de REST del almacén de claves de Azure](/rest/api/keyvault/), o la [Portal de azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="6332e-136">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="6332e-137">Los secretos se crean como *Manual* o *certificado* secretos.</span><span class="sxs-lookup"><span data-stu-id="6332e-137">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="6332e-138">*Certificado* secretos están certificados para su uso por aplicaciones y servicios, pero no son compatibles con el proveedor de configuración.</span><span class="sxs-lookup"><span data-stu-id="6332e-138">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="6332e-139">Debe utilizar el *Manual* opción para crear los secretos de par nombre / valor para su uso con el proveedor de configuración.</span><span class="sxs-lookup"><span data-stu-id="6332e-139">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="6332e-140">Secretos simples se crean como pares nombre / valor.</span><span class="sxs-lookup"><span data-stu-id="6332e-140">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="6332e-141">Nombres de secreto de almacén de claves Azure están limitados a caracteres alfanuméricos y guiones.</span><span class="sxs-lookup"><span data-stu-id="6332e-141">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="6332e-142">Usan valores jerárquicos (secciones de configuración) `--` (dos guiones) como separador en el ejemplo.</span><span class="sxs-lookup"><span data-stu-id="6332e-142">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="6332e-143">Caracteres de dos puntos, que normalmente se utilizan para delimitar una sección de una subclave en [configuración de ASP.NET Core](xref:fundamentals/configuration), no están permitidos en los nombres de secreto.</span><span class="sxs-lookup"><span data-stu-id="6332e-143">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration), aren't allowed in secret names.</span></span> <span data-ttu-id="6332e-144">Por lo tanto, se usa dos guiones y se intercambian en dos puntos cuando se cargan los secretos en la configuración de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-144">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="6332e-145">Cree dos *Manual* secretos con los siguientes pares de nombre-valor.</span><span class="sxs-lookup"><span data-stu-id="6332e-145">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="6332e-146">El secreto del primer es un nombre simple y el valor y el secreto del segundo crea un valor secreto con una sección y la subclave en el nombre de secreto:</span><span class="sxs-lookup"><span data-stu-id="6332e-146">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="6332e-147">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="6332e-147">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="6332e-148">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="6332e-148">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="6332e-149">Registrar la aplicación de ejemplo con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6332e-149">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="6332e-150">Autorizar la aplicación para tener acceso al almacén de claves.</span><span class="sxs-lookup"><span data-stu-id="6332e-150">Authorize the app to access the key vault.</span></span> <span data-ttu-id="6332e-151">Cuando se usa el `Set-AzureRmKeyVaultAccessPolicy` cmdlet de PowerShell para autorizar la aplicación para tener acceso al almacén de claves, proporcionar `List` y `Get` acceso a los secretos con `-PermissionsToKeys list,get`.</span><span class="sxs-lookup"><span data-stu-id="6332e-151">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="6332e-152">Actualización de la aplicación *appSettings.JSON que se* archivo con los valores de `Vault`, `ClientId`, y `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="6332e-152">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="6332e-153">Ejecute la aplicación de ejemplo, que obtiene sus valores de configuración de `IConfigurationRoot` con el mismo nombre que el nombre de secreto.</span><span class="sxs-lookup"><span data-stu-id="6332e-153">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="6332e-154">Valores no son jerárquicos: el valor de `SecretName` se obtiene con `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="6332e-154">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="6332e-155">Valores jerárquicos (secciones): Use `:` notación (coma) o el `GetSection` método de extensión.</span><span class="sxs-lookup"><span data-stu-id="6332e-155">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="6332e-156">Use cualquiera de estos métodos para obtener el valor de configuración:</span><span class="sxs-lookup"><span data-stu-id="6332e-156">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="6332e-157">Cuando se ejecuta la aplicación, una página Web muestra los valores cargados secretos:</span><span class="sxs-lookup"><span data-stu-id="6332e-157">When you run the app, a webpage shows the loaded secret values:</span></span>

![Ventana del explorador que muestra valores secretos carga mediante el proveedor de configuración de almacén de claves de Azure](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="6332e-159">Crear el almacén de claves con prefijo secretos y cargar los valores de configuración (clave-nombre-ejemplo de prefijo)</span><span class="sxs-lookup"><span data-stu-id="6332e-159">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="6332e-160">`AddAzureKeyVault`También proporciona una sobrecarga que acepta una implementación de `IKeyVaultSecretManager`, que le permite controlar cómo clave secretos del almacén se convierten en las claves de configuración.</span><span class="sxs-lookup"><span data-stu-id="6332e-160">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="6332e-161">Por ejemplo, puede implementar la interfaz para cargar valores secretos basándose en un valor de prefijo que proporcione al iniciar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-161">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="6332e-162">Esto le permite, por ejemplo, para cargar los secretos en función de la versión de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-162">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="6332e-163">No utilizar prefijos en secretos del almacén de claves colocar secretos para varias aplicaciones en el mismo almacén de claves o colocar secretos entorno (por ejemplo, *desarrollo* verus *producción* secretos) en el mismo almacén.</span><span class="sxs-lookup"><span data-stu-id="6332e-163">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* verus *production* secrets) into the same vault.</span></span> <span data-ttu-id="6332e-164">Se recomienda que diferentes aplicaciones y entornos de desarrollo o de producción usan almacenes claves independientes para aislar los entornos de aplicación para el nivel más alto de seguridad.</span><span class="sxs-lookup"><span data-stu-id="6332e-164">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="6332e-165">Con la segunda aplicación de ejemplo, crear un secreto en el almacén de claves para `5000-AppSecret` (períodos no están permitidos en los nombres de secreto de almacén de claves) que representa un secreto de la aplicación para la versión 5.0.0.0 de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-165">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="6332e-166">Para obtener otra versión, 5.1.0.0, crear un secreto para `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="6332e-166">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="6332e-167">Cada versión de la aplicación carga su propio valor secreto en su configuración como `AppSecret`, extracción desactivar la versión cuando se cargue el secreto.</span><span class="sxs-lookup"><span data-stu-id="6332e-167">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="6332e-168">Implementación del ejemplo se muestra a continuación:</span><span class="sxs-lookup"><span data-stu-id="6332e-168">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="6332e-169">El `Load` método se llama mediante un algoritmo de proveedor que recorre en iteración los secretos del almacén para buscar los que tienen el prefijo de la versión.</span><span class="sxs-lookup"><span data-stu-id="6332e-169">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="6332e-170">Cuando se encuentra un prefijo de versión con `Load`, el algoritmo utiliza el `GetKey` método para devolver el nombre de configuración del nombre del secreto.</span><span class="sxs-lookup"><span data-stu-id="6332e-170">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="6332e-171">Quita el prefijo de la versión del nombre del secreto y devuelve el resto del nombre del secreto para cargar en la configuración de la aplicación de pares nombre / valor.</span><span class="sxs-lookup"><span data-stu-id="6332e-171">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="6332e-172">Al implementar este enfoque:</span><span class="sxs-lookup"><span data-stu-id="6332e-172">When you implement this approach:</span></span>

1. <span data-ttu-id="6332e-173">Se cargan los secretos del almacén de claves.</span><span class="sxs-lookup"><span data-stu-id="6332e-173">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="6332e-174">El secreto de cadena para `5000-AppSecret` se encuentran coincidencias.</span><span class="sxs-lookup"><span data-stu-id="6332e-174">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="6332e-175">La versión `5000` (con el guión), se quitan el nombre de clave dejando `AppSecret` para cargar con el valor de secreto en configuración de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-175">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="6332e-176">También puede proporcionar sus propios `KeyVaultClient` implementación `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="6332e-176">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="6332e-177">Proporciona a un cliente personalizado le permite compartir una única instancia del cliente entre el proveedor de configuración y otras partes de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-177">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="6332e-178">Crear un almacén de claves y configurar Azure Active Directory (Azure AD) para la aplicación siguiendo las instrucciones de [empezar a trabajar con el almacén de claves de Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="6332e-178">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="6332e-179">Agregar secretos en el almacén de claves mediante el [módulo de PowerShell de almacén de claves AzureRM](/powershell/module/azurerm.keyvault) disponibles desde el [Galería de PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), el [API de REST del almacén de claves de Azure](/rest/api/keyvault/), o la [Portal de azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="6332e-179">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="6332e-180">Los secretos se crean como *Manual* o *certificado* secretos.</span><span class="sxs-lookup"><span data-stu-id="6332e-180">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="6332e-181">*Certificado* secretos están certificados para su uso por aplicaciones y servicios, pero no son compatibles con el proveedor de configuración.</span><span class="sxs-lookup"><span data-stu-id="6332e-181">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="6332e-182">Debe utilizar el *Manual* opción para crear los secretos de par nombre / valor para su uso con el proveedor de configuración.</span><span class="sxs-lookup"><span data-stu-id="6332e-182">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="6332e-183">Usan valores jerárquicos (secciones de configuración) `--` (dos guiones) como separador.</span><span class="sxs-lookup"><span data-stu-id="6332e-183">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="6332e-184">Cree dos *Manual* secretos con los siguientes pares de nombre y valor:</span><span class="sxs-lookup"><span data-stu-id="6332e-184">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="6332e-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="6332e-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="6332e-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="6332e-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="6332e-187">Registrar la aplicación de ejemplo con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6332e-187">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="6332e-188">Autorizar la aplicación para tener acceso al almacén de claves.</span><span class="sxs-lookup"><span data-stu-id="6332e-188">Authorize the app to access the key vault.</span></span> <span data-ttu-id="6332e-189">Cuando se usa el `Set-AzureRmKeyVaultAccessPolicy` cmdlet de PowerShell para autorizar la aplicación para tener acceso al almacén de claves, proporcionar `List` y `Get` acceso a los secretos con `-PermissionsToKeys list,get`.</span><span class="sxs-lookup"><span data-stu-id="6332e-189">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="6332e-190">Actualización de la aplicación *appSettings.JSON que se* archivo con los valores de `Vault`, `ClientId`, y `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="6332e-190">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="6332e-191">Ejecute la aplicación de ejemplo, que obtiene sus valores de configuración de `IConfigurationRoot` con el mismo nombre que el nombre de secreto con prefijo.</span><span class="sxs-lookup"><span data-stu-id="6332e-191">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="6332e-192">En este ejemplo, el prefijo es la versión de la aplicación, que proporciona a los `PrefixKeyVaultSecretManager` cuando agrega el proveedor de configuración de almacén de claves de Azure.</span><span class="sxs-lookup"><span data-stu-id="6332e-192">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="6332e-193">El valor de `AppSecret` se obtiene con `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="6332e-193">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="6332e-194">La página Web generada por la aplicación muestra el valor cargado:</span><span class="sxs-lookup"><span data-stu-id="6332e-194">The webpage generated by the app shows the loaded value:</span></span>

   ![Ventana del explorador que muestra un valor secreto que se carga mediante el proveedor de configuración de almacén de claves de Azure versión de la aplicación una vez 5.0.0.0](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="6332e-196">Cambiar la versión del ensamblado en el archivo de proyecto de aplicación `5.0.0.0` a `5.1.0.0` y vuelva a ejecutar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="6332e-196">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="6332e-197">En esta ocasión, el valor de secreto devuelto es `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="6332e-197">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="6332e-198">La página Web generada por la aplicación muestra el valor cargado:</span><span class="sxs-lookup"><span data-stu-id="6332e-198">The webpage generated by the app shows the loaded value:</span></span>

   ![Ventana del explorador que muestra un valor secreto que se carga mediante el proveedor de configuración de almacén de claves de Azure versión de la aplicación una vez 5.1.0.0](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="6332e-200">Controlar el acceso a la ClientSecret</span><span class="sxs-lookup"><span data-stu-id="6332e-200">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="6332e-201">Use la [herramienta Administrador de secreto](xref:security/app-secrets) para mantener la `ClientSecret` fuera de su árbol de código fuente del proyecto.</span><span class="sxs-lookup"><span data-stu-id="6332e-201">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="6332e-202">Con el Administrador de secreto, para asocia los secretos de aplicación a un proyecto específico y compartirlos en varios proyectos.</span><span class="sxs-lookup"><span data-stu-id="6332e-202">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="6332e-203">Al desarrollar una aplicación de .NET Framework en un entorno que admite certificados, puede autenticarse en el almacén de claves de Azure con un certificado X.509.</span><span class="sxs-lookup"><span data-stu-id="6332e-203">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="6332e-204">Clave privada del certificado X.509 es administrada por el sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="6332e-204">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="6332e-205">Para obtener más información, consulte [autenticar con un certificado en lugar de un secreto de cliente](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="6332e-205">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="6332e-206">Use la `AddAzureKeyVault` sobrecarga que acepta un `X509Certificate2`.</span><span class="sxs-lookup"><span data-stu-id="6332e-206">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="6332e-207">Volver a cargar secretos</span><span class="sxs-lookup"><span data-stu-id="6332e-207">Reloading secrets</span></span>
<span data-ttu-id="6332e-208">Los secretos se almacenan en caché hasta que `IConfigurationRoot.Reload()` se llama.</span><span class="sxs-lookup"><span data-stu-id="6332e-208">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="6332e-209">Caducado, deshabilitado, y por la aplicación hasta que no se respeten la secretos actualizados en el almacén de claves `Reload` se ejecuta.</span><span class="sxs-lookup"><span data-stu-id="6332e-209">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="6332e-210">Secretos deshabilitados y expirados</span><span class="sxs-lookup"><span data-stu-id="6332e-210">Disabled and expired secrets</span></span>
<span data-ttu-id="6332e-211">Secretos deshabilitados y expirados producen un `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="6332e-211">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="6332e-212">Para evitar que la aplicación genere, reemplace la aplicación o actualizar el secreto deshabilitado o expirado.</span><span class="sxs-lookup"><span data-stu-id="6332e-212">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="6332e-213">Solución de problemas</span><span class="sxs-lookup"><span data-stu-id="6332e-213">Troubleshooting</span></span>
<span data-ttu-id="6332e-214">Cuando no se puede cargar la configuración mediante el proveedor de la aplicación, se escribe un mensaje de error en la [infraestructura del registro de ASP.NET](xref:fundamentals/logging).</span><span class="sxs-lookup"><span data-stu-id="6332e-214">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging).</span></span> <span data-ttu-id="6332e-215">Las siguientes condiciones se evita que la configuración de carga:</span><span class="sxs-lookup"><span data-stu-id="6332e-215">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="6332e-216">La aplicación no está configurada correctamente en Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6332e-216">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="6332e-217">El almacén de claves no existe en el almacén de claves de Azure.</span><span class="sxs-lookup"><span data-stu-id="6332e-217">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="6332e-218">La aplicación no está autorizada para tener acceso al almacén de claves.</span><span class="sxs-lookup"><span data-stu-id="6332e-218">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="6332e-219">No incluye la directiva de acceso `Get` y `List` permisos.</span><span class="sxs-lookup"><span data-stu-id="6332e-219">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="6332e-220">En el almacén de claves, los datos de configuración (par nombre / valor) se denominó incorrectamente, falta, deshabilitado o expirado.</span><span class="sxs-lookup"><span data-stu-id="6332e-220">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="6332e-221">La aplicación tiene el nombre de almacén de claves incorrecto (`Vault`), Id. de aplicación de Azure AD (`ClientId`), o la clave de AD de Azure (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="6332e-221">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="6332e-222">La clave de AD de Azure (`ClientSecret`) ha expirado.</span><span class="sxs-lookup"><span data-stu-id="6332e-222">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="6332e-223">La clave de configuración (nombre) es incorrecta en la aplicación para el valor que está intentando cargar.</span><span class="sxs-lookup"><span data-stu-id="6332e-223">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="6332e-224">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="6332e-224">Additional resources</span></span>
* <xref:fundamentals/configuration>
* [<span data-ttu-id="6332e-225">Microsoft Azure: Almacén de claves</span><span class="sxs-lookup"><span data-stu-id="6332e-225">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="6332e-226">Microsoft Azure: Documentación de almacén de claves</span><span class="sxs-lookup"><span data-stu-id="6332e-226">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="6332e-227">Cómo generar y transferir protegidas con HSM de claves para el almacén de claves de Azure</span><span class="sxs-lookup"><span data-stu-id="6332e-227">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="6332e-228">Clase KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="6332e-228">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
