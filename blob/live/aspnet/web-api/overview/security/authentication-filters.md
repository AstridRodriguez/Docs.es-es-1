---
uid: web-api/overview/security/authentication-filters
title: "Filtros de autenticación en ASP.NET Web API 2 | Documentos de Microsoft"
author: MikeWasson
description: "Un filtro de autenticación es un componente que autentica una solicitud HTTP. API Web 2 y MVC 5 admiten filtros de autenticación, pero se diferencian ligeramente..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/25/2014
ms.topic: article
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: eee4e7accd338262698d127ed08d4182608839ab
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/10/2017
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="4f07b-104">Filtros de autenticación en ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="4f07b-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="4f07b-105">por [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="4f07b-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="4f07b-106">Un filtro de autenticación es un componente que autentica una solicitud HTTP.</span><span class="sxs-lookup"><span data-stu-id="4f07b-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="4f07b-107">API Web 2 y MVC 5 admiten filtros de autenticación, pero se diferencian ligeramente, principalmente en las convenciones de nomenclatura para la interfaz de filtro.</span><span class="sxs-lookup"><span data-stu-id="4f07b-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="4f07b-108">Este tema describen los filtros de autenticación Web API.</span><span class="sxs-lookup"><span data-stu-id="4f07b-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="4f07b-109">Filtros de autenticación le permiten establecer un esquema de autenticación de controladores individuales o acciones.</span><span class="sxs-lookup"><span data-stu-id="4f07b-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="4f07b-110">De este modo, la aplicación puede admitir mecanismos de autenticación diferentes para los distintos recursos HTTP.</span><span class="sxs-lookup"><span data-stu-id="4f07b-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="4f07b-111">En este artículo, voy a explicar el código de la [la autenticación básica](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) ejemplo en [http://aspnet.codeplex.com](http://aspnet.codeplex.com). El ejemplo muestra un filtro de autenticación que implementa el esquema de autenticación de acceso básica de HTTP (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="4f07b-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com). The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="4f07b-112">El filtro se implementa en una clase denominada `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="4f07b-112">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="4f07b-113">No todo el código del ejemplo, mostrar sólo las partes que muestran cómo crear un filtro de autenticación.</span><span class="sxs-lookup"><span data-stu-id="4f07b-113">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="4f07b-114">Establecer un filtro de autenticación</span><span class="sxs-lookup"><span data-stu-id="4f07b-114">Setting an Authentication Filter</span></span>

<span data-ttu-id="4f07b-115">Al igual que otros filtros, filtros de autenticación pueden ser aplicada por controlador, por cada acción o globalmente a todos los controladores de API Web.</span><span class="sxs-lookup"><span data-stu-id="4f07b-115">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="4f07b-116">Para aplicar un filtro de autenticación a un controlador, decore la clase de controlador con el atributo de filtro.</span><span class="sxs-lookup"><span data-stu-id="4f07b-116">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="4f07b-117">El código siguiente establece el `[IdentityBasicAuthentication]` filtro en una clase de controlador, lo que permite la autenticación básica para todas las acciones del controlador.</span><span class="sxs-lookup"><span data-stu-id="4f07b-117">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="4f07b-118">Para aplicar el filtro a una acción, decorar la acción con el filtro.</span><span class="sxs-lookup"><span data-stu-id="4f07b-118">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="4f07b-119">El código siguiente establece el `[IdentityBasicAuthentication]` filtro en el controlador `Post` método.</span><span class="sxs-lookup"><span data-stu-id="4f07b-119">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="4f07b-120">Para aplicar el filtro a todos los controladores de API Web, agréguelo a **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="4f07b-120">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="4f07b-121">Implementar un filtro de autenticación de Web API</span><span class="sxs-lookup"><span data-stu-id="4f07b-121">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="4f07b-122">En la API de Web, los filtros de autenticación implementan la [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/en-us/library/system.web.http.filters.iauthenticationfilter.aspx) interfaz.</span><span class="sxs-lookup"><span data-stu-id="4f07b-122">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/en-us/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="4f07b-123">También debe heredar de **System.Attribute**, para que se apliquen como atributos.</span><span class="sxs-lookup"><span data-stu-id="4f07b-123">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="4f07b-124">El **IAuthenticationFilter** interfaz tiene dos métodos:</span><span class="sxs-lookup"><span data-stu-id="4f07b-124">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="4f07b-125">**AuthenticateAsync** autentica la solicitud mediante la validación de credenciales en la solicitud, si está presente.</span><span class="sxs-lookup"><span data-stu-id="4f07b-125">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="4f07b-126">**ChallengeAsync** agrega un desafío de autenticación a la respuesta HTTP, si es necesario.</span><span class="sxs-lookup"><span data-stu-id="4f07b-126">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="4f07b-127">Estos métodos se corresponden con el flujo de autenticación definido en [RFC 2612](http://tools.ietf.org/html/rfc2616) y [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="4f07b-127">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="4f07b-128">El cliente envía las credenciales en el encabezado de autorización.</span><span class="sxs-lookup"><span data-stu-id="4f07b-128">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="4f07b-129">Esto suele suceder después de que el cliente recibe una respuesta 401 (no autorizado) desde el servidor.</span><span class="sxs-lookup"><span data-stu-id="4f07b-129">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="4f07b-130">Sin embargo, un cliente puede enviar credenciales con cualquier solicitud, no solo después de obtener 401.</span><span class="sxs-lookup"><span data-stu-id="4f07b-130">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="4f07b-131">Si el servidor no aceptó las credenciales, devuelve una respuesta 401 (no autorizado).</span><span class="sxs-lookup"><span data-stu-id="4f07b-131">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="4f07b-132">La respuesta incluye un encabezado Www-Authenticate que contiene uno o varios desafíos.</span><span class="sxs-lookup"><span data-stu-id="4f07b-132">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="4f07b-133">Cada desafío especifica un esquema de autenticación reconocido por el servidor.</span><span class="sxs-lookup"><span data-stu-id="4f07b-133">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="4f07b-134">El servidor puede devolver 401 de una solicitud anónima.</span><span class="sxs-lookup"><span data-stu-id="4f07b-134">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="4f07b-135">De hecho, es normalmente cómo se inicia el proceso de autenticación:</span><span class="sxs-lookup"><span data-stu-id="4f07b-135">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="4f07b-136">El cliente envía una solicitud anónima.</span><span class="sxs-lookup"><span data-stu-id="4f07b-136">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="4f07b-137">El servidor devuelve 401.</span><span class="sxs-lookup"><span data-stu-id="4f07b-137">The server returns 401.</span></span>
3. <span data-ttu-id="4f07b-138">Los clientes vuelve a enviar la solicitud con credenciales.</span><span class="sxs-lookup"><span data-stu-id="4f07b-138">The clients resends the request with credentials.</span></span>

<span data-ttu-id="4f07b-139">Este flujo incluye ambos *autenticación* y *autorización* pasos.</span><span class="sxs-lookup"><span data-stu-id="4f07b-139">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="4f07b-140">Autenticación demuestra la identidad del cliente.</span><span class="sxs-lookup"><span data-stu-id="4f07b-140">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="4f07b-141">La autorización determina si el cliente puede tener acceso a un recurso determinado.</span><span class="sxs-lookup"><span data-stu-id="4f07b-141">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="4f07b-142">En la API de Web, filtros de autenticación controlan la autenticación, pero no la autorización.</span><span class="sxs-lookup"><span data-stu-id="4f07b-142">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="4f07b-143">Autorización debe realizarse mediante un filtro de autorización o dentro de la acción del controlador.</span><span class="sxs-lookup"><span data-stu-id="4f07b-143">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="4f07b-144">Este es el flujo de la canalización de Web API 2:</span><span class="sxs-lookup"><span data-stu-id="4f07b-144">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="4f07b-145">Antes de invocar una acción, API Web crea una lista de los filtros de autenticación para esa acción.</span><span class="sxs-lookup"><span data-stu-id="4f07b-145">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="4f07b-146">Esto incluye filtros con ámbito de acción, el ámbito de controlador y el ámbito global.</span><span class="sxs-lookup"><span data-stu-id="4f07b-146">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="4f07b-147">Llamadas a la API de Web **AuthenticateAsync** en todos los filtros de la lista.</span><span class="sxs-lookup"><span data-stu-id="4f07b-147">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="4f07b-148">Cada filtro puede validar las credenciales en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-148">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="4f07b-149">Si cualquier filtro que valida correctamente las credenciales, el filtro se crea un **IPrincipal** y lo adjunta a la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-149">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="4f07b-150">Un filtro también puede desencadenar un error en este momento.</span><span class="sxs-lookup"><span data-stu-id="4f07b-150">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="4f07b-151">Si es así, el resto de la canalización no se ejecuta.</span><span class="sxs-lookup"><span data-stu-id="4f07b-151">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="4f07b-152">Suponiendo que no hay ningún error, la solicitud fluye a través del resto de la canalización.</span><span class="sxs-lookup"><span data-stu-id="4f07b-152">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="4f07b-153">Por último, llama a cada filtro de autenticación Web API **ChallengeAsync** método.</span><span class="sxs-lookup"><span data-stu-id="4f07b-153">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="4f07b-154">Filtros de utilizar este método para agregar un desafío a la respuesta, si es necesario.</span><span class="sxs-lookup"><span data-stu-id="4f07b-154">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="4f07b-155">Normalmente (aunque no siempre) que se podría producir en respuesta a un error 401.</span><span class="sxs-lookup"><span data-stu-id="4f07b-155">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="4f07b-156">Los siguientes diagramas muestran dos casos posibles.</span><span class="sxs-lookup"><span data-stu-id="4f07b-156">The following diagrams show two possible cases.</span></span> <span data-ttu-id="4f07b-157">En la primera, el filtro de autenticación autentica correctamente la solicitud, un filtro de autorización que autoriza la solicitud y la acción del controlador devuelve 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="4f07b-157">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="4f07b-158">En el segundo ejemplo, el filtro de autenticación autentica la solicitud, pero el filtro de autorización devuelve 401 (no autorizado).</span><span class="sxs-lookup"><span data-stu-id="4f07b-158">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="4f07b-159">En este caso, no se invoca la acción del controlador.</span><span class="sxs-lookup"><span data-stu-id="4f07b-159">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="4f07b-160">El filtro de autenticación agrega un encabezado Www-Authenticate para la respuesta.</span><span class="sxs-lookup"><span data-stu-id="4f07b-160">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="4f07b-161">Son posibles otras combinaciones&mdash;por ejemplo, si la acción del controlador permite las solicitudes anónimas, podría tener un filtro de autenticación, pero no tiene autorización.</span><span class="sxs-lookup"><span data-stu-id="4f07b-161">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="4f07b-162">Implementar el método AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="4f07b-162">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="4f07b-163">El **AuthenticateAsync** método intenta autenticar la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-163">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="4f07b-164">Aquí se muestra la signatura de método:</span><span class="sxs-lookup"><span data-stu-id="4f07b-164">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="4f07b-165">El **AuthenticateAsync** método debe realizar una de las siguientes acciones:</span><span class="sxs-lookup"><span data-stu-id="4f07b-165">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="4f07b-166">No hay nada (no-op).</span><span class="sxs-lookup"><span data-stu-id="4f07b-166">Nothing (no-op).</span></span>
2. <span data-ttu-id="4f07b-167">Crear un **IPrincipal** y establézcalo en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-167">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="4f07b-168">Establezca un resultado de error.</span><span class="sxs-lookup"><span data-stu-id="4f07b-168">Set an error result.</span></span>

<span data-ttu-id="4f07b-169">Opción (1) significa que la solicitud no tenía las credenciales que entienda el filtro.</span><span class="sxs-lookup"><span data-stu-id="4f07b-169">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="4f07b-170">Significa que la opción (2) el filtro autentica correctamente la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-170">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="4f07b-171">Opción (3) significa la solicitud tenía las credenciales no válidas (por ejemplo, una contraseña incorrecta), lo que desencadena una respuesta de error.</span><span class="sxs-lookup"><span data-stu-id="4f07b-171">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="4f07b-172">Este es un esquema general para implementar **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="4f07b-172">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="4f07b-173">Busque las credenciales en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-173">Look for credentials in the request.</span></span>
2. <span data-ttu-id="4f07b-174">Si no hay ninguna credencial, no haga nada y devolver (no-op).</span><span class="sxs-lookup"><span data-stu-id="4f07b-174">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="4f07b-175">Si hay credenciales, pero el filtro no reconoce el esquema de autenticación, no haga nada y devolver (no-op).</span><span class="sxs-lookup"><span data-stu-id="4f07b-175">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="4f07b-176">Otro filtro en la canalización podría entender que el esquema.</span><span class="sxs-lookup"><span data-stu-id="4f07b-176">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="4f07b-177">Si no hay credenciales que entienda el filtro, intente realizar la autenticación de ellos.</span><span class="sxs-lookup"><span data-stu-id="4f07b-177">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="4f07b-178">Si las credenciales son incorrectas, se devuelve 401 estableciendo `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="4f07b-178">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="4f07b-179">Si las credenciales son válidas, cree un **IPrincipal** y establecer `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="4f07b-179">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="4f07b-180">El siguiente código muestra la **AuthenticateAsync** método desde el [la autenticación básica](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) ejemplo.</span><span class="sxs-lookup"><span data-stu-id="4f07b-180">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="4f07b-181">Cada paso indican los comentarios.</span><span class="sxs-lookup"><span data-stu-id="4f07b-181">The comments indicate each step.</span></span> <span data-ttu-id="4f07b-182">El código muestra varios tipos de error: encabezado de una autorización no tiene las credenciales, las credenciales con formato incorrecto y nombre de usuario/contraseña incorrecta.</span><span class="sxs-lookup"><span data-stu-id="4f07b-182">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="4f07b-183">Establecer un resultado de Error</span><span class="sxs-lookup"><span data-stu-id="4f07b-183">Setting an Error Result</span></span>

<span data-ttu-id="4f07b-184">Si las credenciales son válidas, debe establecer el filtro `context.ErrorResult` a una **IHttpActionResult** que crea una respuesta de error.</span><span class="sxs-lookup"><span data-stu-id="4f07b-184">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="4f07b-185">Para obtener más información acerca de **IHttpActionResult**, consulte [resultados de la acción en API Web 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="4f07b-185">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="4f07b-186">El ejemplo de la autenticación básica se incluye un `AuthenticationFailureResult` clase que es adecuado para este propósito.</span><span class="sxs-lookup"><span data-stu-id="4f07b-186">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="4f07b-187">Implementar ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="4f07b-187">Implementing ChallengeAsync</span></span>

<span data-ttu-id="4f07b-188">El propósito de la **ChallengeAsync** método consiste en Agregar desafíos de autenticación a la respuesta, si es necesario.</span><span class="sxs-lookup"><span data-stu-id="4f07b-188">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="4f07b-189">Aquí se muestra la signatura de método:</span><span class="sxs-lookup"><span data-stu-id="4f07b-189">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="4f07b-190">Se llama al método en cada filtro de autenticación en la canalización de solicitudes.</span><span class="sxs-lookup"><span data-stu-id="4f07b-190">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="4f07b-191">Es importante entender que **ChallengeAsync** se denomina *antes de* la respuesta HTTP se haya creado y posiblemente incluso antes de que se ejecuta la acción de controlador.</span><span class="sxs-lookup"><span data-stu-id="4f07b-191">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="4f07b-192">Cuando **ChallengeAsync** se llama, `context.Result` contiene un **IHttpActionResult**, que se utiliza posteriormente para crear la respuesta HTTP.</span><span class="sxs-lookup"><span data-stu-id="4f07b-192">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="4f07b-193">Por lo que cuando **ChallengeAsync** es llama, no sabe nada acerca de la respuesta HTTP todavía.</span><span class="sxs-lookup"><span data-stu-id="4f07b-193">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="4f07b-194">El **ChallengeAsync** método debe reemplazar el valor original de `context.Result` con un nuevo **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="4f07b-194">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="4f07b-195">Esto **IHttpActionResult** debe contener el original `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="4f07b-195">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="4f07b-196">A la que llamaré original **IHttpActionResult** el *resultados interno*y a los nuevos **IHttpActionResult** el *resultado externo*.</span><span class="sxs-lookup"><span data-stu-id="4f07b-196">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="4f07b-197">El resultado externo debe hacer lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="4f07b-197">The outer result must do the following:</span></span>

1. <span data-ttu-id="4f07b-198">Invoque el resultado interno para crear la respuesta HTTP.</span><span class="sxs-lookup"><span data-stu-id="4f07b-198">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="4f07b-199">Examine la respuesta.</span><span class="sxs-lookup"><span data-stu-id="4f07b-199">Examine the response.</span></span>
3. <span data-ttu-id="4f07b-200">Agregue un desafío de autenticación a la respuesta, si es necesario.</span><span class="sxs-lookup"><span data-stu-id="4f07b-200">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="4f07b-201">En el siguiente ejemplo se toma del ejemplo de la autenticación básica.</span><span class="sxs-lookup"><span data-stu-id="4f07b-201">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="4f07b-202">Define un **IHttpActionResult** para el resultado externo.</span><span class="sxs-lookup"><span data-stu-id="4f07b-202">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="4f07b-203">El `InnerResult` propiedad contiene interna **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="4f07b-203">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="4f07b-204">El `Challenge` propiedad representa un encabezado de autenticación Www.</span><span class="sxs-lookup"><span data-stu-id="4f07b-204">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="4f07b-205">Tenga en cuenta que **ExecuteAsync** llama primero `InnerResult.ExecuteAsync` para crear la respuesta HTTP y, a continuación, agrega el desafío si es necesario.</span><span class="sxs-lookup"><span data-stu-id="4f07b-205">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="4f07b-206">Compruebe el código de respuesta antes de agregar el desafío.</span><span class="sxs-lookup"><span data-stu-id="4f07b-206">Check the response code before adding the challenge.</span></span> <span data-ttu-id="4f07b-207">La mayoría de los esquemas de autenticación solo agregar un desafío si la respuesta es 401, como se muestra aquí.</span><span class="sxs-lookup"><span data-stu-id="4f07b-207">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="4f07b-208">Sin embargo, algunos esquemas de autenticación agregar un desafío para una respuesta correcta.</span><span class="sxs-lookup"><span data-stu-id="4f07b-208">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="4f07b-209">Por ejemplo, vea [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="4f07b-209">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="4f07b-210">Dada la `AddChallengeOnUnauthorizedResult` de la clase, el código real en **ChallengeAsync** es sencillo.</span><span class="sxs-lookup"><span data-stu-id="4f07b-210">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="4f07b-211">Que acaba de crear el resultado y asóciela al `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="4f07b-211">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="4f07b-212">Nota: El ejemplo de la autenticación básica abstrae un poco, esta lógica mediante la colocación en un método de extensión.</span><span class="sxs-lookup"><span data-stu-id="4f07b-212">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="4f07b-213">Combinación de filtros de autenticación con autenticación a nivel de Host</span><span class="sxs-lookup"><span data-stu-id="4f07b-213">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="4f07b-214">"Autenticación de nivel de host" es la autenticación realizada por el host (como IIS), antes el marco de trabajo de solicitud llega a la API Web.</span><span class="sxs-lookup"><span data-stu-id="4f07b-214">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="4f07b-215">A menudo, puede que desee para habilitar la autenticación de nivel de host para el resto de la aplicación, pero deshabilitar para los controladores de API Web.</span><span class="sxs-lookup"><span data-stu-id="4f07b-215">Often, you may want to to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="4f07b-216">Por ejemplo, un escenario típico es habilitar la autenticación de formularios en el nivel de host, pero usa autenticación basada en el símbolo (token) de API Web.</span><span class="sxs-lookup"><span data-stu-id="4f07b-216">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="4f07b-217">Para deshabilitar la autenticación de nivel de host dentro de la canalización Web API, llamar a `config.SuppressHostPrincipal()` en la configuración.</span><span class="sxs-lookup"><span data-stu-id="4f07b-217">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="4f07b-218">Esto hace que la API Web quitar la **IPrincipal** desde cualquier solicitud que entra en la canalización Web API.</span><span class="sxs-lookup"><span data-stu-id="4f07b-218">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="4f07b-219">De hecho, se &quot;anular-autentica&quot; la solicitud.</span><span class="sxs-lookup"><span data-stu-id="4f07b-219">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="4f07b-220">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="4f07b-220">Additional Resources</span></span>

<span data-ttu-id="4f07b-221">[Los filtros de seguridad de ASP.NET Web API](https://msdn.microsoft.com/en-us/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="4f07b-221">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/en-us/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
