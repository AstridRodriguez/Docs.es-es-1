---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: La cuenta de confirmación y recuperación de contraseña con la identidad de ASP.NET (C#) | Documentos de Microsoft
author: HaoK
description: Antes de realizar este tutorial que debe completar primero cree una aplicación web de ASP.NET MVC 5 segura con registro de restablecimiento de contraseña y de confirmación de correo electrónico. Este tutorial...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/26/2015
ms.topic: article
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 0167388cf6b488b72ca36f583a7794690dbf9900
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/06/2018
ms.locfileid: "30876038"
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="f8372-104">Confirmación de cuenta y contraseña de recuperación con la identidad de ASP.NET (C#)</span><span class="sxs-lookup"><span data-stu-id="f8372-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="f8372-105">por [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="f8372-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="f8372-106">Antes de realizar este tutorial debe completar [crear una aplicación web de ASP.NET MVC 5 segura con registro de restablecimiento de contraseña y de confirmación de correo electrónico](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="f8372-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="f8372-107">Este tutorial contiene información más detallada y le mostrará cómo configurar el correo electrónico de confirmación de la cuenta local y permitir a los usuarios restablecer su contraseña olvidada en ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="f8372-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="f8372-108">En este artículo se escribió Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung y Suhas Joshi.</span><span class="sxs-lookup"><span data-stu-id="f8372-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="f8372-109">El ejemplo de NuGet escribió principalmente Hao Kung.</span><span class="sxs-lookup"><span data-stu-id="f8372-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="f8372-110">Una cuenta de usuario local requiere que el usuario crear una contraseña para la cuenta y contraseña se almacena (de forma segura) en la aplicación web.</span><span class="sxs-lookup"><span data-stu-id="f8372-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="f8372-111">Identidad de ASP.NET también admite cuentas sociales, que no requieren que el usuario crear una contraseña para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="f8372-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="f8372-112">[Cuentas sociales](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) usar terceros (por ejemplo, Google, Twitter, Facebook o Microsoft) para autenticar a los usuarios.</span><span class="sxs-lookup"><span data-stu-id="f8372-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="f8372-113">En este tema se trata lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="f8372-113">This topic covers the following:</span></span>

- <span data-ttu-id="f8372-114">[Crear una aplicación de ASP.NET MVC](#createMvc) y explore las características de ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="f8372-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="f8372-115">Generar el ejemplo de identidad</span><span class="sxs-lookup"><span data-stu-id="f8372-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="f8372-116">Configurar la confirmación por correo electrónico</span><span class="sxs-lookup"><span data-stu-id="f8372-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="f8372-117">Los nuevos usuarios registran sus alias de correo electrónico, que crea una cuenta local.</span><span class="sxs-lookup"><span data-stu-id="f8372-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="f8372-118">Haga clic en el botón Registrar envía un correo electrónico de confirmación que contiene un símbolo (token) de validación a su dirección de correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="f8372-119">El usuario se envía un correo electrónico con un token de confirmación de su cuenta.</span><span class="sxs-lookup"><span data-stu-id="f8372-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="f8372-120">Haga clic en el vínculo, se confirma la cuenta.</span><span class="sxs-lookup"><span data-stu-id="f8372-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="f8372-121">Recuperación/restablecimiento de contraseña</span><span class="sxs-lookup"><span data-stu-id="f8372-121">Password recovery/reset</span></span>

<span data-ttu-id="f8372-122">Los usuarios locales que olviden su contraseña pueden tener un token de seguridad que se envía a su cuenta de correo electrónico, les permite restablecer su contraseña lo que.</span><span class="sxs-lookup"><span data-stu-id="f8372-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="f8372-123">Pronto, el usuario recibirá un correo electrónico con un vínculo lo que les permite restablecer su contraseña.</span><span class="sxs-lookup"><span data-stu-id="f8372-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="f8372-124">Haga clic en el vínculo lleva a la página de restablecimiento.</span><span class="sxs-lookup"><span data-stu-id="f8372-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="f8372-125">Al hacer clic en el **restablecer** botón confirmará que se ha restablecido la contraseña.</span><span class="sxs-lookup"><span data-stu-id="f8372-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="f8372-126">Crear una aplicación Web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="f8372-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="f8372-127">Empiece por instalar y ejecutar [Visual Studio Express 2013 para Web](https://go.microsoft.com/fwlink/?LinkId=299058) o [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span><span class="sxs-lookup"><span data-stu-id="f8372-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="f8372-128">Instalar Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) o superior.</span><span class="sxs-lookup"><span data-stu-id="f8372-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="f8372-129">Advertencia: Debe instalar Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) para completar este tutorial.</span><span class="sxs-lookup"><span data-stu-id="f8372-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="f8372-130">Cree un nuevo proyecto Web de ASP.NET y seleccione la plantilla MVC.</span><span class="sxs-lookup"><span data-stu-id="f8372-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="f8372-131">Formularios Web Forms también admite la identidad de ASP.NET, por lo que podría seguir pasos similares en una aplicación de formularios web.</span><span class="sxs-lookup"><span data-stu-id="f8372-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="f8372-132">Deje la autenticación predeterminada como **cuentas de usuario individuales**.</span><span class="sxs-lookup"><span data-stu-id="f8372-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="f8372-133">Ejecutar la aplicación, haga clic en el **registrar** vincular y registrar un usuario.</span><span class="sxs-lookup"><span data-stu-id="f8372-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="f8372-134">En este punto, es la única validación en el correo electrónico con el [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) atributo.</span><span class="sxs-lookup"><span data-stu-id="f8372-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="f8372-135">En el Explorador de servidores, vaya a **datos Connections\DefaultConnection\Tables\AspNetUsers**, haga clic en y seleccione **Abrir definición de tabla**.</span><span class="sxs-lookup"><span data-stu-id="f8372-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="f8372-136">La siguiente imagen muestra la `AspNetUsers` esquema:</span><span class="sxs-lookup"><span data-stu-id="f8372-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="f8372-137">Haga clic con el botón secundario en el **AspNetUsers** de tabla y seleccione **mostrar datos de tabla**.</span><span class="sxs-lookup"><span data-stu-id="f8372-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="f8372-138">En este momento, no se ha confirmado el correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="f8372-139">El almacén de datos predeterminado para ASP.NET Identity es Entity Framework, pero puede configurarlo para usar otros almacenes de datos y para agregar campos adicionales.</span><span class="sxs-lookup"><span data-stu-id="f8372-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="f8372-140">Vea [recursos adicionales](#addRes) sección al final de este tutorial.</span><span class="sxs-lookup"><span data-stu-id="f8372-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="f8372-141">El [clase de inicio OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) se llama cuando la aplicación se inicia y se invoca el `ConfigureAuth` método *aplicación\_Start\Startup.Auth.cs*, que configura la canalización OWIN e inicializa ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="f8372-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="f8372-142">Examine el `ConfigureAuth` método.</span><span class="sxs-lookup"><span data-stu-id="f8372-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="f8372-143">Cada `CreatePerOwinContext` llamada registra una devolución de llamada (guardado en el `OwinContext`) que se llamará una vez por solicitud para crear una instancia del tipo especificado.</span><span class="sxs-lookup"><span data-stu-id="f8372-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="f8372-144">Puede establecer un punto de interrupción en el constructor y `Create` método de cada tipo (`ApplicationDbContext, ApplicationUserManager`) y compruebe que se llaman en cada solicitud.</span><span class="sxs-lookup"><span data-stu-id="f8372-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="f8372-145">Una instancia de `ApplicationDbContext` y `ApplicationUserManager` se almacena en el contexto OWIN, que se puede acceder a lo largo de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="f8372-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="f8372-146">ASP.NET Identity se enlaza a la canalización OWIN a través de middleware de cookies.</span><span class="sxs-lookup"><span data-stu-id="f8372-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="f8372-147">Para obtener más información, consulte [por administración de la duración de solicitud para la clase UserManager en ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="f8372-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="f8372-148">Cuando se cambia el perfil de seguridad, un nuevo sello de seguridad se generan y almacenan en la `SecurityStamp` campo de la *AspNetUsers* tabla.</span><span class="sxs-lookup"><span data-stu-id="f8372-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="f8372-149">Tenga en cuenta que el `SecurityStamp` campo es diferente de la cookie de seguridad.</span><span class="sxs-lookup"><span data-stu-id="f8372-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="f8372-150">La cookie de seguridad no se almacena en la `AspNetUsers` tabla (o cualquier otra estructura en la base de datos de identidad en).</span><span class="sxs-lookup"><span data-stu-id="f8372-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="f8372-151">El token de cookie de seguridad es autofirmado mediante [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) y se crea con el `UserId, SecurityStamp` e información de tiempo de expiración.</span><span class="sxs-lookup"><span data-stu-id="f8372-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="f8372-152">El middleware de cookies, comprueba la cookie en cada solicitud.</span><span class="sxs-lookup"><span data-stu-id="f8372-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="f8372-153">El `SecurityStampValidator` método en el `Startup` clase llega a la base de datos y comprueba el sello de seguridad de forma periódica, según se haya especificado con el `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="f8372-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="f8372-154">Esto sólo ocurre cada 30 minutos (en nuestro ejemplo) a menos que cambie el perfil de seguridad.</span><span class="sxs-lookup"><span data-stu-id="f8372-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="f8372-155">El intervalo de 30 minutos se ha elegido para reducir los viajes a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f8372-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="f8372-156">Consulte mi [tutorial de autenticación en dos fases](index.md) para obtener más detalles.</span><span class="sxs-lookup"><span data-stu-id="f8372-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="f8372-157">Por los comentarios en el código, el `UseCookieAuthentication` método es compatible con la autenticación con cookies.</span><span class="sxs-lookup"><span data-stu-id="f8372-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="f8372-158">La `SecurityStamp` código de campo y asociado proporciona un nivel adicional de seguridad a la aplicación, al cambiar la contraseña, se registrarán fuera del explorador que está conectado.</span><span class="sxs-lookup"><span data-stu-id="f8372-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="f8372-159">El `SecurityStampValidator.OnValidateIdentity` método permite que la aplicación validar el token de seguridad cuando el usuario inicia sesión, que se usa cuando se cambia una contraseña o usa el inicio de sesión externo.</span><span class="sxs-lookup"><span data-stu-id="f8372-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="f8372-160">Esto es necesario para asegurarse de que se invalidan los tokens (cookies) que se genera con la contraseña antigua.</span><span class="sxs-lookup"><span data-stu-id="f8372-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="f8372-161">En el proyecto de ejemplo, si cambia la contraseña de los usuarios, a continuación, un nuevo símbolo (token) se genera para el usuario, se invalidan los tokens anteriores y `SecurityStamp` se actualiza el campo.</span><span class="sxs-lookup"><span data-stu-id="f8372-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="f8372-162">El sistema de identidades le permiten configurar la aplicación, cuando cambia el perfil de seguridad de los usuarios (por ejemplo, cuando el usuario cambie su contraseña o cambios asociado el inicio de sesión (por ejemplo, Facebook, Google, cuenta de Microsoft, etc.), el usuario ha iniciado de todos los instancias del explorador.</span><span class="sxs-lookup"><span data-stu-id="f8372-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="f8372-163">Por ejemplo, la imagen siguiente muestra el [ejemplo de cierre de sesión único](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) aplicación, lo que permite al usuario cerrar sesión en todas las instancias del explorador (en este caso, Internet Explorer, Firefox y Chrome) haciendo clic en un botón.</span><span class="sxs-lookup"><span data-stu-id="f8372-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="f8372-164">Como alternativa, el ejemplo permite solo cerrar sesión en una instancia de explorador específico.</span><span class="sxs-lookup"><span data-stu-id="f8372-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="f8372-165">El [ejemplo de cierre de sesión único](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) aplicación muestra cómo ASP.NET Identity permite volver a generar el token de seguridad.</span><span class="sxs-lookup"><span data-stu-id="f8372-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="f8372-166">Esto es necesario para asegurarse de que se invalidan los tokens (cookies) que se genera con la contraseña antigua.</span><span class="sxs-lookup"><span data-stu-id="f8372-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="f8372-167">Esta característica proporciona un nivel adicional de seguridad a la aplicación; al cambiar la contraseña, se conectará a donde ha iniciado sesión en esta aplicación.</span><span class="sxs-lookup"><span data-stu-id="f8372-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="f8372-168">El *aplicación\_Start\IdentityConfig.cs* archivo contiene la `ApplicationUserManager`, `EmailService` y `SmsService` clases.</span><span class="sxs-lookup"><span data-stu-id="f8372-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="f8372-169">El `EmailService` y `SmsService` clases cada implementan la `IIdentityMessageService` de la interfaz, por lo que tiene los métodos comunes de cada clase para configurar correo electrónico y SMS.</span><span class="sxs-lookup"><span data-stu-id="f8372-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="f8372-170">Aunque este tutorial solo muestra cómo agregar la notificación de correo electrónico a través de [SendGrid](http://sendgrid.com/), puede enviar correo electrónico mediante SMTP y otros mecanismos.</span><span class="sxs-lookup"><span data-stu-id="f8372-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="f8372-171">El `Startup` clase también contiene el modelo para agregar inicios de sesión sociales (Facebook, Twitter, etc.), vea el tutorial [aplicación de MVC 5 con Facebook, Twitter, LinkedIn y en el inicio de sesión de Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="f8372-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="f8372-172">Examine el `ApplicationUserManager` (clase), que contiene la información de identidad de los usuarios y configura las siguientes características:</span><span class="sxs-lookup"><span data-stu-id="f8372-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="f8372-173">Requisitos de seguridad de contraseña.</span><span class="sxs-lookup"><span data-stu-id="f8372-173">Password strength requirements.</span></span>
- <span data-ttu-id="f8372-174">Bloqueo de usuario (intentos y el tiempo).</span><span class="sxs-lookup"><span data-stu-id="f8372-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="f8372-175">Autenticación en dos fases (2FA).</span><span class="sxs-lookup"><span data-stu-id="f8372-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="f8372-176">Se cubren 2FA y SMS en el otro tutorial.</span><span class="sxs-lookup"><span data-stu-id="f8372-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="f8372-177">Enlazar el correo electrónico y servicios de SMS.</span><span class="sxs-lookup"><span data-stu-id="f8372-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="f8372-178">(Tratarán SMS en otro tutorial).</span><span class="sxs-lookup"><span data-stu-id="f8372-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="f8372-179">El `ApplicationUserManager` clase se deriva de la interfaz genérica `UserManager<ApplicationUser>` clase.</span><span class="sxs-lookup"><span data-stu-id="f8372-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="f8372-180">`ApplicationUser` se deriva de [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="f8372-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="f8372-181">`IdentityUser` se deriva de la interfaz genérica `IdentityUser` clase:</span><span class="sxs-lookup"><span data-stu-id="f8372-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="f8372-182">Las propiedades anteriores coincidan con las propiedades de la `AspNetUsers` tabla, que aparece anteriormente.</span><span class="sxs-lookup"><span data-stu-id="f8372-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="f8372-183">Argumentos genéricos en `IUser` le permiten derivar una clase con distintos tipos para la clave principal.</span><span class="sxs-lookup"><span data-stu-id="f8372-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="f8372-184">Consulte la [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) ejemplo que muestra cómo cambiar la clave principal de string a int o GUID.</span><span class="sxs-lookup"><span data-stu-id="f8372-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="f8372-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="f8372-185">ApplicationUser</span></span>

<span data-ttu-id="f8372-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) se define en *Models\IdentityModels.cs* como:</span><span class="sxs-lookup"><span data-stu-id="f8372-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="f8372-187">El resaltado código anterior genera un [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="f8372-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="f8372-188">ASP.NET Identity y OWIN Cookie de autenticación basada en notificaciones, por lo tanto, el marco de trabajo requiere la aplicación para generar un `ClaimsIdentity` para el usuario.</span><span class="sxs-lookup"><span data-stu-id="f8372-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="f8372-189">`ClaimsIdentity` contiene información acerca de todas las notificaciones para el usuario, como el nombre del usuario, la edad y cuáles son las funciones que pertenece el usuario.</span><span class="sxs-lookup"><span data-stu-id="f8372-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="f8372-190">También puede agregar más notificaciones para el usuario en esta fase.</span><span class="sxs-lookup"><span data-stu-id="f8372-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="f8372-191">OWIN `AuthenticationManager.SignIn` método pasa en el `ClaimsIdentity` e inicia sesión en el usuario:</span><span class="sxs-lookup"><span data-stu-id="f8372-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="f8372-192">[Aplicación de MVC 5 con Facebook, Twitter, LinkedIn y en el inicio de sesión de Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) muestra cómo puede agregar propiedades adicionales para la `ApplicationUser` clase.</span><span class="sxs-lookup"><span data-stu-id="f8372-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="f8372-193">Confirmación por correo electrónico</span><span class="sxs-lookup"><span data-stu-id="f8372-193">Email confirmation</span></span>

<span data-ttu-id="f8372-194">Es una buena idea para confirmar el correo electrónico de un nuevo usuario registrar con para comprobar que no utiliza la suplantación otra persona (es decir, no ha registrado con el correo electrónico de otra persona).</span><span class="sxs-lookup"><span data-stu-id="f8372-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="f8372-195">Supongamos que tenemos un foro de discusión, puede que desee evitar `"bob@example.com"` al registrar como `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="f8372-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="f8372-196">Sin confirmación por correo electrónico, `"joe@contoso.com"` pudo obtener el correo electrónico no deseado de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="f8372-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="f8372-197">Suponga que Roberto accidentalmente registrado como `"bib@example.com"` y no vio, no podrá usar la recuperación de contraseña porque la aplicación no tiene su correo electrónico correcto.</span><span class="sxs-lookup"><span data-stu-id="f8372-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="f8372-198">Confirmación por correo electrónico proporciona sólo una protección limitada de robots y no proporciona protección de correo basura determinado, tienen muchos alias de correo electrónico de trabajo que puede usar para registrar. En el ejemplo siguiente, el usuario no podrá cambiar su contraseña hasta que se ha confirmado su cuenta (por ellas haciendo clic en un vínculo de confirmación recibido en la cuenta de correo electrónico que se registran con.) Puede aplicar este flujo de trabajo a otros escenarios, por ejemplo, al enviar un vínculo para confirmar y restablecer la contraseña en las nuevas cuentas creadas por el Administrador de envío de correo electrónico al usuario cuando ha cambiado su perfil y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="f8372-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="f8372-199">En general conveniente evitar que los nuevos usuarios se registren todos los datos del sitio web antes de que se han confirmado por correo electrónico, un mensaje de texto SMS u otro mecanismo.</span><span class="sxs-lookup"><span data-stu-id="f8372-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="f8372-200">Al compilar un ejemplo más completo</span><span class="sxs-lookup"><span data-stu-id="f8372-200">Building a more complete sample</span></span>

<span data-ttu-id="f8372-201">En esta sección, deberá usar NuGet para descargar un ejemplo más completo, con que vamos a trabajar.</span><span class="sxs-lookup"><span data-stu-id="f8372-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="f8372-202">Crear un nuevo ***vacía*** proyecto Web de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f8372-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="f8372-203">En la consola de administrador de paquetes, escriba lo siguiente los siguientes comandos:</span><span class="sxs-lookup"><span data-stu-id="f8372-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="f8372-204">En este tutorial, usaremos [SendGrid](http://sendgrid.com/) para enviar correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="f8372-205">El `Identity.Samples` paquete instala el código que se va a trabajar.</span><span class="sxs-lookup"><span data-stu-id="f8372-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="f8372-206">Establecer el [proyecto para usar SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="f8372-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="f8372-207">Creación de la cuenta local de pruebas mediante la ejecución de la aplicación, haga clic en el **registrar** vincular y publicar el formulario de registro.</span><span class="sxs-lookup"><span data-stu-id="f8372-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="f8372-208">Haga clic en el vínculo de correo electrónico de demostración, que simula la confirmación por correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="f8372-209">Eliminar el código de confirmación del vínculo de correo electrónico de demostración de la muestra (el `ViewBag.Link` código en el controlador de la cuenta.</span><span class="sxs-lookup"><span data-stu-id="f8372-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="f8372-210">Consulte la `DisplayEmail` y `ForgotPasswordConfirmation` métodos de acción y vistas de razor).</span><span class="sxs-lookup"><span data-stu-id="f8372-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="f8372-211">Advertencia: Si cambia cualquiera de las opciones de seguridad en este ejemplo, aplicaciones de ensayo deberá someterse a una auditoría de seguridad que se llame explícitamente a los cambios realizados.</span><span class="sxs-lookup"><span data-stu-id="f8372-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="f8372-212">Examine el código de aplicación\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="f8372-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="f8372-213">El ejemplo muestra cómo crear una cuenta y agréguela a la *administración* rol.</span><span class="sxs-lookup"><span data-stu-id="f8372-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="f8372-214">Debe reemplazar el correo electrónico en el ejemplo con el correo electrónico que se va a usar para la cuenta de administrador.</span><span class="sxs-lookup"><span data-stu-id="f8372-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="f8372-215">La manera más fácil ahora para crear una cuenta de administrador está mediante programación en el `Seed` método.</span><span class="sxs-lookup"><span data-stu-id="f8372-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="f8372-216">Esperamos que en el futuro una herramienta que le permitirá crear y administrar usuarios y roles.</span><span class="sxs-lookup"><span data-stu-id="f8372-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="f8372-217">El código de ejemplo le permiten crear y administrar usuarios y roles, pero primero debe tener una cuenta de administradores para ejecutar los roles y las páginas de administración de usuario.</span><span class="sxs-lookup"><span data-stu-id="f8372-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="f8372-218">En este ejemplo, se crea la cuenta de administrador cuando la base de datos es visible.</span><span class="sxs-lookup"><span data-stu-id="f8372-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="f8372-219">Cambiar la contraseña y cambie el nombre a una cuenta que puede recibir notificaciones por correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="f8372-220">Seguridad - nunca almacenar los datos confidenciales en el código fuente.</span><span class="sxs-lookup"><span data-stu-id="f8372-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="f8372-221">Como se mencionó anteriormente, el `app.CreatePerOwinContext` llamada en la clase de inicio agrega las devoluciones de llamada para el `Create` método la aplicación DB contenidas, administrador y el rol de administrador de clases de usuario.</span><span class="sxs-lookup"><span data-stu-id="f8372-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="f8372-222">Llamadas de canalización de OWIN la `Create` método en estas clases para cada solicitud y almacena el contexto para cada clase.</span><span class="sxs-lookup"><span data-stu-id="f8372-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="f8372-223">El controlador account expone el Administrador de usuarios desde el contexto HTTP (que contiene el contexto OWIN):</span><span class="sxs-lookup"><span data-stu-id="f8372-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="f8372-224">Cuando un usuario registra una cuenta local, el `HTTP Post Register` se llama al método:</span><span class="sxs-lookup"><span data-stu-id="f8372-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="f8372-225">El código anterior usa el modelo de datos para crear una nueva cuenta de usuario mediante el correo electrónico y una contraseña escritos.</span><span class="sxs-lookup"><span data-stu-id="f8372-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="f8372-226">Si el alias de correo electrónico está en el almacén de datos, se produce un error en la creación de cuentas y vuelve a aparecer el formulario.</span><span class="sxs-lookup"><span data-stu-id="f8372-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="f8372-227">El `GenerateEmailConfirmationTokenAsync` método crea un token de confirmación segura y lo almacena en el almacén de datos de identidades de ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f8372-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="f8372-228">El [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) método crea un vínculo que contiene el `UserId` y token de confirmación.</span><span class="sxs-lookup"><span data-stu-id="f8372-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="f8372-229">Este vínculo, a continuación, se envían por correo electrónico al usuario, el usuario puede hacer clic en el vínculo de su aplicación de correo electrónico para confirmar su cuenta.</span><span class="sxs-lookup"><span data-stu-id="f8372-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="f8372-230">Configurar la confirmación por correo electrónico</span><span class="sxs-lookup"><span data-stu-id="f8372-230">Set up email confirmation</span></span>

<span data-ttu-id="f8372-231">Vaya a la [página de registro Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) y registrar una cuenta de forma gratuita.</span><span class="sxs-lookup"><span data-stu-id="f8372-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="f8372-232">Agregue código similar al siguiente para configurar SendGrid:</span><span class="sxs-lookup"><span data-stu-id="f8372-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="f8372-233">Con frecuencia, los clientes de correo electrónico acepten sólo los mensajes de texto (no HTML).</span><span class="sxs-lookup"><span data-stu-id="f8372-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="f8372-234">Debe proporcionar el mensaje de texto y HTML.</span><span class="sxs-lookup"><span data-stu-id="f8372-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="f8372-235">En el ejemplo anterior de SendGrid, esto se consigue con la `myMessage.Text` y `myMessage.Html` código mostrado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="f8372-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="f8372-236">El código siguiente muestra cómo enviar correo electrónico utilizando el [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) clase where `message.Body` devuelve solo el vínculo.</span><span class="sxs-lookup"><span data-stu-id="f8372-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="f8372-237">Seguridad - nunca almacenar los datos confidenciales en el código fuente.</span><span class="sxs-lookup"><span data-stu-id="f8372-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="f8372-238">La cuenta y las credenciales se almacenan en el appSetting.</span><span class="sxs-lookup"><span data-stu-id="f8372-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="f8372-239">En Azure, puede almacenar con seguridad estos valores en el **[configurar](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** ficha en el portal de Azure.</span><span class="sxs-lookup"><span data-stu-id="f8372-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="f8372-240">Vea [las prácticas recomendadas para implementar las contraseñas y otros datos confidenciales en ASP.NET y Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="f8372-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="f8372-241">Escriba las credenciales de SendGrid, ejecutar la aplicación, registrarse con un alias de correo electrónico puede haga clic en el vínculo de confirmación en el correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="f8372-242">Para ver cómo hacerlo con su [Outlook.com](http://outlook.com) cuentas de correo electrónico, consulte de John Atten [configuración SMTP de C# para el Host de SMTP de Outlook.Com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) y su[ASP.NET 2.0 de identidad: configuración de la validación de la cuenta y la autorización de dos fases](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) envía.</span><span class="sxs-lookup"><span data-stu-id="f8372-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="f8372-243">Una vez que un usuario hace clic en el **registrar** botón se envía un correo electrónico de confirmación que contiene un token de validación a su dirección de correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="f8372-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="f8372-244">El usuario se envía un correo electrónico con un token de confirmación de su cuenta.</span><span class="sxs-lookup"><span data-stu-id="f8372-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="f8372-245">Examine el código</span><span class="sxs-lookup"><span data-stu-id="f8372-245">Examine the code</span></span>

<span data-ttu-id="f8372-246">En el código siguiente se muestra el método `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="f8372-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="f8372-247">El método produce un error en modo silencioso si no se ha confirmado el correo electrónico del usuario.</span><span class="sxs-lookup"><span data-stu-id="f8372-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="f8372-248">Si se ha registrado un error para una dirección de correo electrónico no válida, los usuarios malintencionados pudieron utilizar esa información para buscar el identificador de usuario válido (alias de correo electrónico) a los ataques.</span><span class="sxs-lookup"><span data-stu-id="f8372-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="f8372-249">El código siguiente muestra el `ConfirmEmail` método en el controlador de la cuenta que se llama cuando el usuario hace clic en el vínculo de confirmación del correo electrónico enviado a estos:</span><span class="sxs-lookup"><span data-stu-id="f8372-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="f8372-250">Una vez que se ha utilizado un token de contraseña olvidada, se invalida.</span><span class="sxs-lookup"><span data-stu-id="f8372-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="f8372-251">El cambio en el código siguiente en el `Create` (método) (en el *aplicación\_Start\IdentityConfig.cs* archivo) establece los tokens a punto de expirar en 3 horas.</span><span class="sxs-lookup"><span data-stu-id="f8372-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="f8372-252">Con el código anterior, la contraseña olvidada y los tokens de confirmación de correo electrónico expirará en 3 horas.</span><span class="sxs-lookup"><span data-stu-id="f8372-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="f8372-253">El valor predeterminado `TokenLifespan` es un día.</span><span class="sxs-lookup"><span data-stu-id="f8372-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="f8372-254">El código siguiente muestra el método de confirmación de correo electrónico:</span><span class="sxs-lookup"><span data-stu-id="f8372-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="f8372-255">Para hacer que su aplicación más segura, ASP.NET Identity admite la autenticación en dos fases (2FA).</span><span class="sxs-lookup"><span data-stu-id="f8372-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="f8372-256">Vea [identidad de ASP.NET 2.0: configurar la validación de la cuenta y la autorización de dos fases](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) por John Atten.</span><span class="sxs-lookup"><span data-stu-id="f8372-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="f8372-257">Aunque puede establecer el bloqueo de cuenta en los errores de intento de contraseña de inicio de sesión, este enfoque hace susceptible a su inicio de sesión [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) bloqueos.</span><span class="sxs-lookup"><span data-stu-id="f8372-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="f8372-258">Se recomienda que usar el bloqueo de cuenta con 2FA.</span><span class="sxs-lookup"><span data-stu-id="f8372-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="f8372-259">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="f8372-259">Additional Resources</span></span>

- [<span data-ttu-id="f8372-260">Información general sobre los proveedores de almacenamiento personalizado para ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="f8372-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="f8372-261">[Aplicación de MVC 5 con Facebook, Twitter, LinkedIn y Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) también muestra cómo agregar información de perfil a la tabla de usuarios.</span><span class="sxs-lookup"><span data-stu-id="f8372-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="f8372-262">[ASP.NET MVC e identidad 2.0: comprende los fundamentos](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) por John Atten.</span><span class="sxs-lookup"><span data-stu-id="f8372-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="f8372-263">Introducción a ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="f8372-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="f8372-264">[Anuncio de RTM de ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) por Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="f8372-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
