---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: "Ajuste las modificaciones de base de datos dentro de una transacción (C#) | Documentos de Microsoft"
author: rick-anderson
description: "Este tutorial es el primero de cuatro que examina la actualización, eliminación e inserción de lotes de datos. En este tutorial se obtenga información acerca de cómo permitir que las transacciones de base de datos..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/26/2007
ms.topic: article
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: e2dafdf9a9414bddfca37ef942856c94096f35b8
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/24/2018
---
<a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="ddd3f-104">Ajuste las modificaciones de base de datos dentro de una transacción (C#)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-104">Wrapping Database Modifications within a Transaction (C#)</span></span>
====================
<span data-ttu-id="ddd3f-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="ddd3f-106">[Descargar código](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) o [descarga de PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="ddd3f-107">Este tutorial es el primero de cuatro que examina la actualización, eliminación e inserción de lotes de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="ddd3f-108">En este tutorial se obtenga información acerca de cómo permitir las transacciones de base de datos que las modificaciones de lote se lleve a cabo como una operación atómica, lo que garantiza que todos los pasos se realizan correctamente o producirá un error en todos los pasos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="ddd3f-109">Introducción</span><span class="sxs-lookup"><span data-stu-id="ddd3f-109">Introduction</span></span>

<span data-ttu-id="ddd3f-110">Como hemos visto a partir de la [una visión general de insertar, actualizar y eliminar datos](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, GridView proporciona compatibilidad integrada para la edición de nivel de fila y eliminar.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="ddd3f-111">Con unos pocos clics del mouse es posible crear una interfaz de modificación de datos enriquecidos sin escribir una línea de código, siempre y cuando el contenido con la edición y eliminación por fila.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="ddd3f-112">Sin embargo, en ciertos escenarios esto es suficiente y es necesario proporcionar a los usuarios la capacidad de modificar o eliminar un lote de registros.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="ddd3f-113">Por ejemplo, basada en web más clientes de correo electrónico utilizar una cuadrícula para mostrar cada mensaje donde cada fila incluye una casilla junto con la información de s de correo electrónico (asunto, remitente y así sucesivamente).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="ddd3f-114">Esta interfaz permite al usuario eliminar varios mensajes, comprobando que dichos datos y, a continuación, haga clic en un botón Eliminar mensajes seleccionados.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="ddd3f-115">Un lote a la interfaz de edición es ideal en situaciones donde los usuarios normalmente editar varios registros diferentes.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="ddd3f-116">En lugar de obligarle a los usuarios hacer clic en Editar, realizar sus cambios y, a continuación, haga clic en Actualizar para cada registro que se deba modificarse, representa como un lote en la interfaz de edición cada fila a su interfaz de edición.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="ddd3f-117">El usuario puede modificar rápidamente el conjunto de filas que deben cambiarse y, a continuación, guardar estos cambios, haga clic en un botón Actualizar todo.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="ddd3f-118">En este conjunto de tutoriales examinaremos cómo crear interfaces para insertar, modificar y eliminar lotes de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="ddd3f-119">Al realizar operaciones por lotes se producirá un error importante determinar si debe ser posible para algunas de las operaciones del lote sea correcta mientras que otras.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="ddd3f-120">¿Considere la posibilidad de un lote al eliminar la interfaz - qué debe ocurrir si el primer registro seleccionado se elimina correctamente, pero la segunda se produce un error, por ejemplo, debido a una infracción de restricción de clave externa?</span><span class="sxs-lookup"><span data-stu-id="ddd3f-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="ddd3f-121">¿La eliminación de registro s primera se debería deshacer o es aceptable para el primer registro permanezca eliminadas?</span><span class="sxs-lookup"><span data-stu-id="ddd3f-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="ddd3f-122">Si desea que la operación por lotes se trate como un [operación atómica](http://en.wikipedia.org/wiki/Atomic_operation), una donde ya sea todos los pasos correctamente o producirá un error en todos los pasos, debe aumentar para incluir compatibilidad con la capa de acceso a datos [base de datos las transacciones](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="ddd3f-123">Las transacciones de base de datos garantizan la atomicidad para el conjunto de `INSERT`, `UPDATE`, y `DELETE` instrucciones ejecutado bajo el paraguas de la transacción y son una característica compatible con la mayoría todos los sistemas de base de datos modernas.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="ddd3f-124">En este tutorial se examinará cómo ampliar la capa DAL para utilizar las transacciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="ddd3f-125">Los tutoriales posteriores examinará implementación páginas web para insertar, actualizar y eliminar interfaces de lote.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="ddd3f-126">Permiten s empiece a trabajar.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="ddd3f-127">Al modificar datos en una transacción por lotes, no se necesita siempre atomicidad.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="ddd3f-128">En algunos escenarios, puede ser aceptable disponer de algunas modificaciones de datos correctamente y otros usuarios en el mismo lote producirá un error, como cuando la eliminación de un conjunto de mensajes de correo electrónico desde un cliente de correo electrónico basado en web.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="ddd3f-129">Si hay s para procesar una mitad del error de base de datos a través de la eliminación, s probablemente aceptable que esos registros procesados sin errores quedan eliminados.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="ddd3f-130">En esos casos, la capa DAL no necesita modificarse para admitir las transacciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="ddd3f-131">Hay otros lote operación escenarios, sin embargo, donde la atomicidad es vital.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="ddd3f-132">Cuando un cliente mueve sus fondos de una cuenta bancaria a otra, se deben realizar dos operaciones: los fondos se deben deducir de la primera cuenta y, a continuación, se agrega a la segunda.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="ddd3f-133">Mientras el banco no posible problema con el primer paso correctamente pero se producirá un error en el segundo paso, como es lógico sería abrumados sus clientes.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="ddd3f-134">Le animo a trabajar en este tutorial e implementar las mejoras de la capa DAL para admitir las transacciones de base de datos, incluso si no tiene previsto en su uso en el lote de inserción, actualización y eliminación interfaces que desarrollaremos en los tres tutoriales siguientes.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="ddd3f-135">Información general de las transacciones</span><span class="sxs-lookup"><span data-stu-id="ddd3f-135">An Overview of Transactions</span></span>

<span data-ttu-id="ddd3f-136">La mayoría de las bases de datos incluyen compatibilidad con *transacciones*, que permiten que varios comandos de base de datos que se desea agrupar en una sola unidad lógica de trabajo.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="ddd3f-137">Se garantiza que los comandos de base de datos que componen una transacción atómica, lo que significa que todos los comandos se producirá un error o todos se realizará correctamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="ddd3f-138">En general, las transacciones se implementan a través de instrucciones SQL utilizando el modelo siguiente:</span><span class="sxs-lookup"><span data-stu-id="ddd3f-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="ddd3f-139">Indicar el inicio de una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="ddd3f-140">Ejecute las instrucciones SQL que componen la transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="ddd3f-141">Si se produce un error en una de las instrucciones del paso 2, revertir la transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="ddd3f-142">Si todas las instrucciones del paso 2 se completan sin errores, confirme la transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="ddd3f-143">Las instrucciones SQL usadas para crear, confirmar y revertir la transacción se puede introducir manualmente al escribir secuencias de comandos SQL o crear procedimientos almacenados o mediante programación implicará la utilización de ADO.NET o las clases de la [ `System.Transactions` espacio de nombres](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="ddd3f-144">En este tutorial que sólo examinaremos administrar transacciones utilizando ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="ddd3f-145">En un tutorial posterior, veremos cómo usar procedimientos almacenados en la capa de acceso a datos, momento en el que se explorará las instrucciones SQL para crear, revertir y confirmar las transacciones.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="ddd3f-146">Mientras tanto, consulte [administrar transacciones en procedimientos almacenados de SQL Server](http://www.4guysfromrolla.com/webtech/080305-1.shtml) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="ddd3f-147">El [ `TransactionScope` clase](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) en el `System.Transactions` espacio de nombres permite a los desarrolladores ajustar mediante programación una serie de instrucciones dentro del ámbito de una transacción e incluye compatibilidad para las transacciones complejas que requieren varios orígenes, como dos bases de datos diferentes o incluso heterogéneos tipos de almacenes de datos, como una base de datos de Microsoft SQL Server y una base de datos de Oracle, un servicio Web.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="ddd3f-148">¿Ha decidido utilizar transacciones de ADO.NET para este tutorial, en lugar de la `TransactionScope` clase porque ADO.NET es más específica para las transacciones de base de datos y, en muchos casos, es mucho menos recursos de forma intensiva.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="ddd3f-149">Además, en ciertos escenarios el `TransactionScope` clase utiliza el Coordinador de transacciones distribuidas de Microsoft (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="ddd3f-150">Los problemas de configuración, implementación y rendimiento MSDTC adyacente facilita un tema en su lugar especializado y avanzado y fuera del ámbito de estos tutoriales.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="ddd3f-151">Cuando se trabaja con el proveedor SqlClient en ADO.NET, las transacciones se inician a través de una llamada a la [ `SqlConnection` clase](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), que devuelve un [ `SqlTransaction` objeto](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="ddd3f-152">Las instrucciones de modificación de datos que la transacción de creación se colocan dentro de un `try...catch` bloque.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="ddd3f-153">Si se produce un error en una instrucción en el `try` bloquear las transferencias de ejecución a la `catch` bloque donde la transacción puede revertirse a través de la `SqlTransaction` objeto s [ `Rollback` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="ddd3f-154">Si todas las instrucciones completen correctamente, una llamada a la `SqlTransaction` objeto s [ `Commit` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) al final de la `try` bloque confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="ddd3f-155">El fragmento de código siguiente muestra este patrón.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="ddd3f-156">Vea [mantener la coherencia de base de datos con transacciones](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) para adicionales de la sintaxis y ejemplos de uso de transacciones con ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="ddd3f-157">De forma predeterminada, los TableAdapters en un conjunto de datos con tipo no utiliza transacciones.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="ddd3f-158">Para proporcionar compatibilidad con transacciones que es necesario para aumentar las clases TableAdapter para incluir métodos adicionales que usan el patrón anterior para realizar una serie de instrucciones de modificación de datos dentro del ámbito de una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="ddd3f-159">En el paso 2, veremos cómo usar las clases parciales para agregar estos métodos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="ddd3f-160">Paso 1: Crear el trabajo con páginas Web de datos por lotes</span><span class="sxs-lookup"><span data-stu-id="ddd3f-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="ddd3f-161">Antes de empezar a explorar cómo aumentar la capa DAL para admitir las transacciones de base de datos, permiten s primero Tómese un momento para crear las páginas web ASP.NET que necesitamos para este tutorial y los tres siguientes.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="ddd3f-162">Empiece por agregar una nueva carpeta denominada `BatchData` y, a continuación, agregue las siguientes páginas ASP.NET, asociar cada página con el `Site.master` página maestra.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Agregar las páginas ASP.NET para los tutoriales relacionados con SqlDataSource](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="ddd3f-164">**Figura 1**: agregar las páginas ASP.NET para los tutoriales relacionados con SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="ddd3f-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="ddd3f-165">Al igual que con las otras carpetas, `Default.aspx` utilizará el `SectionLevelTutorialListing.ascx` Control de usuario para mostrar los tutoriales dentro de su sección.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="ddd3f-166">Por lo tanto, agregue este Control de usuario para `Default.aspx` arrastrándolo desde el Explorador de soluciones en la página s la vista Diseño.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="ddd3f-167">[![Agregar el Control de usuario SectionLevelTutorialListing.ascx a Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="ddd3f-168">**Figura 2**: agregar la `SectionLevelTutorialListing.ascx` Control de usuario a `Default.aspx` ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>


<span data-ttu-id="ddd3f-169">Por último, agregue estos cuatro páginas como entradas para el `Web.sitemap` archivo.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="ddd3f-170">En concreto, agregue el siguiente marcado después de la personalización del mapa del sitio `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="ddd3f-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="ddd3f-171">Después de actualizar `Web.sitemap`, tómese un momento para ver el sitio Web de tutoriales a través de un explorador.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="ddd3f-172">El menú de la izquierda ahora incluye elementos para el trabajo con los tutoriales de datos por lotes.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![El mapa del sitio ahora incluye las entradas para el trabajo con los tutoriales de datos por lotes](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="ddd3f-174">**Figura 3**: el mapa del sitio ahora incluye las entradas para el trabajo con los tutoriales de datos por lotes</span><span class="sxs-lookup"><span data-stu-id="ddd3f-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="ddd3f-175">Paso 2: Actualizar la capa de acceso a datos para admitir las transacciones de base de datos</span><span class="sxs-lookup"><span data-stu-id="ddd3f-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="ddd3f-176">Como se explicó en el primer tutorial, [crear una capa de acceso a datos](../introduction/creating-a-data-access-layer-cs.md), el conjunto de datos con tipo en la capa DAL se compone de tablas de datos y TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="ddd3f-177">Las tablas de datos contienen datos, mientras que los TableAdapters proporcionan la funcionalidad necesaria para leer datos de la base de datos en las tablas de datos, para actualizar la base de datos con los cambios realizados en las tablas de datos y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="ddd3f-178">Recuerde que los TableAdapters proporcionan dos modelos para actualizar datos, que conocen como actualización por lotes y directo de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="ddd3f-179">Con el patrón de actualización por lotes, lo TableAdapter se pasa un conjunto de datos, un objeto DataTable o una colección de filas de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="ddd3f-180">Estos datos se enumera y para cada insertadas, modificar o eliminar la fila, el `InsertCommand`, `UpdateCommand`, o `DeleteCommand` se ejecuta.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="ddd3f-181">Con el patrón de DB-Direct, lo TableAdapter se pasa en su lugar, los valores de las columnas necesarias para insertar, actualizar o eliminar un único registro.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="ddd3f-182">El método de patrón directo de base de datos, a continuación, utiliza los valores pasados en para ejecutar adecuado `InsertCommand`, `UpdateCommand`, o `DeleteCommand` instrucción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="ddd3f-183">Sin tener en cuenta la utiliza el patrón de actualización, los métodos generados automáticamente de los TableAdapters no utilizan transacciones.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="ddd3f-184">De forma predeterminada cada insert, update o delete realizadas por el TableAdapter se trata como una única operación discreta.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="ddd3f-185">Por ejemplo, imagine que se usa el patrón de DB-Direct por parte del código en la capa BLL para insertar diez registros en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="ddd3f-186">Este código llamaría a TableAdapters `Insert` método diez veces.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="ddd3f-187">Si las cinco primeras inserciones correctamente, pero el sexto uno dio como resultado una excepción, se mantendría los cinco primeros registros insertados en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="ddd3f-188">De forma similar, si el patrón de actualización por lotes se utiliza para realizar inserciones, actualizaciones y eliminaciones a las filas insertadas, modificar y eliminar filas en un objeto DataTable, si el primer algunas modificaciones se realizó correctamente, pero una posterior encontró un error, las modificaciones anteriores que completado permanecerá en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="ddd3f-189">En determinados escenarios que queremos garantizar la atomicidad de una serie de modificaciones.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="ddd3f-190">Para lograr esto debemos manualmente extendemos TableAdapter mediante la adición de nuevos métodos que se ejecutan los `InsertCommand`, `UpdateCommand`, y `DeleteCommand` s bajo el paraguas de una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="ddd3f-191">En [crear una capa de acceso a datos](../introduction/creating-a-data-access-layer-cs.md) analizamos utilizando [clases parciales](http://en.wikipedia.org/wiki/Partial_type) para ampliar la funcionalidad de las tablas de datos en el conjunto de datos con tipo.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="ddd3f-192">Esta técnica también puede usarse con TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="ddd3f-193">El conjunto de datos con tipo `Northwind.xsd` se encuentra en la `App_Code` carpeta s `DAL` subcarpeta.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="ddd3f-194">Crear una subcarpeta de la `DAL` carpeta denominada `TransactionSupport` y agregue un nuevo archivo de clase denominado `ProductsTableAdapter.TransactionSupport.cs` (consulte la figura 4).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="ddd3f-195">Este archivo contendrá la implementación parcial de la `ProductsTableAdapter` que incluye métodos para realizar las modificaciones de datos utilizando una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Agregar una carpeta denominada TransactionSupport y un archivo de clase denominado ProductsTableAdapter.TransactionSupport.cs](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="ddd3f-197">**Figura 4**: agregar una carpeta denominada `TransactionSupport` y un archivo de clase denominado`ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="ddd3f-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>


<span data-ttu-id="ddd3f-198">Escriba el código siguiente en el `ProductsTableAdapter.TransactionSupport.cs` archivo:</span><span class="sxs-lookup"><span data-stu-id="ddd3f-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="ddd3f-199">El `partial` palabra clave en la declaración de clase aquí se indica al compilador que va a agregar a los miembros agregados el `ProductsTableAdapter` clase en el `NorthwindTableAdapters` espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="ddd3f-200">Tenga en cuenta el `using System.Data.SqlClient` instrucción en la parte superior del archivo.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="ddd3f-201">Dado que el TableAdapter se configuró para usar el proveedor SqlClient, internamente se usa un [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) objeto que se va a emitir sus comandos a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="ddd3f-202">Por lo tanto, es necesario utilizar la `SqlTransaction` clase para iniciar la transacción y, a continuación, para confirmarla o revertirla.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="ddd3f-203">Si está utilizando un almacén de datos que no sea de Microsoft SQL Server, debe utilizar el proveedor adecuado.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="ddd3f-204">Estos métodos ofrecen los bloques de creación necesarios para iniciar, reversión y confirmación una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="ddd3f-205">Se marcan `public`, les permite usar desde lo que el `ProductsTableAdapter`, de otra clase en la capa DAL, o desde otra capa de la arquitectura, como la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="ddd3f-206">`BeginTransaction`Abre el TableAdapter interno `SqlConnection` (si es necesario), comienza la transacción y lo asigna a la `Transaction` propiedad y asocia la transacción con interno `SqlDataAdapter` s `SqlCommand` objetos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="ddd3f-207">`CommitTransaction`y `RollbackTransaction` llamar a la `Transaction` objeto s `Commit` y `Rollback` métodos, respectivamente, antes de cerrar interno `Connection` objeto.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="ddd3f-208">Paso 3: Agregar métodos para actualizar y eliminar datos bajo el paraguas de una transacción</span><span class="sxs-lookup"><span data-stu-id="ddd3f-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="ddd3f-209">Con estos métodos completados, se re está listo para agregar métodos a `ProductsDataTable` o BLL que llevan a cabo una serie de comandos bajo el paraguas de una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="ddd3f-210">El siguiente método usa el patrón de actualización por lotes para actualizar un `ProductsDataTable` instancia mediante una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="ddd3f-211">Inicia una transacción mediante una llamada a la `BeginTransaction` método y, a continuación, utiliza un `try...catch` bloque para emitir las instrucciones de modificación de datos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="ddd3f-212">Si la llamada a la `Adapter` objeto s `Update` método produce una excepción, la ejecución se transferirá a la `catch` bloque donde la transacción se revertirá y la excepción que se vuelve a producir.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="ddd3f-213">Recuerde que el `Update` método implementa el patrón de actualización por lotes con una enumeración de las filas de proporcionado `ProductsDataTable` y realizar las necesarias `InsertCommand`, `UpdateCommand`, y `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="ddd3f-214">Si cualquiera de estos resultados de comandos en un error, la transacción se revierte, deshaciendo las modificaciones previas realizadas durante la duración de s de la transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="ddd3f-215">Debe el `Update` instrucción se completan sin error, la transacción se confirma en su totalidad.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="ddd3f-216">Agregar el `UpdateWithTransaction` método a la `ProductsTableAdapter` clase a través de la clase parcial en `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="ddd3f-217">Como alternativa, este método podría agregarse a la capa de lógica empresarial s `ProductsBLL` clase con unos pequeños cambios sintácticos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="ddd3f-218">Es decir, la palabra clave en `this.BeginTransaction()`, `this.CommitTransaction()`, y `this.RollbackTransaction()` tendría que ser reemplazados `Adapter` (Recuerde que `Adapter` es el nombre de una propiedad en `ProductsBLL` de tipo `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="ddd3f-219">El `UpdateWithTransaction` método usa el patrón de actualización por lotes, pero también se puede usar una serie de llamadas de DB-Direct dentro del ámbito de una transacción, como se muestra en el siguiente método.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="ddd3f-220">El `DeleteProductsWithTransaction` método acepta como entrada un `List<T>` de tipo `int`, ¿cuáles son los `ProductID` que se eliminan.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="ddd3f-221">El método inicia la transacción mediante una llamada a `BeginTransaction` y, a continuación, en la `try` bloquear, recorre en iteración la lista proporcionada al llamar al patrón de DB-Direct `Delete` método para cada `ProductID` valor.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="ddd3f-222">Si alguna de las llamadas a `Delete` se produce un error, el control se transfiere a la `catch` bloque donde se revierte la transacción y la excepción que se vuelve a producir.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="ddd3f-223">Si todas las llamadas a `Delete` se realiza correctamente, se confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="ddd3f-224">Agregue este método a la `ProductsBLL` clase.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="ddd3f-225">Aplicar las transacciones entre varios TableAdapters</span><span class="sxs-lookup"><span data-stu-id="ddd3f-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="ddd3f-226">Permite que el código relacionado con la transacción que se examinan en este tutorial para varias instrucciones en el `ProductsTableAdapter` se trate como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="ddd3f-227">Pero ¿qué ocurre si deben realizarse de forma atómica varias modificaciones a las tablas de base de datos diferente?</span><span class="sxs-lookup"><span data-stu-id="ddd3f-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="ddd3f-228">Por ejemplo, cuando se elimina una categoría, nos convenga primero para volver a asignar sus productos actuales a otra categoría.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="ddd3f-229">Estos dos pasos reasignar los productos y eliminar la categoría deben ejecutarse como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="ddd3f-230">Pero la `ProductsTableAdapter` incluye solo los métodos para modificar el `Products` tabla y la `CategoriesTableAdapter` incluye solo los métodos para modificar el `Categories` tabla.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="ddd3f-231">Entonces, ¿cómo puede incluir una transacción ambos TableAdapters?</span><span class="sxs-lookup"><span data-stu-id="ddd3f-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="ddd3f-232">Una opción consiste en Agregar un método a la `CategoriesTableAdapter` denominado `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` y ese método llame a un procedimiento almacenado que se reasigna los productos y elimina la categoría dentro del ámbito de una transacción definida dentro del procedimiento almacenado.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="ddd3f-233">Analizaremos cómo iniciar, confirmar y deshacer las transacciones en procedimientos almacenados en un tutorial posterior.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="ddd3f-234">Otra opción consiste en crear una clase auxiliar en la capa DAL que contiene el `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` método.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="ddd3f-235">Este método crearía una instancia de la `CategoriesTableAdapter` y `ProductsTableAdapter` y, a continuación, establezca estos dos TableAdapters `Connection` propiedades al mismo `SqlConnection` instancia.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="ddd3f-236">En ese punto, uno de los dos TableAdapters iniciaba la transacción con una llamada a `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="ddd3f-237">Los métodos de TableAdapter para reasignar los productos y eliminar la categoría se invocaría en un `try...catch` bloque con la transacción confirma o revierte hacia atrás, según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="ddd3f-238">Paso 4: Agregar el`UpdateWithTransaction`método a la capa de lógica de negocios</span><span class="sxs-lookup"><span data-stu-id="ddd3f-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="ddd3f-239">En el paso 3 agregamos una `UpdateWithTransaction` método a la `ProductsTableAdapter` en la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="ddd3f-240">Se debe agregar un método correspondiente a la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="ddd3f-241">Mientras que el nivel de presentación podría llamar directamente a la capa DAL para invocar la `UpdateWithTransaction` método, estos tutoriales han emprendido definir una arquitectura por niveles que aísla la capa DAL desde la capa de presentación.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="ddd3f-242">Por consiguiente, responsabilidad nos seguir este enfoque.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="ddd3f-243">Abra la `ProductsBLL` archivo de clase y agregue un método denominado `UpdateWithTransaction` que llama simplemente hasta el método correspondiente de la capa DAL.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="ddd3f-244">Ahora debería haber dos nuevos métodos de `ProductsBLL`: `UpdateWithTransaction`, que acaba de agregar, y `DeleteProductsWithTransaction`, que se agregó en el paso 3.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="ddd3f-245">Estos métodos no incluyen la `DataObjectMethodAttribute` atributo asignado a la mayoría de los otra métodos en el `ProductsBLL` clase porque se va a invocar estos métodos directamente desde las clases de código subyacente de páginas ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="ddd3f-246">Recuerde que `DataObjectMethodAttribute` se usa para marcar los métodos deben aparecer en las operaciones de asignación ObjectDataSource Configurar origen de datos asistente y en la pestaña (SELECT, UPDATE, INSERT o DELETE).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="ddd3f-247">Puesto que el control GridView no tiene ninguna compatibilidad integrada para lote editen o eliminen, tenemos invocar estos métodos mediante programación, en lugar de usar el enfoque sin código declarativo.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="ddd3f-248">Paso 5: Atómicamente actualizar bases de datos de la capa de presentación</span><span class="sxs-lookup"><span data-stu-id="ddd3f-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="ddd3f-249">Para ilustrar el efecto de la transacción al actualizar un lote de registros, s permiten crear una interfaz de usuario que muestra todos los productos en un GridView e incluye un botón Web controlar que, al hacer clic, los productos se reasignan `CategoryID` valores.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="ddd3f-250">En concreto, se centrará la reasignación de categoría para que los primeros productos varios se asignan válido `CategoryID` valor, mientras que otras son muy asigna un inexistente `CategoryID` valor.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="ddd3f-251">Si se intenta actualizar la base de datos con un producto cuyo `CategoryID` no coincide con una categoría existente s `CategoryID`, se producirá una infracción de restricción de clave externa y se producirá una excepción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="ddd3f-252">Lo veremos en este ejemplo es que, cuando utiliza una transacción de la excepción que se generan a partir de la infracción de restricción de clave externa provocará el anterior válida `CategoryID` cambios se revierta.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="ddd3f-253">Si no usa una transacción, sin embargo, las modificaciones a las categorías iniciales permanecerá.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="ddd3f-254">Comience abriendo la `Transactions.aspx` página en el `BatchData` carpeta y arrastre un control GridView en el cuadro de herramientas hasta el diseñador.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="ddd3f-255">Establecer su `ID` a `Products` y, en su etiqueta inteligente, enlazarla a un nuevo ObjectDataSource denominado `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="ddd3f-256">Configurar el ObjectDataSource para extraer los datos de la `ProductsBLL` clase s. `GetProducts` método.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="ddd3f-257">Esto eliminará ser un GridView de solo lectura, por lo que establece las listas de lista desplegable en la actualización, INSERCIÓN y las fichas (ninguno) y haga clic en Finalizar.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="ddd3f-258">[![Figura 5: Configurar el ObjectDataSource para utilizar el método de la clase ProductsBLL s GetProducts](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="ddd3f-259">**Figura 5**: figura 5: configurar el ObjectDataSource que se utilizan los `ProductsBLL` clase s `GetProducts` método ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>


<span data-ttu-id="ddd3f-260">[![Establece las listas de lista desplegable en la actualización, INSERCIÓN y eliminar las pestañas en (ninguno)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="ddd3f-261">**Figura 6**: establecer las listas de lista desplegable en la actualización, INSERCIÓN y eliminar pestañas en (ninguno) ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>


<span data-ttu-id="ddd3f-262">Después de completar al Asistente para configurar orígenes de datos, Visual Studio creará BoundFields y un CampoCasillaVerificación para los campos de datos de producto.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="ddd3f-263">Quitar todos estos campos excepto `ProductID`, `ProductName`, `CategoryID`, y `CategoryName` y cambiar el nombre de la `ProductName` y `CategoryName` BoundFields `HeaderText` propiedades para el producto y categoría, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="ddd3f-264">Desde la etiqueta inteligente, active la opción Habilitar paginación.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="ddd3f-265">Después de realizar estas modificaciones, el marcado declarativo de s GridView y ObjectDataSource debe ser similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="ddd3f-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="ddd3f-266">A continuación, agregue tres controles de botón Web situados encima de GridView.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="ddd3f-267">Establecer el primer botón s Text (propiedad) para actualizar la cuadrícula, la segunda s para modificar categorías (con la transacción) y la una tercera s para modificar categorías (sin transacción).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="ddd3f-268">En este momento la vista de diseño en Visual Studio debe ser similar a la pantalla se muestra en la figura 7.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="ddd3f-269">[![La página contiene una GridView y tres controles de botón Web](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="ddd3f-270">**Figura 7**: la página contiene una GridView y tres controles Button de Web ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>


<span data-ttu-id="ddd3f-271">Crear controladores de eventos para cada uno de los tres botón s `Click` eventos y utilice el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="ddd3f-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="ddd3f-272">La actualización de botón s `Click` controlador de eventos simplemente vuelve a enlazar los datos en GridView mediante una llamada a la `Products` GridView s `DataBind` método.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="ddd3f-273">El segundo controlador de eventos reasigna los productos `CategoryID` s y se utiliza el nuevo método de transacción de la capa BLL para realizar la base de datos actualiza bajo el paraguas de una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="ddd3f-274">Tenga en cuenta que cada producto s `CategoryID` arbitrariamente se establece en el mismo valor que su `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="ddd3f-275">Esto funcionará sin problemas para el primer algunos productos, ya que dichos productos tienen `ProductID` valores que se producen asignar a válido `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="ddd3f-276">Una vez, pero la `ProductID` inicio s haga demasiado grande, esta superposición una coincidencia de `ProductID` s y `CategoryID` s ya no es aplicable.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="ddd3f-277">La tercera `Click` controlador de eventos actualiza los productos `CategoryID` s de la misma manera, pero envía la actualización a la base de datos mediante la `ProductsTableAdapter` predeterminado s. `Update` método.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="ddd3f-278">Esto  `Update` /método siguiente no se ajusta a la serie de comandos dentro de una transacción, por lo que estos cambios se realizan antes el primer error de infracción de restricción de clave externa se encontró se conservarán.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="ddd3f-279">Para mostrar este comportamiento, visite esta página a través de un explorador.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="ddd3f-280">Inicialmente debería ver la primera página de datos tal como se muestra en la figura 8.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="ddd3f-281">A continuación, haga clic en el botón Modificar categorías (con la transacción).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="ddd3f-282">Esto provocará una devolución de datos y al intentar actualizar todos los productos `CategoryID` valores, pero se producirá una infracción de restricción de clave externa (consulte la figura 9).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="ddd3f-283">[![Los productos se muestran en un control GridView paginable](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="ddd3f-284">**Figura 8**: los productos se muestran en un control GridView paginable ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>


<span data-ttu-id="ddd3f-285">[![Reasignar los resultados de categorías en una infracción de restricción de clave externa](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="ddd3f-286">**Figura 9**: reasignar los resultados de categorías en una infracción de restricción de clave externa ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>


<span data-ttu-id="ddd3f-287">A continuación, pulse el botón Atrás del explorador s y, a continuación, haga clic en el botón Actualizar la cuadrícula.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="ddd3f-288">Tras la actualización de los datos debería ver el mismo resultado exacto tal como se muestra en la figura 8.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="ddd3f-289">Es decir, incluso aunque algunos de los productos `CategoryID` s se valores cambiados para legal y se actualiza en la base de datos, se revierten cuando se produjo la infracción de restricción de clave externa.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="ddd3f-290">Ahora, intente hacer clic en el botón Modificar categorías (sin transacción).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="ddd3f-291">El resultado será el mismo error de infracción de restricción de clave externa (consulte la figura 9), pero esta vez los productos cuyo `CategoryID` cambiaron los valores para legal de un valor no se revertirá.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="ddd3f-292">Presione el botón Atrás del explorador s y, a continuación, en el botón de actualización de cuadrícula.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="ddd3f-293">Como se muestra en la figura 10, la `CategoryID` ha se ha reasignado s de los ocho primeros productos.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="ddd3f-294">Por ejemplo, en la figura 8, cambios tenían un `CategoryID` de 1, pero en la figura 10 TI s se ha reasignado a 2.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="ddd3f-295">[![Algunos valores de Id. de categoría de productos actualizado mientras otros usuarios se han no estaban](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="ddd3f-296">**Figura 10**: algunos productos `CategoryID` valores actualizan mientras otros usuarios se han no estaban ([haga clic aquí para ver la imagen a tamaño completo](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="ddd3f-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="ddd3f-297">Resumen</span><span class="sxs-lookup"><span data-stu-id="ddd3f-297">Summary</span></span>

<span data-ttu-id="ddd3f-298">De forma predeterminada, los métodos de TableAdapter s no incluya las instrucciones ejecutadas de la base de datos dentro del ámbito de una transacción, pero con un poco de trabajo podemos agregar métodos que va a crear, commit y rollback una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="ddd3f-299">En este tutorial, creamos tres tales métodos en la `ProductsTableAdapter` clase: `BeginTransaction`, `CommitTransaction`, y `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="ddd3f-300">Hemos visto cómo usar estos métodos junto con un `try...catch` bloque para realizar una serie de instrucciones de modificación de datos atómica.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="ddd3f-301">En concreto, creamos la `UpdateWithTransaction` método en el `ProductsTableAdapter`, que usa el patrón de actualización por lotes para realizar las modificaciones necesarias en las filas de un proporcionado `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="ddd3f-302">También hemos agregado la `DeleteProductsWithTransaction` método a la `ProductsBLL` clase en el BLL, que acepta un `List` de `ProductID` valores como entrada y llama al método de patrón de DB-Direct `Delete` para cada `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="ddd3f-303">Ambos métodos empiece por crear una transacción y, a continuación, ejecutar las instrucciones de modificación de datos dentro de un `try...catch` bloque.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="ddd3f-304">Si se produce una excepción, se revierte la transacción, en caso contrario, se confirma.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="ddd3f-305">Paso 5 muestra el efecto de las actualizaciones de lote transaccional frente a las actualizaciones por lotes que dejó de usar una transacción.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="ddd3f-306">En los siguientes tres tutoriales se se se basan en la base que se disponen en este tutorial y crear interfaces de usuario para realizar inserciones, eliminaciones y actualizaciones por lotes.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="ddd3f-307">Feliz programación.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="ddd3f-308">Información adicional</span><span class="sxs-lookup"><span data-stu-id="ddd3f-308">Further Reading</span></span>

<span data-ttu-id="ddd3f-309">Para obtener más información sobre los temas tratados en este tutorial, consulte los siguientes recursos:</span><span class="sxs-lookup"><span data-stu-id="ddd3f-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="ddd3f-310">Mantiene la coherencia de la base de datos con transacciones</span><span class="sxs-lookup"><span data-stu-id="ddd3f-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="ddd3f-311">Procedimientos almacenados de administración de transacciones en SQL Server</span><span class="sxs-lookup"><span data-stu-id="ddd3f-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="ddd3f-312">Transacciones realizadas fácil:`System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="ddd3f-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="ddd3f-313">TransactionScope y DataAdapters</span><span class="sxs-lookup"><span data-stu-id="ddd3f-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="ddd3f-314">Usar transacciones de bases de datos de Oracle en .NET</span><span class="sxs-lookup"><span data-stu-id="ddd3f-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="ddd3f-315">Acerca del autor</span><span class="sxs-lookup"><span data-stu-id="ddd3f-315">About the Author</span></span>

<span data-ttu-id="ddd3f-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de siete libros sobre ASP/ASP.NET y fundador de [4GuysFromRolla.com](http://www.4guysfromrolla.com), ha trabajado con las tecnologías Web de Microsoft desde 1998.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="ddd3f-317">Scott funciona como un consultor independiente, instructor y escritor.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="ddd3f-318">Su último libro es [*SAM enseñar a usted mismo ASP.NET 2.0 en 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="ddd3f-319">Puede ponerse en [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) o a través de su blog, que se pueden encontrar en [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="ddd3f-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="ddd3f-320">Agradecimientos especiales a</span><span class="sxs-lookup"><span data-stu-id="ddd3f-320">Special Thanks To</span></span>

<span data-ttu-id="ddd3f-321">Esta serie de tutoriales se revisó por varios revisores útiles.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="ddd3f-322">Los revisores iniciales para este tutorial eran Dave Gardner, Hilton Giesenow y Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="ddd3f-322">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="ddd3f-323">¿Está interesado en revisar mi próximos artículos MSDN?</span><span class="sxs-lookup"><span data-stu-id="ddd3f-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="ddd3f-324">Si es así, me quitar una línea en [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="ddd3f-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
[<span data-ttu-id="ddd3f-325">Siguiente</span><span class="sxs-lookup"><span data-stu-id="ddd3f-325">Next</span></span>](batch-updating-cs.md)
