---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Con Entity Framework 4.0 y el Control ObjectDataSource, parte 2: agregar una capa de lógica de negocios y pruebas unitarias | Documentos de Microsoft'
author: tdykstra
description: Esta serie de tutoriales se basa en la aplicación web de la Universidad de Contoso que se crea mediante la introducción a la serie de tutoriales de Entity Framework 4.0. I...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: ecdfb2bdc546f55778ec4cc1f61aa66e129134ea
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/06/2018
ms.locfileid: "30888320"
---
<a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="e7028-104">Con Entity Framework 4.0 y el Control ObjectDataSource, parte 2: agregar una capa de lógica de negocios y pruebas unitarias</span><span class="sxs-lookup"><span data-stu-id="e7028-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>
====================
<span data-ttu-id="e7028-105">por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="e7028-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="e7028-106">Esta serie de tutoriales que se basa en la aplicación web de la Universidad de Contoso que se crea mediante la [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) serie de tutoriales.</span><span class="sxs-lookup"><span data-stu-id="e7028-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="e7028-107">Si no has completado los tutoriales anteriores, como punto de partida para este tutorial puede [descargar la aplicación](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que puede haberla creado.</span><span class="sxs-lookup"><span data-stu-id="e7028-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="e7028-108">También puede [descargar la aplicación](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) creado por la serie de tutoriales completa.</span><span class="sxs-lookup"><span data-stu-id="e7028-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="e7028-109">Si tiene alguna pregunta acerca de los tutoriales, puede publicar para la [foro de ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="e7028-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="e7028-110">En el tutorial anterior creó una aplicación web de n niveles con Entity Framework y el `ObjectDataSource` control.</span><span class="sxs-lookup"><span data-stu-id="e7028-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="e7028-111">Este tutorial muestra cómo agregar lógica de negocios durante la separación de la capa de lógica empresarial (BLL) y la capa de acceso a datos (DAL) y muestra cómo crear pruebas unitarias automatizadas para la capa BLL.</span><span class="sxs-lookup"><span data-stu-id="e7028-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="e7028-112">En este tutorial, se realizarán las siguientes tareas:</span><span class="sxs-lookup"><span data-stu-id="e7028-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="e7028-113">Crear una interfaz de repositorio que declara los métodos de acceso a datos que necesita.</span><span class="sxs-lookup"><span data-stu-id="e7028-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="e7028-114">Implemente la interfaz de repositorio en la clase de repositorio.</span><span class="sxs-lookup"><span data-stu-id="e7028-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="e7028-115">Cree una clase de lógica de negocios que llama a la clase de repositorio para llevar a cabo funciones de acceso a datos.</span><span class="sxs-lookup"><span data-stu-id="e7028-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="e7028-116">Conectar el `ObjectDataSource` control a la clase de la lógica de negocios en lugar de a la clase de repositorio.</span><span class="sxs-lookup"><span data-stu-id="e7028-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="e7028-117">Crear un proyecto de prueba unitaria y una clase de repositorio que usa colecciones en memoria para su almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="e7028-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="e7028-118">Crear una prueba unitaria para la lógica de negocios que desea agregar a la clase de la lógica de negocios, a continuación, ejecutar la prueba y ve un error.</span><span class="sxs-lookup"><span data-stu-id="e7028-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="e7028-119">Implementar la lógica de negocios de la clase de la lógica de negocios, a continuación, vuelva a ejecutar la unidad de prueba y véalo a pasar.</span><span class="sxs-lookup"><span data-stu-id="e7028-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="e7028-120">Trabajará con la *Departments.aspx* y *DepartmentsAdd.aspx* páginas que creó en el tutorial anterior.</span><span class="sxs-lookup"><span data-stu-id="e7028-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="e7028-121">Crear una interfaz de repositorio</span><span class="sxs-lookup"><span data-stu-id="e7028-121">Creating a Repository Interface</span></span>

<span data-ttu-id="e7028-122">Comenzará mediante la creación de la interfaz del repositorio.</span><span class="sxs-lookup"><span data-stu-id="e7028-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="e7028-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="e7028-124">En el *DAL* carpeta, cree un nuevo archivo de clase, asígnele el nombre *ISchoolRepository.cs*y reemplace el código existente por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="e7028-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="e7028-125">La interfaz define un método para cada uno de lo CRUD (crear, leer, actualizar y eliminar) métodos que creó en la clase de repositorio.</span><span class="sxs-lookup"><span data-stu-id="e7028-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="e7028-126">En el `SchoolRepository` clase *SchoolRepository.cs*, indicar que esta clase implementa la `ISchoolRepository` interfaz:</span><span class="sxs-lookup"><span data-stu-id="e7028-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="e7028-127">Crear una clase de lógica de negocios</span><span class="sxs-lookup"><span data-stu-id="e7028-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="e7028-128">A continuación, creará la clase de la lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="e7028-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="e7028-129">Hacer esto para que pueda agregar lógica de negocios que se ejecutará por el `ObjectDataSource` controlar, aunque no lo hará que todavía.</span><span class="sxs-lookup"><span data-stu-id="e7028-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="e7028-130">Por ahora, la nueva clase de lógica de negocios sólo realizará las mismas operaciones CRUD que realiza el repositorio.</span><span class="sxs-lookup"><span data-stu-id="e7028-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="e7028-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="e7028-132">Cree una nueva carpeta y asígnele el nombre *BLL*.</span><span class="sxs-lookup"><span data-stu-id="e7028-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="e7028-133">(En una aplicación del mundo real, la capa de lógica de negocios normalmente se implementa como una biblioteca de clases: un proyecto independiente, pero para que este tutorial resulte sencillo, clases BLL se mantendrán en una carpeta de proyecto.)</span><span class="sxs-lookup"><span data-stu-id="e7028-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="e7028-134">En el *BLL* carpeta, cree un nuevo archivo de clase, asígnele el nombre *SchoolBL.cs*y reemplace el código existente por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="e7028-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="e7028-135">Este código crea los mismos métodos CRUD que vio anteriormente en la clase de repositorio, pero en lugar de tener acceso directamente a los métodos de Entity Framework, llama el repositorio de métodos de clase.</span><span class="sxs-lookup"><span data-stu-id="e7028-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="e7028-136">La variable de clase que contiene una referencia a la clase de repositorio se define como un tipo de interfaz y el código que crea una instancia de la clase del repositorio se encuentra en dos constructores.</span><span class="sxs-lookup"><span data-stu-id="e7028-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="e7028-137">El constructor sin parámetros que se utilizarán en el `ObjectDataSource` control.</span><span class="sxs-lookup"><span data-stu-id="e7028-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="e7028-138">Crea una instancia de la `SchoolRepository` clase que creó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="e7028-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="e7028-139">El otro constructor permite que cualquier código que crea una instancia de la clase de lógica de negocios para pasar cualquier objeto que implementa la interfaz del repositorio.</span><span class="sxs-lookup"><span data-stu-id="e7028-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="e7028-140">Los métodos CRUD que llaman a la clase de repositorio y los dos constructores permiten usar la clase de la lógica de negocios con cualquier almacén de datos back-end que elija.</span><span class="sxs-lookup"><span data-stu-id="e7028-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="e7028-141">La clase de la lógica de negocios no debe ser consciente de cómo la clase que realiza la llamada conserva los datos.</span><span class="sxs-lookup"><span data-stu-id="e7028-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="e7028-142">(Esto se suele denominar *omisión de persistencia*.) Esto facilita la pruebas unitarias, porque la clase de la lógica de negocios se pueden conectar a una implementación de repositorio que usa algo como simple como en memoria `List` colecciones para almacenar datos.</span><span class="sxs-lookup"><span data-stu-id="e7028-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="e7028-143">Técnicamente, los objetos de entidad son todavía no que ignoran la persistencia, porque se crea una instancia de las clases que heredan de Entity Framework `EntityObject` clase.</span><span class="sxs-lookup"><span data-stu-id="e7028-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="e7028-144">Omisión de persistencia completa, puede usar *objetos CLR antiguos sin formato*, o *POCOs*, en lugar de objetos que se heredan de la `EntityObject` clase.</span><span class="sxs-lookup"><span data-stu-id="e7028-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="e7028-145">Uso de POCOs queda fuera del ámbito de este tutorial.</span><span class="sxs-lookup"><span data-stu-id="e7028-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="e7028-146">Para obtener más información, consulte [capacidad de prueba y Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) en el sitio Web MSDN.)</span><span class="sxs-lookup"><span data-stu-id="e7028-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>


<span data-ttu-id="e7028-147">Ahora puede conectar el `ObjectDataSource` controles a la lógica de negocios en lugar de la clase en el repositorio y comprobar que todo funciona igual que antes.</span><span class="sxs-lookup"><span data-stu-id="e7028-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="e7028-148">En *Departments.aspx* y *DepartmentsAdd.aspx*, cambiar cada aparición de `TypeName="ContosoUniversity.DAL.SchoolRepository"` a `TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="e7028-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="e7028-149">(Hay cuatro instancias en total).</span><span class="sxs-lookup"><span data-stu-id="e7028-149">(There are four instances in all.)</span></span>

<span data-ttu-id="e7028-150">Ejecute el *Departments.aspx* y *DepartmentsAdd.aspx* páginas para comprobar que seguirán funcionando como lo hacían antes.</span><span class="sxs-lookup"><span data-stu-id="e7028-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="e7028-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="e7028-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="e7028-153">Crear un proyecto de prueba unitaria y la implementación de repositorio</span><span class="sxs-lookup"><span data-stu-id="e7028-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="e7028-154">Agregar un nuevo proyecto a la solución mediante la **proyecto de prueba** plantilla y asígnele el nombre `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="e7028-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="e7028-155">En el proyecto de prueba, agregue una referencia a `System.Data.Entity` y agregue una referencia al proyecto el `ContosoUniversity` proyecto.</span><span class="sxs-lookup"><span data-stu-id="e7028-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="e7028-156">Ahora puede crear la clase de repositorio que va a utilizar con pruebas unitarias.</span><span class="sxs-lookup"><span data-stu-id="e7028-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="e7028-157">El almacén de datos para este repositorio será dentro de la clase.</span><span class="sxs-lookup"><span data-stu-id="e7028-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="e7028-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="e7028-159">En el proyecto de prueba, cree un nuevo archivo de clase, asígnele el nombre *MockSchoolRepository.cs*y reemplace el código existente por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="e7028-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="e7028-160">Esta clase de repositorio tiene los mismos métodos CRUD como uno que tiene acceso directo a Entity Framework, pero funcionan con `List` las colecciones en memoria en lugar de con una base de datos.</span><span class="sxs-lookup"><span data-stu-id="e7028-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="e7028-161">Esto facilita a una clase de prueba configurar y validar pruebas unitarias para la clase de la lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="e7028-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="e7028-162">Crear pruebas unitarias</span><span class="sxs-lookup"><span data-stu-id="e7028-162">Creating Unit Tests</span></span>

<span data-ttu-id="e7028-163">El **probar** plantilla de proyecto crea una clase de prueba de unidad de código auxiliar, y la siguiente tarea consiste en modificar esta clase agregando métodos de prueba unitaria a él de lógica de negocios que desea agregar a la clase de la lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="e7028-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="e7028-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="e7028-165">En la Universidad de Contoso, cualquier instructor individual solo puede ser el Administrador de un departamento único y debe agregar lógica de negocios para aplicar esta regla.</span><span class="sxs-lookup"><span data-stu-id="e7028-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="e7028-166">Para empezar, agregar pruebas y ejecutar las pruebas para verlos producirá un error.</span><span class="sxs-lookup"><span data-stu-id="e7028-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="e7028-167">A continuación, podrá agregar el código y vuelva a ejecutar las pruebas, se espera verlos a pasar.</span><span class="sxs-lookup"><span data-stu-id="e7028-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="e7028-168">Abra la *UnitTest1.cs* de archivos y agregar `using` instrucciones para las capas de lógica y acceso a datos empresariales que creó en el proyecto ContosoUniversity:</span><span class="sxs-lookup"><span data-stu-id="e7028-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="e7028-169">Reemplace el `TestMethod1` método con los métodos siguientes:</span><span class="sxs-lookup"><span data-stu-id="e7028-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="e7028-170">El `CreateSchoolBL` método crea una instancia de la clase de repositorio que ha creado para la prueba unitaria de proyecto, que, a continuación, pasa a una nueva instancia de la clase de la lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="e7028-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="e7028-171">El método, a continuación, utiliza la clase de la lógica de negocios para insertar tres departamentos que puede usar en métodos de prueba.</span><span class="sxs-lookup"><span data-stu-id="e7028-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="e7028-172">Los métodos de prueba para comprobar que la clase de la lógica de negocios produce una excepción si alguien intenta insertar un nuevo departamento con el mismo administrador de un departamento existente, o si alguien intenta actualizar el administrador del departamento si se establece en el identificador de una persona ya que es el Administrador de otro departamento.</span><span class="sxs-lookup"><span data-stu-id="e7028-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="e7028-173">No ha creado la clase de excepción, por lo que este código no se compilará.</span><span class="sxs-lookup"><span data-stu-id="e7028-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="e7028-174">Para obtener compilarla, haga clic en `DuplicateAdministratorException` y seleccione **generar**y, a continuación, **clase**.</span><span class="sxs-lookup"><span data-stu-id="e7028-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="e7028-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="e7028-176">Esto crea una clase en el proyecto de prueba que se puede eliminar después de crear la clase de excepción en el proyecto principal.</span><span class="sxs-lookup"><span data-stu-id="e7028-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="e7028-177">e implementa la lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="e7028-177">and implemented the business logic.</span></span>

<span data-ttu-id="e7028-178">Ejecute el proyecto de prueba.</span><span class="sxs-lookup"><span data-stu-id="e7028-178">Run the test project.</span></span> <span data-ttu-id="e7028-179">Como se esperaba, producirá un error en las pruebas.</span><span class="sxs-lookup"><span data-stu-id="e7028-179">As expected, the tests fail.</span></span>

<span data-ttu-id="e7028-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="e7028-181">Agregar lógica de negocios para realizar un paso de prueba</span><span class="sxs-lookup"><span data-stu-id="e7028-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="e7028-182">A continuación, podrá implementar la lógica de negocios que hace imposible que se establecerá como el Administrador de un departamento de alguien que ya es administrador de otro departamento.</span><span class="sxs-lookup"><span data-stu-id="e7028-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="e7028-183">Que produce una excepción de la capa de lógica de negocios y, a continuación, detectar en la capa de presentación si un usuario edita un departamento y haga clic en **actualización** después de seleccionar un usuario que ya es un administrador.</span><span class="sxs-lookup"><span data-stu-id="e7028-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="e7028-184">(También puede quitar instructores en la lista desplegable que ya son administradores antes de presentar la página, pero el propósito aquí es para que funcione con la capa de lógica de negocios).</span><span class="sxs-lookup"><span data-stu-id="e7028-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="e7028-185">Empiece por crear la clase de excepción que podrá producir cuando un usuario intenta establecer a un instructor el Administrador de más de un departamento.</span><span class="sxs-lookup"><span data-stu-id="e7028-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="e7028-186">En el proyecto principal, cree un nuevo archivo de clase en el *BLL* carpeta, asígnele el nombre *DuplicateAdministratorException.cs*y reemplace el código existente por el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="e7028-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="e7028-187">Ahora, elimine la contraseña *DuplicateAdministratorException.cs* archivo que crearon en el proyecto de prueba para poder compilar.</span><span class="sxs-lookup"><span data-stu-id="e7028-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="e7028-188">En el proyecto principal, abra el *SchoolBL.cs* de archivos y agregue el siguiente método que contiene la lógica de validación.</span><span class="sxs-lookup"><span data-stu-id="e7028-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="e7028-189">(El código hace referencia a un método que creará más adelante).</span><span class="sxs-lookup"><span data-stu-id="e7028-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="e7028-190">Llamaremos a este método cuando se insertan o actualizan `Department` entidades con el fin de comprobar si otro departamento ya tiene el mismo administrador.</span><span class="sxs-lookup"><span data-stu-id="e7028-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="e7028-191">El código llama a un método para buscar la base de datos para un `Department` entidad que tiene el mismo `Administrator` valor de la propiedad como la entidad que se va a insertar o actualizar.</span><span class="sxs-lookup"><span data-stu-id="e7028-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="e7028-192">Si encuentra alguno, el código produce una excepción.</span><span class="sxs-lookup"><span data-stu-id="e7028-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="e7028-193">Ninguna comprobación de validación es necesaria si la entidad que se va a insertar o actualizar no tiene ningún `Administrator` valor y ninguna excepción se produce si se llama al método durante una actualización y el `Department` entidad encuentra coincidencias el `Department` entidad que se está actualizando.</span><span class="sxs-lookup"><span data-stu-id="e7028-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="e7028-194">Llame al método nuevo desde la `Insert` y `Update` métodos:</span><span class="sxs-lookup"><span data-stu-id="e7028-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="e7028-195">En *ISchoolRepository.cs*, agregue la siguiente declaración para el nuevo método de acceso a datos:</span><span class="sxs-lookup"><span data-stu-id="e7028-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="e7028-196">En *SchoolRepository.cs*, agregue las siguientes `using` instrucción:</span><span class="sxs-lookup"><span data-stu-id="e7028-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="e7028-197">En *SchoolRepository.cs*, agregar el nuevo método de acceso a datos siguientes:</span><span class="sxs-lookup"><span data-stu-id="e7028-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="e7028-198">Este código recupera `Department` entidades que tienen un administrador especificado.</span><span class="sxs-lookup"><span data-stu-id="e7028-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="e7028-199">Solo un departamento debe encontrarse (si existe).</span><span class="sxs-lookup"><span data-stu-id="e7028-199">Only one department should be found (if any).</span></span> <span data-ttu-id="e7028-200">Sin embargo, dado que ninguna restricción se basa en la base de datos, el tipo de valor devuelto es una colección en caso de que se encuentran varios departamentos.</span><span class="sxs-lookup"><span data-stu-id="e7028-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="e7028-201">De forma predeterminada, cuando el contexto del objeto recupera las entidades de la base de datos, realiza un seguimiento de ellos en su administrador de estado de objeto.</span><span class="sxs-lookup"><span data-stu-id="e7028-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="e7028-202">El `MergeOption.NoTracking` parámetro especifica que este seguimiento no se hará para esta consulta.</span><span class="sxs-lookup"><span data-stu-id="e7028-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="e7028-203">Esto es necesario porque la consulta podría devolver la entidad exacta que está intentando actualizar y, a continuación, no podrá asociar esa entidad.</span><span class="sxs-lookup"><span data-stu-id="e7028-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="e7028-204">Por ejemplo, si edita el departamento de historial de la *Departments.aspx* página y el administrador no modifiquen, esta consulta devolverá el departamento de historial.</span><span class="sxs-lookup"><span data-stu-id="e7028-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="e7028-205">Si `NoTracking` no está establecido, el contexto del objeto ya tendrá la entidad department de historial en el Administrador de estado de su objeto.</span><span class="sxs-lookup"><span data-stu-id="e7028-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="e7028-206">A continuación, cuando se adjunta la entidad del departamento de historial que se vuelve a crear del estado de vista, el contexto del objeto producirá una excepción que indicara `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="e7028-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="e7028-207">(Como alternativa a especificar `MergeOption.NoTracking`, puede crear un nuevo contexto de objeto solo para esta consulta.</span><span class="sxs-lookup"><span data-stu-id="e7028-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="e7028-208">Dado que el contexto del objeto nuevo tendría su propio administrador de estado de objeto, no habría ningún conflicto cuando se llama a la `Attach` método.</span><span class="sxs-lookup"><span data-stu-id="e7028-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="e7028-209">El contexto del objeto nuevo compartirían la conexión de base de datos y metadatos con el contexto del objeto original, por lo que la reducción del rendimiento de este enfoque alternativo sería mínima.</span><span class="sxs-lookup"><span data-stu-id="e7028-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="e7028-210">Sin embargo, presenta el enfoque mostrado en este caso, el `NoTracking` opción, que puede encontrar útiles en otros contextos.</span><span class="sxs-lookup"><span data-stu-id="e7028-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="e7028-211">El `NoTracking` opción se describe más adelante en un tutorial posterior de esta serie.)</span><span class="sxs-lookup"><span data-stu-id="e7028-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="e7028-212">En el proyecto de prueba, agregue el nuevo método de acceso a datos a *MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="e7028-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="e7028-213">Este código usa LINQ para efectuar la misma selección de datos que el `ContosoUniversity` repositorio del proyecto usa LINQ to Entities para.</span><span class="sxs-lookup"><span data-stu-id="e7028-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="e7028-214">Vuelva a ejecutar el proyecto de prueba.</span><span class="sxs-lookup"><span data-stu-id="e7028-214">Run the test project again.</span></span> <span data-ttu-id="e7028-215">Esta vez las pruebas son correctas.</span><span class="sxs-lookup"><span data-stu-id="e7028-215">This time the tests pass.</span></span>

<span data-ttu-id="e7028-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="e7028-217">Control de excepciones de ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="e7028-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="e7028-218">En el `ContosoUniversity` project, lleve a cabo la *Departments.aspx* página e intenta cambiar el Administrador de un departamento a alguien que ya es administrador de otro departamento.</span><span class="sxs-lookup"><span data-stu-id="e7028-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="e7028-219">(Recuerde que solo se pueden editar los departamentos que agregó durante este tutorial, dado que la base de datos viene cargado previamente con datos no válidos). Obtener la siguiente página de error de servidor:</span><span class="sxs-lookup"><span data-stu-id="e7028-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="e7028-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="e7028-221">No desea que los usuarios vean este tipo de página de error, por lo que necesita agregar código de control de errores.</span><span class="sxs-lookup"><span data-stu-id="e7028-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="e7028-222">Abra *Departments.aspx* y especificar un controlador para el `OnUpdated` eventos de la `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e7028-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="e7028-223">La `ObjectDataSource` etiqueta de apertura ahora similar al siguiente ejemplo.</span><span class="sxs-lookup"><span data-stu-id="e7028-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="e7028-224">En *Departments.aspx.cs*, agregue las siguientes `using` instrucción:</span><span class="sxs-lookup"><span data-stu-id="e7028-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="e7028-225">Agregue el siguiente controlador para el `Updated` eventos:</span><span class="sxs-lookup"><span data-stu-id="e7028-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="e7028-226">Si el `ObjectDataSource` control detecta una excepción al intentar realizar la actualización, la excepción se pasa en el argumento de evento (`e`) para este controlador.</span><span class="sxs-lookup"><span data-stu-id="e7028-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="e7028-227">El código en el controlador se comprueba para ver si la excepción es la excepción de administrador duplicado.</span><span class="sxs-lookup"><span data-stu-id="e7028-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="e7028-228">Si es así, el código crea un control de validación que contiene un mensaje de error para el `ValidationSummary` control para mostrar.</span><span class="sxs-lookup"><span data-stu-id="e7028-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="e7028-229">Ejecute la página e intentará convertir a alguien en el Administrador de los dos departamentos de nuevo.</span><span class="sxs-lookup"><span data-stu-id="e7028-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="e7028-230">Esta vez el `ValidationSummary` control muestra un mensaje de error.</span><span class="sxs-lookup"><span data-stu-id="e7028-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="e7028-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="e7028-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="e7028-232">Realizar modificaciones similares a la *DepartmentsAdd.aspx* página.</span><span class="sxs-lookup"><span data-stu-id="e7028-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="e7028-233">En *DepartmentsAdd.aspx*, especificar un controlador para el `OnInserted` eventos de la `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e7028-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="e7028-234">El marcado resultante tendrá un aspecto similar en el siguiente ejemplo.</span><span class="sxs-lookup"><span data-stu-id="e7028-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="e7028-235">En *DepartmentsAdd.aspx.cs*, agregar la misma `using` instrucción:</span><span class="sxs-lookup"><span data-stu-id="e7028-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="e7028-236">Agregue el siguiente controlador de eventos:</span><span class="sxs-lookup"><span data-stu-id="e7028-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="e7028-237">Ahora puede probar el *DepartmentsAdd.aspx.cs* página para comprobar que también correctamente controla intentos que realizará el Administrador de más de un departamento de una persona.</span><span class="sxs-lookup"><span data-stu-id="e7028-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="e7028-238">Con esto finaliza la introducción a implementar el patrón de repositorio para utilizar el `ObjectDataSource` control con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="e7028-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="e7028-239">Para obtener más información sobre el modelo de repositorio y la capacidad de prueba, vea las notas del producto MSDN [capacidad de prueba y Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="e7028-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="e7028-240">En el tutorial siguiente verá cómo agregar ordenación y filtrado funcionalidad a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="e7028-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="e7028-241">[Anterior](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [Siguiente](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="e7028-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
